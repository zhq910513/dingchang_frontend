import{c as A,r as v,q as Te,x as D,z as u,P as l,G as k,J as se,H as a,ay as _,I as Ke,aI as qe,y as m,C as Ge,L as i,u as X,M as R,ap as K,O as Y,ac as Pe,D as Z}from"./vendor-vue-fFWwKrgY.js";import{E as y,h as Oe,v as je,w as He}from"./vendor-element-plus-CtVxZ4Oy.js";import{l as Je,u as Qe,c as We,d as Xe}from"./customerChannel-0OTur5MX.js";import{_ as Ye,u as Ze,R as q}from"./index-6ncFfAxE.js";import"./vendor-lodash-rvV0CIkQ.js";import"./vendor-DWCz07M-.js";import"./vendor-dates-DVKSwKij.js";import"./http-CBIyYC5i.js";import"./vendor-axios-C0Zqfgkc.js";import"./vendor-vue-router-CVyACjsp.js";import"./vendor-pinia-CMXa-Za0.js";const et={class:"page"},tt={class:"page-header"},lt={class:"header-actions"},at={class:"toolbar-row"},ot={class:"toolbar-content"},nt={class:"toolbar-fields"},st={class:"toolbar-actions"},rt={class:"table-scroll"},ut={class:"code-cell"},it={class:"code-text"},dt={class:"pagination-bar"},ct={class:"contacts-wrap"},mt={class:"contacts-toolbar"},pt={key:0,class:"contacts-empty"},vt={key:1,class:"contacts-list"},ft={class:"dialog-footer"},_t={class:"cd"},gt={class:"cd-icon-wrap"},yt={class:"cd-body"},bt={class:"cd-title"},kt={class:"cd-code"},Ct={class:"cd-footer"},wt={__name:"CustomerList",setup(Vt){const re=Ze(),M=A(()=>String(re.roleName||"").trim().toLowerCase()),$=A(()=>M.value!==q.FINANCE),H=A(()=>M.value===q.SUPER_ADMIN||M.value===q.MANAGER||M.value===q.MARKET),J=A(()=>M.value===q.SUPER_ADMIN),V=v(!1),g=v(!1),C=v(1),Q=v(20),ee=v(0),te=v([]);let G=0;const p=v({customer_code:"",customer_name:"",market:"",region:"",created_by:""});function le(t){return!!t?.is_deleted||!!t?.deleted_at}function ue(t){const e=String(t||"").trim().toLowerCase();return e==="mobile"?"手机号":e==="tel"?"座机":e||""}function ie(t){return!Array.isArray(t)||!t.length?"":t.map(e=>{if(!e)return"";const r=ue(e.type),n=e.value?String(e.value):"";return r?`${r}:${n}`:n}).filter(Boolean).join("；")}function E(t){const e=String(t??"").trim();return e||""}async function w(){const t=++G;g.value=!0;try{const e={page:C.value,page_size:Q.value};J.value&&V.value&&(e.include_deleted=1);const r=E(p.value.customer_code),n=E(p.value.customer_name),c=E(p.value.market),d=E(p.value.region),S=E(p.value.created_by);r&&(e.customer_code=r),n&&(e.customer_name=n),c&&(e.market=c),d&&(e.region=d),S&&(e.created_by=S);const N=await Je(e);if(t!==G)return;const f=N?.data||{};ee.value=Number(f.total||0),te.value=Array.isArray(f.items)?f.items:[]}catch(e){if(t!==G)return;console.error(e),y.error(e?.response?.data?.detail||e?.message||"客户列表加载失败")}finally{t===G&&(g.value=!1)}}function de(){w()}function b(){C.value=1,w()}function ce(){p.value={customer_code:"",customer_name:"",market:"",region:"",created_by:""},C.value=1,w()}const ae=A(()=>te.value||[]);function me(t){C.value=t,w()}function pe(t){Q.value=t,C.value=1,w()}function ve(){J.value&&(V.value=!V.value,C.value=1,w())}const U=v(!1),W=v(!1),B=v(null),L=v("create"),P=v(null),fe=A(()=>L.value==="edit"?"编辑客户":"新增客户");function _e(){return{type:"mobile",value:""}}const s=v({customer_code:"",customer_name:"",market:"",region:"",contacts:[]}),ge=/^1[3-9]\d{9}$/,ye=/^(0\d{2,3}-?)?\d{7,8}(-\d{1,6})?$/,be=/^(400|800)\d{7}$/;function O(t){return String(t??"").replace(/\s+/g,"").replace(/[^0-9\-]/g,"")}function ke(t){const e=String(t?.type||"").trim().toLowerCase(),r=O(t?.value||"");if(!r)return"联系方式不能为空（不需要可删除该行）";if(e==="mobile"){const n=r.replace(/-/g,"");return ge.test(n)?"":"手机号格式不正确（需为 11 位大陆手机号）"}if(e==="tel"){const n=r.replace(/-/g,"");return be.test(n)||ye.test(r)?"":"座机格式不正确（示例：010-88888888 / 0571-8888888 / 010-88888888-123 / 400xxxxxxx）"}return"联系方式类型仅支持：手机号/座机"}function Ce(){const t=Array.isArray(s.value.contacts)?s.value.contacts:[],e=new Set,r=[];for(const n of t){const c=String(n?.type||"").trim().toLowerCase()||"mobile",d=O(n?.value||"");if(!d)continue;if(c==="mobile"){const N=d.replace(/-/g,""),f=`${c}:${N}`;if(e.has(f))continue;e.add(f),r.push({type:c,value:N});continue}const S=`${c}:${d}`;e.has(S)||(e.add(S),r.push({type:c,value:d}))}return r}function we(t){return(Array.isArray(t)?t:[]).map(r=>({type:String(r?.type||"mobile").trim().toLowerCase()==="tel"?"tel":"mobile",value:O(r?.value||"")}))}async function j(){if(!B.value)return!0;try{return await B.value.validateField("contacts"),!0}catch{return!1}}const Ve={customer_code:[{required:!0,message:"客户代码必填",trigger:"blur"}],customer_name:[{required:!0,message:"客户名称必填",trigger:"blur"}],contacts:[{trigger:["change","blur"],validator:(t,e,r)=>{const n=Array.isArray(s.value.contacts)?s.value.contacts:[];for(let c=0;c<n.length;c++){const d=ke(n[c]);if(d)return r(new Error(`第 ${c+1} 条联系方式：${d}`))}r()}}]};function ze(){if(!$.value){y.warning("财务账号无新增权限");return}L.value="create",P.value=null,s.value={customer_code:"",customer_name:"",market:"",region:"",contacts:[]},U.value=!0}function Se(t){if(!H.value){y.warning("仅经理/超级账号/市场账号可编辑");return}t?.id&&(L.value="edit",P.value=t.id,s.value={customer_code:String(t.customer_code||""),customer_name:String(t.customer_name||t.group_name||""),market:String(t.market||""),region:String(t.region||""),contacts:we(t.contacts)},U.value=!0)}function xe(){Array.isArray(s.value.contacts)||(s.value.contacts=[]),s.value.contacts.push(_e()),Z(()=>j())}function Ae(t){Array.isArray(s.value.contacts)&&(s.value.contacts.splice(t,1),Z(()=>j()))}function De(t){const r=(s.value.contacts||[])[t];r&&(r.type=String(r.type||"mobile").trim().toLowerCase(),Z(()=>j()))}function $e(t,e){const n=(s.value.contacts||[])[t];n&&(n.value=O(e))}async function Ee(){if(L.value==="create"){if(!$.value){y.warning("财务账号无新增权限");return}}else{if(!H.value){y.warning("仅经理/超级账号/市场账号可编辑");return}if(!P.value)return}if(!B.value)return;try{await B.value.validate()}catch{return}const t=Ce();W.value=!0;try{const e={customer_code:s.value.customer_code,customer_name:s.value.customer_name,market:E(s.value.market)||null,region:s.value.region,contacts:t};L.value==="edit"?(await Qe(P.value,e),y.success("编辑客户成功")):(await We(e),y.success("新增客户成功")),U.value=!1,C.value=1,await w()}catch(e){console.error(e),y.error(e?.response?.data?.detail||e?.message||(L.value==="edit"?"编辑客户失败":"新增客户失败"))}finally{W.value=!1}}const h=v(!1),F=v(!1),z=v(null),Ue=A(()=>{const t=z.value?.customer_code?String(z.value.customer_code):"",e=z.value?.customer_name?String(z.value.customer_name):"";return t&&e?`${t} - ${e}`:t||e||"-"});function Le(t){if(!$.value){y.warning("财务账号无删除权限");return}t?.id&&(z.value=t,h.value=!0)}function Ne(){z.value=null,F.value=!1}async function Ie(){if(!$.value){y.warning("财务账号无删除权限");return}if(z.value?.id){F.value=!0;try{await Xe(z.value.id),y.success("删除成功"),h.value=!1,ae.value.length<=1&&C.value>1&&(C.value-=1),await w()}catch(t){console.error(t),y.error(t?.response?.data?.detail||t?.message||"删除失败")}finally{F.value=!1}}}return Te(()=>w()),(t,e)=>{const r=_("el-icon"),n=_("el-button"),c=_("el-tooltip"),d=_("el-input"),S=_("el-card"),N=_("el-tag"),f=_("el-table-column"),Re=_("el-table"),Me=_("el-pagination"),T=_("el-form-item"),oe=_("el-option"),Be=_("el-select"),he=_("el-form"),ne=_("el-dialog"),Fe=qe("loading");return m(),D("div",et,[u("div",tt,[e[16]||(e[16]=u("h2",null,"客户管理",-1)),u("div",lt,[J.value?(m(),k(c,{key:0,content:V.value?"点击隐藏已删除":"点击显示已删除",placement:"top"},{default:a(()=>[l(n,{size:"small",class:Ge(["toggle-btn",{"toggle-btn--active":V.value}]),type:V.value?"info":"default",plain:!0,loading:g.value,onClick:ve},{default:a(()=>[l(r,{class:"btn-ico"},{default:a(()=>[V.value?(m(),k(X(Oe),{key:0})):(m(),k(X(je),{key:1}))]),_:1}),i(" "+R(V.value?"隐藏已删除":"显示已删除"),1)]),_:1},8,["class","type","loading"])]),_:1},8,["content"])):se("",!0),$.value?(m(),k(n,{key:2,type:"primary",size:"small",onClick:ze},{default:a(()=>[...e[15]||(e[15]=[i("新增客户",-1)])]),_:1})):(m(),k(c,{key:1,content:"财务账号无新增权限",placement:"top"},{default:a(()=>[u("span",null,[l(n,{type:"primary",size:"small",disabled:""},{default:a(()=>[...e[14]||(e[14]=[i("新增客户",-1)])]),_:1})])]),_:1}))])]),l(S,{shadow:"never",class:"toolbar-card","body-style":{padding:"10px 12px"}},{default:a(()=>[u("div",at,[e[20]||(e[20]=u("div",{class:"toolbar-label"},"搜索：",-1)),u("div",ot,[u("div",nt,[l(d,{modelValue:p.value.customer_code,"onUpdate:modelValue":e[0]||(e[0]=o=>p.value.customer_code=o),size:"small",clearable:"",placeholder:"客户代码（模糊）",class:"toolbar-input",disabled:g.value,onKeyup:K(b,["enter"]),onClear:b},null,8,["modelValue","disabled"]),l(d,{modelValue:p.value.customer_name,"onUpdate:modelValue":e[1]||(e[1]=o=>p.value.customer_name=o),size:"small",clearable:"",placeholder:"客户名称（模糊）",class:"toolbar-input",disabled:g.value,onKeyup:K(b,["enter"]),onClear:b},null,8,["modelValue","disabled"]),l(d,{modelValue:p.value.market,"onUpdate:modelValue":e[2]||(e[2]=o=>p.value.market=o),size:"small",clearable:"",placeholder:"市场（模糊）",class:"toolbar-input",disabled:g.value,onKeyup:K(b,["enter"]),onClear:b},null,8,["modelValue","disabled"]),l(d,{modelValue:p.value.region,"onUpdate:modelValue":e[3]||(e[3]=o=>p.value.region=o),size:"small",clearable:"",placeholder:"归属地（模糊）",class:"toolbar-input",disabled:g.value,onKeyup:K(b,["enter"]),onClear:b},null,8,["modelValue","disabled"]),l(d,{modelValue:p.value.created_by,"onUpdate:modelValue":e[4]||(e[4]=o=>p.value.created_by=o),size:"small",clearable:"",placeholder:"创建人（模糊）",class:"toolbar-input",disabled:g.value,onKeyup:K(b,["enter"]),onClear:b},null,8,["modelValue","disabled"])]),u("div",st,[l(n,{size:"small",disabled:g.value,onClick:ce},{default:a(()=>[...e[17]||(e[17]=[i("重置",-1)])]),_:1},8,["disabled"]),l(n,{type:"primary",size:"small",loading:g.value,onClick:b},{default:a(()=>[...e[18]||(e[18]=[i("搜索",-1)])]),_:1},8,["loading"]),l(n,{size:"small",onClick:de,loading:g.value},{default:a(()=>[...e[19]||(e[19]=[i("刷新",-1)])]),_:1},8,["loading"])])])])]),_:1}),u("div",rt,[Ke((m(),k(Re,{data:ae.value,border:"",stripe:"",class:"main-table"},{default:a(()=>[l(f,{prop:"customer_code",label:"客户代码","min-width":"170","show-overflow-tooltip":""},{default:a(({row:o})=>[u("div",ut,[u("span",it,R(o.customer_code||"-"),1),le(o)?(m(),k(N,{key:0,size:"small",type:"info",class:"deleted-tag"},{default:a(()=>[...e[21]||(e[21]=[i("已删除",-1)])]),_:1})):se("",!0)])]),_:1}),l(f,{prop:"customer_name",label:"客户名称","min-width":"180","show-overflow-tooltip":""},{default:a(({row:o})=>[i(R(o.customer_name||o.group_name||"-"),1)]),_:1}),l(f,{prop:"market",label:"市场","min-width":"140","show-overflow-tooltip":""},{default:a(({row:o})=>[i(R(o.market||"-"),1)]),_:1}),l(f,{prop:"region",label:"归属地","min-width":"140","show-overflow-tooltip":""}),l(f,{label:"联系方式","min-width":"220","show-overflow-tooltip":""},{default:a(({row:o})=>[i(R(ie(o.contacts)),1)]),_:1}),l(f,{prop:"created_by_name",label:"创建人",width:"120","show-overflow-tooltip":""}),l(f,{prop:"created_at",label:"创建时间",width:"180","show-overflow-tooltip":""}),l(f,{label:"操作",width:"160",fixed:"right","class-name":"col-actions"},{default:a(({row:o})=>[le(o)?(m(),D(Y,{key:0},[l(c,{content:"该客户已删除",placement:"top"},{default:a(()=>[u("span",null,[l(n,{type:"primary",size:"small",link:"",disabled:""},{default:a(()=>[...e[22]||(e[22]=[i("编辑",-1)])]),_:1})])]),_:1}),l(c,{content:"该客户已删除",placement:"top"},{default:a(()=>[u("span",null,[l(n,{type:"danger",size:"small",link:"",disabled:""},{default:a(()=>[...e[23]||(e[23]=[i("删除",-1)])]),_:1})])]),_:1})],64)):(m(),D(Y,{key:1},[H.value?(m(),k(n,{key:1,type:"primary",size:"small",link:"",onClick:I=>Se(o)},{default:a(()=>[...e[25]||(e[25]=[i("编辑",-1)])]),_:1},8,["onClick"])):(m(),k(c,{key:0,content:"仅经理/超级账号/市场账号可编辑",placement:"top"},{default:a(()=>[u("span",null,[l(n,{type:"primary",size:"small",link:"",disabled:""},{default:a(()=>[...e[24]||(e[24]=[i("编辑",-1)])]),_:1})])]),_:1})),$.value?(m(),k(n,{key:3,type:"danger",size:"small",link:"",onClick:I=>Le(o)},{default:a(()=>[...e[27]||(e[27]=[i("删除",-1)])]),_:1},8,["onClick"])):(m(),k(c,{key:2,content:"财务账号无删除权限",placement:"top"},{default:a(()=>[u("span",null,[l(n,{type:"danger",size:"small",link:"",disabled:""},{default:a(()=>[...e[26]||(e[26]=[i("删除",-1)])]),_:1})])]),_:1}))],64))]),_:1})]),_:1},8,["data"])),[[Fe,g.value]])]),u("div",dt,[l(Me,{background:"",layout:"prev, pager, next, jumper, sizes, total","current-page":C.value,"page-size":Q.value,total:ee.value,"page-sizes":[10,20,50,100],onCurrentChange:me,onSizeChange:pe},null,8,["current-page","page-size","total"])]),l(ne,{modelValue:U.value,"onUpdate:modelValue":e[11]||(e[11]=o=>U.value=o),title:fe.value,width:"520px","destroy-on-close":""},{footer:a(()=>[u("span",ft,[l(n,{onClick:e[10]||(e[10]=o=>U.value=!1)},{default:a(()=>[...e[31]||(e[31]=[i("取消",-1)])]),_:1}),l(n,{type:"primary",loading:W.value,onClick:Ee},{default:a(()=>[...e[32]||(e[32]=[i("保存",-1)])]),_:1},8,["loading"])])]),default:a(()=>[l(he,{model:s.value,rules:Ve,ref_key:"formRef",ref:B,"label-width":"90px"},{default:a(()=>[l(T,{label:"客户代码",prop:"customer_code"},{default:a(()=>[l(d,{modelValue:s.value.customer_code,"onUpdate:modelValue":e[5]||(e[5]=o=>s.value.customer_code=o),clearable:""},null,8,["modelValue"])]),_:1}),l(T,{label:"客户名称",prop:"customer_name"},{default:a(()=>[l(d,{modelValue:s.value.customer_name,"onUpdate:modelValue":e[6]||(e[6]=o=>s.value.customer_name=o),clearable:""},null,8,["modelValue"])]),_:1}),l(T,{label:"市场",prop:"market"},{default:a(()=>[l(d,{modelValue:s.value.market,"onUpdate:modelValue":e[7]||(e[7]=o=>s.value.market=o),clearable:""},null,8,["modelValue"])]),_:1}),l(T,{label:"归属地",prop:"region"},{default:a(()=>[l(d,{modelValue:s.value.region,"onUpdate:modelValue":e[8]||(e[8]=o=>s.value.region=o),clearable:""},null,8,["modelValue"])]),_:1}),l(T,{label:"联系方式",prop:"contacts"},{default:a(()=>[u("div",ct,[u("div",mt,[l(n,{size:"small",onClick:xe},{default:a(()=>[...e[28]||(e[28]=[i("添加联系方式",-1)])]),_:1}),e[29]||(e[29]=u("div",{class:"contacts-hint"},"仅支持：手机号 / 座机（可多条）",-1))]),s.value.contacts.length?(m(),D("div",vt,[(m(!0),D(Y,null,Pe(s.value.contacts,(o,I)=>(m(),D("div",{key:I,class:"contacts-row"},[l(Be,{modelValue:o.type,"onUpdate:modelValue":x=>o.type=x,class:"contacts-type",placeholder:"类型",onChange:x=>De(I)},{default:a(()=>[l(oe,{label:"手机号",value:"mobile"}),l(oe,{label:"座机",value:"tel"})]),_:1},8,["modelValue","onUpdate:modelValue","onChange"]),l(d,{modelValue:o.value,"onUpdate:modelValue":x=>o.value=x,class:"contacts-value",clearable:"",placeholder:"手机号：11位；座机：010-88888888 / 400xxxxxxx",onInput:x=>$e(I,x),onBlur:e[9]||(e[9]=()=>j())},null,8,["modelValue","onUpdate:modelValue","onInput"]),l(n,{type:"danger",size:"small",link:"",class:"contacts-remove",onClick:x=>Ae(I)},{default:a(()=>[...e[30]||(e[30]=[i(" 删除 ",-1)])]),_:1},8,["onClick"])]))),128))])):(m(),D("div",pt,"未添加联系方式"))])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"]),l(ne,{modelValue:h.value,"onUpdate:modelValue":e[13]||(e[13]=o=>h.value=o),width:"440px","destroy-on-close":"","append-to-body":"","show-close":!1,class:"confirm-dialog",onClosed:Ne},{footer:a(()=>[u("div",Ct,[l(n,{onClick:e[12]||(e[12]=o=>h.value=!1),disabled:F.value},{default:a(()=>[...e[36]||(e[36]=[i("取消",-1)])]),_:1},8,["disabled"]),l(n,{type:"danger",loading:F.value,onClick:Ie},{default:a(()=>[...e[37]||(e[37]=[i("确认删除",-1)])]),_:1},8,["loading"])])]),default:a(()=>[u("div",_t,[u("div",gt,[l(r,{class:"cd-icon"},{default:a(()=>[l(X(He))]),_:1})]),u("div",yt,[u("div",bt,[e[33]||(e[33]=i("确认删除客户：",-1)),u("span",kt,R(Ue.value),1),e[34]||(e[34]=i("？",-1))]),e[35]||(e[35]=u("div",{class:"cd-desc"},"删除后会移入“已删除”，订单详情页下拉选项将不再展示。",-1))])])]),_:1},8,["modelValue"])])}}},Rt=Ye(wt,[["__scopeId","data-v-64439105"]]);export{Rt as default};
