import{b as Ze,u as fl}from"./vendor-vue-router-CVyACjsp.js";import{c as Be,a as Fe,p as gl,E as D,b as de,t as kl,d as bl}from"./vendor-element-plus-CtVxZ4Oy.js";import{h as Pe}from"./http-CBIyYC5i.js";import{d as Ke,e as el,h as yl,c as ll,f as tl,u as Qe}from"./orders-C0J9gWfa.js";import{V as hl,u as sl,p as wl}from"./bosUpload-BV4DaZOI.js";import{_ as al}from"./index-C11rPtdm.js";import{r as g,c as Ne,q as Ge,ay as k,x as v,y as o,J as U,P as a,z as l,H as d,L as f,u as te,O as P,ac as be,G as x,M as $,o as Vl,Y as Ul,aI as $l,I as xl}from"./vendor-vue-fFWwKrgY.js";import"./vendor-lodash-rvV0CIkQ.js";import"./vendor-DWCz07M-.js";import"./vendor-dates-DVKSwKij.js";import"./vendor-axios-C0Zqfgkc.js";import"./vendor-pinia-CMXa-Za0.js";const Cl={class:"order-create"},Sl={key:0,class:"detail-header"},zl={class:"header-actions"},Ll={class:"section-header"},Ol={class:"two-col"},Rl={class:"left"},El={key:0,class:"kv-grid kv-grid-2"},Il={class:"kv-item"},Al={class:"kv-value"},Ml={class:"kv-item"},Nl={class:"kv-value"},Tl={class:"kv-item"},Dl={class:"kv-value"},Bl={class:"kv-item"},Fl={class:"kv-value"},Pl={key:1},Gl={class:"right"},jl={class:"upload-title"},ql={key:0,class:"slot-sub"},Hl={key:0,class:"one-wrap"},Yl={key:1,class:"upload-empty"},Jl={key:0,class:"uploading-tip"},Wl={class:"slot-foot"},Ql={class:"slot-foot-left"},Xl={key:1,class:"muted"},Zl={class:"slot-foot-right"},Kl={class:"section-header"},et={class:"stack"},lt={class:"sub-block"},tt={class:"two-col"},st={class:"left"},at={key:0,class:"kv-grid kv-grid-2"},it={class:"kv-item"},ot={class:"kv-value"},nt={class:"kv-item"},dt={class:"kv-value"},rt={key:1,class:"kv-grid kv-grid-2"},ut={class:"kv-item"},ct={class:"kv-value"},vt={class:"kv-item"},_t={class:"kv-value"},pt={class:"kv-item"},mt={class:"kv-value"},ft={class:"kv-item"},gt={class:"kv-value"},kt={class:"kv-item"},bt={class:"kv-value"},yt={class:"kv-item"},ht={class:"kv-value"},wt={class:"right"},Vt={class:"upload-title"},Ut={key:0,class:"slot-sub"},$t={key:0,class:"one-wrap"},xt={key:1,class:"upload-empty"},Ct={key:0,class:"uploading-tip"},St={class:"slot-foot"},zt={class:"slot-foot-left"},Lt={key:1,class:"muted"},Ot={class:"slot-foot-right"},Rt={class:"sub-block"},Et={class:"two-col"},It={class:"left"},At={key:0,class:"kv-grid kv-grid-2"},Mt={class:"kv-item"},Nt={class:"kv-value"},Tt={class:"kv-item"},Dt={class:"kv-value"},Bt={class:"right"},Ft={class:"upload-title"},Pt={key:0,class:"slot-sub"},Gt={key:0,class:"one-wrap"},jt={key:1,class:"upload-empty"},qt={key:0,class:"uploading-tip"},Ht={class:"slot-foot"},Yt={class:"slot-foot-left"},Jt={key:1,class:"muted"},Wt={class:"slot-foot-right"},Qt={class:"section-header"},Xt={class:"stack"},Zt={class:"sub-block"},Kt={class:"two-col"},es={class:"left"},ls={key:0,class:"kv-grid kv-grid-2"},ts={class:"kv-item"},ss={class:"kv-value"},as={key:1,class:"kv-grid kv-grid-2"},is={class:"kv-item"},os={class:"kv-value"},ns={class:"kv-item"},ds={class:"kv-value"},rs={class:"kv-item"},us={class:"kv-value"},cs={class:"kv-item"},vs={class:"kv-value"},_s={class:"kv-item"},ps={class:"kv-value"},ms={class:"right"},fs={class:"upload-title"},gs={key:0,class:"slot-sub"},ks={key:0,class:"one-wrap"},bs={key:1,class:"upload-empty"},ys={key:0,class:"uploading-tip"},hs={class:"slot-foot"},ws={class:"slot-foot-left"},Vs={key:1,class:"muted"},Us={class:"slot-foot-right"},$s={class:"sub-block"},xs={class:"two-col"},Cs={class:"left"},Ss={key:0,class:"kv-grid kv-grid-2"},zs={class:"kv-item"},Ls={class:"kv-value"},Os={class:"right"},Rs={class:"upload-title"},Es={key:0,class:"slot-sub"},Is={key:0,class:"one-wrap"},As={key:1,class:"upload-empty"},Ms={key:0,class:"uploading-tip"},Ns={class:"slot-foot"},Ts={class:"slot-foot-left"},Ds={key:1,class:"muted"},Bs={class:"slot-foot-right"},Fs={class:"upload-title"},Ps={key:0,class:"slot-sub"},Gs={class:"upload-trigger"},js={key:0,class:"uploading-tip"},qs={class:"footer-actions"},Hs={__name:"OrderCreateForm",props:{embedded:{type:Boolean,default:!1}},setup(je){const se=je,ae=Ze(),z=g(!1),xe=g(null),O=g({customer_group_id:null,channel_group_id:null}),Z={customer_group_id:[{required:!0,message:"客户必选",trigger:"change"}],channel_group_id:[{required:!0,message:"渠道必选",trigger:"change"}]},Ce=g([]),ye=g([]);function G(i){return String(i??"").trim()}function Se(i){const e=G(i?.customer_code||i?.code||""),r=G(i?.customer_name||i?.name||""),p=G(i?.group_name||""),h=i?.id!=null?String(i.id):"";return e&&r?`${e} - ${r}`:e&&p?`${e} - ${p}`:e||r||p||h||"-"}function K(i){const e=G(i?.channel_code||i?.code||""),r=G(i?.channel_name||i?.name||""),p=G(i?.group_name||""),h=i?.id!=null?String(i.id):"";return e&&r?`${e} - ${r}`:e&&p?`${e} - ${p}`:e||r||p||h||"-"}const m=g({cert_no:"",cert_issue_date:"",manufacturer_name:"",vehicle_brand_name:"",vehicle_model:"",vin:"",body_color:"",chassis_model_id:"",chassis_cert_no:"",engine_model:"",engine_no:"",fuel_type:"",displacement_and_power:"",emission_standard:"",fuel_consumption:"",overall_dimensions:"",cargo_dimensions:"",leaf_spring_count:"",tire_count:"",tire_spec:"",wheel_track:"",wheel_base:"",axle_load_kg:"",axle_count:"",steering_type:"",curb_weight:"",gross_weight:"",rated_load:"",rated_traction_weight:"",load_utilization_factor:"",allowed_traction_weight:"",semi_trailer_weight:"",cab_passenger_count:"",approved_passenger_count:"",manufacture_date:"",cert_remark:"",id_name:"",id_number:"",id_gender:"",id_ethnicity:"",id_birth_date:"",id_address:"",id_issuer:"",id_validity:"",dl_plate_no:"",dl_vehicle_type:"",dl_owner:"",dl_use_nature:"",dl_brand_model:"",dl_attach_note:"",remark:""}),ie=g(""),re=g(!1),I=g(!1),ue=g(!1),oe=[{key:"vehicle_cert",label:"合格证",multiple:!1},{key:"idcard_front",label:"身份证正面",multiple:!1},{key:"idcard_back",label:"身份证反面",multiple:!1},{key:"driving_license_main",label:"行驶证主页",multiple:!1},{key:"driving_license_sub",label:"行驶证副页",multiple:!1},{key:"related",label:"相关图片(多张)",multiple:!0}];function ze(i){return oe.find(e=>e.key===i)?.multiple===!0}function Le(i){return oe.find(e=>e.key===i)?.label||i}function j(i){return ze(i)?!1:(y.value[i]||[]).length>=1}function q(i){D.warning(`${Le(i)}：请先删除当前图片，再上传新图片`)}const y=g({vehicle_cert:[],idcard_front:[],idcard_back:[],driving_license_main:[],driving_license_sub:[],related:[]}),W=g({}),R=g(0),Q=g({}),B=g({}),S=g("");let H=null,F=0;function A(i){try{return Date.parse(i)}catch{return 0}}async function Y(){const i=Date.now();if(H&&F&&i+12e4<F)return H;const r=(await Pe.get("/orders/bos-sts"))?.data;if(!r?.accessKeyId||!r?.secretAccessKey||!r?.sessionToken)throw new Error("bos-sts response invalid");return H=r,S.value=r.bosHost||"",F=A(r.expiration)||i+600*1e3,H}function C(i){const e=y.value[i]||[];return e.length?e[0]:null}function ee(i){return(y.value[i]||[]).map(r=>r.url).filter(Boolean)}function ce(i){const e=i?.raw;if(e&&!i.url){const r=URL.createObjectURL(e);i.url=r,B.value[i.uid]=r}}function ve(i){const e=B.value[i];if(e){try{URL.revokeObjectURL(e)}catch{}delete B.value[i]}}function le(i){const e=y.value[i]||[];for(const r of e){const p=r?.uid;p&&(W.value[p]&&delete W.value[p],Q.value[p]&&delete Q.value[p],ve(p))}y.value[i]=[]}function _e(i,e){le(i),ce(e),y.value[i]=[e],he(i,e).catch(r=>{console.error(r),de({title:"上传失败",message:`上传失败：${r?.message||"unknown error"}`,type:"error",duration:4500})})}function Oe(i,e,r){y.value[i]=Array.isArray(r)?r:[],ce(e),he(i,e).catch(p=>{console.error(p),de({title:"上传失败",message:`上传失败：${p?.message||"unknown error"}`,type:"error",duration:4500})})}function Te(i,e,r){y.value[i]=Array.isArray(r)?r:[];const p=e?.uid;p&&W.value[p]&&delete W.value[p],p&&Q.value[p]&&delete Q.value[p],p&&ve(p)}async function he(i,e){const r=e?.raw;if(r&&!W.value[e.uid]){R.value+=1,Q.value[e.uid]={status:"uploading"};try{const p=await Y();if(!S.value)throw new Error("bosHost missing");const h=await sl({bosHost:S.value,slotKey:i,file:r,sts:p});h?.preview_url&&(e.url=h.preview_url),W.value[e.uid]={slot_key:i,...h},Q.value[e.uid]={status:"done"}}catch(p){throw Q.value[e.uid]={status:"error"},p}finally{R.value-=1}}}function w(i){const e=y.value[i]||[];let r=0;for(const p of e)W.value[p.uid]&&(r+=1);return r}function M(i){const e=y.value[i]||[];let r=0;for(const p of e)Q.value[p.uid]?.status==="uploading"&&(r+=1);return r}const Re=Ne(()=>oe.some(i=>(y.value[i.key]||[]).length>0));function De(){O.value={customer_group_id:null,channel_group_id:null};for(const i of Object.keys(m.value))m.value[i]="";ie.value="";for(const i of oe)le(i.key);W.value={},Q.value={};for(const i of Object.keys(B.value))ve(i);B.value={}}function Ee(){let i={};if(ie.value&&ie.value.trim())try{const r=JSON.parse(ie.value);r&&typeof r=="object"&&!Array.isArray(r)&&(i=r)}catch{D.warning("更多字段 JSON 解析失败：已忽略该部分")}const e={...i,...m.value};O.value.customer_group_id&&(e.customer_group_id=O.value.customer_group_id),O.value.channel_group_id&&(e.channel_group_id=O.value.channel_group_id);for(const[r,p]of Object.entries(e))(p===""||p===null||p===void 0)&&delete e[r];return e}function Ie(){const i=[];for(const e of oe){const r=y.value[e.key]||[];for(const p of r){const h=W.value[p.uid];h&&i.push({slot_key:h.slot_key,storage_key:h.storage_key,md5:h.md5,size:h.size||0,content_type:h.content_type??void 0,etag:h.etag??void 0,original_name:h.original_name??void 0})}}return i}async function Ae(){try{await xe.value?.validate?.()}catch{D.warning("客户群、渠道群为必选项，请先选择");return}z.value=!0;try{const i=Ee();if(!Re.value){const X=(await yl({module:"order",dynamic_data:i,image_urls:[],ocr_raw_json:null,customer_group_id:O.value.customer_group_id,channel_group_id:O.value.channel_group_id}))?.data?.id;D.success("订单创建成功"),X&&ae.push({path:`/orders/${X}`});return}if(R.value>0){D.warning("还有文件在上传中，请稍后再提交");return}const e=Ie();if(!e.length){D.warning("未检测到已上传文件（可能上传失败）");return}const r=await ll({module:"order",dynamic_data:i||{},customer_group_id:O.value.customer_group_id??void 0,channel_group_id:O.value.channel_group_id??void 0}),h=(r?.data?.data??r?.data??r)?.order_id;if(!h)throw new Error("draft failed: missing order_id");await tl({order_id:h,images:e,dynamic_data:i||{},customer_group_id:O.value.customer_group_id??void 0,channel_group_id:O.value.channel_group_id??void 0}),de({title:"已提交识别",message:"订单已创建并提交识别任务，稍后可在订单详情查看回填结果。",type:"success",duration:4500}),ae.push({path:`/orders/${h}`})}catch(i){console.error(i),D.error("提交失败")}finally{z.value=!1}}async function Me(){try{const[i,e]=await Promise.all([Ke(),el()]);Ce.value=i?.data?.items||i?.data||[],ye.value=e?.data?.items||e?.data||[]}catch(i){console.error(i)}}return Ge(()=>{Me()}),(i,e)=>{const r=k("el-button"),p=k("el-option"),h=k("el-select"),we=k("el-form-item"),X=k("el-col"),Ve=k("el-row"),pe=k("el-form"),J=k("el-card"),me=k("el-icon"),V=k("el-input"),fe=k("el-image"),ne=k("el-upload");return o(),v("div",Cl,[se.embedded?U("",!0):(o(),v("div",Sl,[e[34]||(e[34]=l("h2",null,"手动新建订单",-1)),l("div",zl,[a(r,{size:"small",onClick:e[0]||(e[0]=n=>te(ae).back())},{default:d(()=>[...e[33]||(e[33]=[f("返回",-1)])]),_:1})])])),a(J,{shadow:"never",class:"section-card meta-card"},{header:d(()=>[...e[35]||(e[35]=[l("div",{class:"section-header"},[l("div",{class:"section-title"},"基础信息")],-1)])]),default:d(()=>[a(pe,{ref_key:"metaFormRef",ref:xe,model:O.value,rules:Z,"label-width":"80px"},{default:d(()=>[a(Ve,{gutter:12},{default:d(()=>[a(X,{span:12},{default:d(()=>[a(we,{label:"客户群",prop:"customer_group_id"},{default:d(()=>[a(h,{modelValue:O.value.customer_group_id,"onUpdate:modelValue":e[1]||(e[1]=n=>O.value.customer_group_id=n),clearable:"",filterable:"",placeholder:"必选",class:"fv fv-select",style:{width:"100%"}},{default:d(()=>[(o(!0),v(P,null,be(Ce.value,n=>(o(),x(p,{key:String(n.id),label:Se(n),value:n.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1}),a(X,{span:12},{default:d(()=>[a(we,{label:"渠道群",prop:"channel_group_id"},{default:d(()=>[a(h,{modelValue:O.value.channel_group_id,"onUpdate:modelValue":e[2]||(e[2]=n=>O.value.channel_group_id=n),clearable:"",filterable:"",placeholder:"必选",class:"fv fv-select",style:{width:"100%"}},{default:d(()=>[(o(!0),v(P,null,be(ye.value,n=>(o(),x(p,{key:String(n.id),label:K(n),value:n.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1})]),_:1},8,["model"])]),_:1}),a(J,{shadow:"never",class:"section-card"},{header:d(()=>[l("div",Ll,[e[36]||(e[36]=l("div",{class:"section-title"},"车辆合格证",-1)),a(r,{class:"icon-btn",circle:"",size:"small",onClick:e[3]||(e[3]=n=>re.value=!re.value)},{default:d(()=>[a(me,null,{default:d(()=>[re.value?(o(),x(te(Be),{key:0})):(o(),x(te(Fe),{key:1}))]),_:1})]),_:1})])]),default:d(()=>[l("div",Ol,[l("div",Rl,[re.value?(o(),v("div",Pl,[a(hl,{data:m.value,readonly:!1},null,8,["data"])])):(o(),v("div",El,[l("div",Il,[e[37]||(e[37]=l("div",{class:"kv-label"},"车辆型号",-1)),l("div",Al,[a(V,{modelValue:m.value.vehicle_model,"onUpdate:modelValue":e[4]||(e[4]=n=>m.value.vehicle_model=n),placeholder:"车辆型号",clearable:"",class:"fv fv-input"},null,8,["modelValue"])])]),l("div",Ml,[e[38]||(e[38]=l("div",{class:"kv-label"},"车辆识别代码/车架号",-1)),l("div",Nl,[a(V,{modelValue:m.value.vin,"onUpdate:modelValue":e[5]||(e[5]=n=>m.value.vin=n),placeholder:"车架号",clearable:"",class:"fv fv-input"},null,8,["modelValue"])])]),l("div",Tl,[e[39]||(e[39]=l("div",{class:"kv-label"},"发动机号",-1)),l("div",Dl,[a(V,{modelValue:m.value.engine_no,"onUpdate:modelValue":e[6]||(e[6]=n=>m.value.engine_no=n),placeholder:"发动机号",clearable:"",class:"fv fv-input"},null,8,["modelValue"])])]),l("div",Bl,[e[40]||(e[40]=l("div",{class:"kv-label"},"额定载客(人)",-1)),l("div",Fl,[a(V,{modelValue:m.value.approved_passenger_count,"onUpdate:modelValue":e[7]||(e[7]=n=>m.value.approved_passenger_count=n),placeholder:"额定载客(人)",clearable:"",class:"fv fv-input"},null,8,["modelValue"])])])]))]),l("div",Gl,[l("div",jl,[e[43]||(e[43]=l("span",null,"合格证图片",-1)),w("vehicle_cert")>0?(o(),v("span",ql,[f(" （已就绪 "+$(w("vehicle_cert"))+" 张 ",1),e[41]||(e[41]=l("span",{class:"ready-dot","aria-hidden":"true"},null,-1)),e[42]||(e[42]=f("） ",-1))])):U("",!0)]),a(ne,{drag:"","auto-upload":!1,multiple:!1,limit:1,"show-file-list":!1,"file-list":y.value.vehicle_cert,disabled:j("vehicle_cert")||z.value||R.value>0,"on-change":n=>_e("vehicle_cert",n),"on-exceed":()=>q("vehicle_cert"),accept:"image/*",class:"upload-box upload-one"},{default:d(()=>[C("vehicle_cert")?(o(),v("div",Hl,[a(fe,{src:C("vehicle_cert")?.url,"preview-src-list":ee("vehicle_cert"),fit:"contain",class:"one-img"},null,8,["src","preview-src-list"]),e[44]||(e[44]=l("div",{class:"one-mask"},[l("div",{class:"one-mask-text"},"已上传，删除后可重新上传")],-1))])):(o(),v("div",Yl,[...e[45]||(e[45]=[l("div",{class:"empty-center"},[l("div",{class:"empty-title"},"拖拽图片到此处"),l("div",{class:"empty-sub"},"或点击选择文件")],-1)])]))]),_:1},8,["file-list","disabled","on-change","on-exceed"]),M("vehicle_cert")>0?(o(),v("div",Jl," 正在上传："+$(M("vehicle_cert"))+" 个文件…（上传完成后才能提交） ",1)):U("",!0),l("div",Wl,[l("div",Ql,[w("vehicle_cert")>0?(o(),v(P,{key:0},[l("span",null,"已就绪："+$(w("vehicle_cert"))+" 张",1),e[46]||(e[46]=l("span",{class:"ready-dot","aria-hidden":"true"},null,-1))],64)):(o(),v("span",Xl,"未上传"))]),l("div",Zl,[(y.value.vehicle_cert||[]).length?(o(),x(r,{key:0,size:"small",type:"danger",link:"",class:"slot-remove",disabled:z.value||R.value>0,onClick:e[8]||(e[8]=n=>le("vehicle_cert"))},{default:d(()=>[...e[47]||(e[47]=[f(" 移除 ",-1)])]),_:1},8,["disabled"])):U("",!0)])])])])]),_:1}),a(J,{shadow:"never",class:"section-card"},{header:d(()=>[l("div",Kl,[e[48]||(e[48]=l("div",{class:"section-title"},"身份证正面/身份证背面",-1)),a(r,{class:"icon-btn",circle:"",size:"small",onClick:e[9]||(e[9]=n=>I.value=!I.value)},{default:d(()=>[a(me,null,{default:d(()=>[I.value?(o(),x(te(Be),{key:0})):(o(),x(te(Fe),{key:1}))]),_:1})]),_:1})])]),default:d(()=>[l("div",et,[l("div",lt,[e[64]||(e[64]=l("div",{class:"sub-title"},"身份证正面",-1)),l("div",tt,[l("div",st,[I.value?(o(),v("div",rt,[l("div",ut,[e[51]||(e[51]=l("div",{class:"kv-label"},"姓名",-1)),l("div",ct,[a(V,{modelValue:m.value.id_name,"onUpdate:modelValue":e[12]||(e[12]=n=>m.value.id_name=n),placeholder:"姓名",clearable:"",class:"fv fv-input"},null,8,["modelValue"])])]),l("div",vt,[e[52]||(e[52]=l("div",{class:"kv-label"},"公民身份号码",-1)),l("div",_t,[a(V,{modelValue:m.value.id_number,"onUpdate:modelValue":e[13]||(e[13]=n=>m.value.id_number=n),placeholder:"身份证号",clearable:"",class:"fv fv-input"},null,8,["modelValue"])])]),l("div",pt,[e[53]||(e[53]=l("div",{class:"kv-label"},"性别",-1)),l("div",mt,[a(V,{modelValue:m.value.id_gender,"onUpdate:modelValue":e[14]||(e[14]=n=>m.value.id_gender=n),placeholder:"性别",clearable:"",class:"fv fv-input"},null,8,["modelValue"])])]),l("div",ft,[e[54]||(e[54]=l("div",{class:"kv-label"},"民族",-1)),l("div",gt,[a(V,{modelValue:m.value.id_ethnicity,"onUpdate:modelValue":e[15]||(e[15]=n=>m.value.id_ethnicity=n),placeholder:"民族",clearable:"",class:"fv fv-input"},null,8,["modelValue"])])]),l("div",kt,[e[55]||(e[55]=l("div",{class:"kv-label"},"出生日期",-1)),l("div",bt,[a(V,{modelValue:m.value.id_birth_date,"onUpdate:modelValue":e[16]||(e[16]=n=>m.value.id_birth_date=n),placeholder:"YYYY-MM-DD",clearable:"",class:"fv fv-input"},null,8,["modelValue"])])]),l("div",yt,[e[56]||(e[56]=l("div",{class:"kv-label"},"住址",-1)),l("div",ht,[a(V,{modelValue:m.value.id_address,"onUpdate:modelValue":e[17]||(e[17]=n=>m.value.id_address=n),placeholder:"住址",clearable:"",class:"fv fv-input"},null,8,["modelValue"])])])])):(o(),v("div",at,[l("div",it,[e[49]||(e[49]=l("div",{class:"kv-label"},"姓名",-1)),l("div",ot,[a(V,{modelValue:m.value.id_name,"onUpdate:modelValue":e[10]||(e[10]=n=>m.value.id_name=n),placeholder:"姓名",clearable:"",class:"fv fv-input"},null,8,["modelValue"])])]),l("div",nt,[e[50]||(e[50]=l("div",{class:"kv-label"},"公民身份号码",-1)),l("div",dt,[a(V,{modelValue:m.value.id_number,"onUpdate:modelValue":e[11]||(e[11]=n=>m.value.id_number=n),placeholder:"身份证号",clearable:"",class:"fv fv-input"},null,8,["modelValue"])])])]))]),l("div",wt,[l("div",Vt,[e[59]||(e[59]=l("span",null,"身份证正面图片",-1)),w("idcard_front")>0?(o(),v("span",Ut,[f(" （已就绪 "+$(w("idcard_front"))+" 张 ",1),e[57]||(e[57]=l("span",{class:"ready-dot","aria-hidden":"true"},null,-1)),e[58]||(e[58]=f("） ",-1))])):U("",!0)]),a(ne,{drag:"","auto-upload":!1,multiple:!1,limit:1,"show-file-list":!1,"file-list":y.value.idcard_front,disabled:j("idcard_front")||z.value||R.value>0,"on-change":n=>_e("idcard_front",n),"on-exceed":()=>q("idcard_front"),accept:"image/*",class:"upload-box upload-one"},{default:d(()=>[C("idcard_front")?(o(),v("div",$t,[a(fe,{src:C("idcard_front")?.url,"preview-src-list":ee("idcard_front"),fit:"contain",class:"one-img"},null,8,["src","preview-src-list"]),e[60]||(e[60]=l("div",{class:"one-mask"},[l("div",{class:"one-mask-text"},"已上传，删除后可重新上传")],-1))])):(o(),v("div",xt,[...e[61]||(e[61]=[l("div",{class:"empty-center"},[l("div",{class:"empty-title"},"拖拽图片到此处"),l("div",{class:"empty-sub"},"或点击选择文件")],-1)])]))]),_:1},8,["file-list","disabled","on-change","on-exceed"]),M("idcard_front")>0?(o(),v("div",Ct," 正在上传："+$(M("idcard_front"))+" 个文件…（上传完成后才能提交） ",1)):U("",!0),l("div",St,[l("div",zt,[w("idcard_front")>0?(o(),v(P,{key:0},[l("span",null,"已就绪："+$(w("idcard_front"))+" 张",1),e[62]||(e[62]=l("span",{class:"ready-dot","aria-hidden":"true"},null,-1))],64)):(o(),v("span",Lt,"未上传"))]),l("div",Ot,[(y.value.idcard_front||[]).length?(o(),x(r,{key:0,size:"small",type:"danger",link:"",class:"slot-remove",disabled:z.value||R.value>0,onClick:e[18]||(e[18]=n=>le("idcard_front"))},{default:d(()=>[...e[63]||(e[63]=[f(" 移除 ",-1)])]),_:1},8,["disabled"])):U("",!0)])])])])]),l("div",Rt,[e[74]||(e[74]=l("div",{class:"sub-title"},"身份证背面",-1)),l("div",Et,[l("div",It,[I.value?(o(),v("div",At,[l("div",Mt,[e[65]||(e[65]=l("div",{class:"kv-label"},"签发机关",-1)),l("div",Nt,[a(V,{modelValue:m.value.id_issuer,"onUpdate:modelValue":e[19]||(e[19]=n=>m.value.id_issuer=n),placeholder:"签发机关",clearable:"",class:"fv fv-input"},null,8,["modelValue"])])]),l("div",Tt,[e[66]||(e[66]=l("div",{class:"kv-label"},"有效期限",-1)),l("div",Dt,[a(V,{modelValue:m.value.id_validity,"onUpdate:modelValue":e[20]||(e[20]=n=>m.value.id_validity=n),placeholder:"例如：2020-01-01~2040-01-01",clearable:"",class:"fv fv-input"},null,8,["modelValue"])])])])):U("",!0)]),l("div",Bt,[l("div",Ft,[e[69]||(e[69]=l("span",null,"身份证背面图片",-1)),w("idcard_back")>0?(o(),v("span",Pt,[f(" （已就绪 "+$(w("idcard_back"))+" 张 ",1),e[67]||(e[67]=l("span",{class:"ready-dot","aria-hidden":"true"},null,-1)),e[68]||(e[68]=f("） ",-1))])):U("",!0)]),a(ne,{drag:"","auto-upload":!1,multiple:!1,limit:1,"show-file-list":!1,"file-list":y.value.idcard_back,disabled:j("idcard_back")||z.value||R.value>0,"on-change":n=>_e("idcard_back",n),"on-exceed":()=>q("idcard_back"),accept:"image/*",class:"upload-box upload-one"},{default:d(()=>[C("idcard_back")?(o(),v("div",Gt,[a(fe,{src:C("idcard_back")?.url,"preview-src-list":ee("idcard_back"),fit:"contain",class:"one-img"},null,8,["src","preview-src-list"]),e[70]||(e[70]=l("div",{class:"one-mask"},[l("div",{class:"one-mask-text"},"已上传，删除后可重新上传")],-1))])):(o(),v("div",jt,[...e[71]||(e[71]=[l("div",{class:"empty-center"},[l("div",{class:"empty-title"},"拖拽图片到此处"),l("div",{class:"empty-sub"},"或点击选择文件")],-1)])]))]),_:1},8,["file-list","disabled","on-change","on-exceed"]),M("idcard_back")>0?(o(),v("div",qt," 正在上传："+$(M("idcard_back"))+" 个文件…（上传完成后才能提交） ",1)):U("",!0),l("div",Ht,[l("div",Yt,[w("idcard_back")>0?(o(),v(P,{key:0},[l("span",null,"已就绪："+$(w("idcard_back"))+" 张",1),e[72]||(e[72]=l("span",{class:"ready-dot","aria-hidden":"true"},null,-1))],64)):(o(),v("span",Jt,"未上传"))]),l("div",Wt,[(y.value.idcard_back||[]).length?(o(),x(r,{key:0,size:"small",type:"danger",link:"",class:"slot-remove",disabled:z.value||R.value>0,onClick:e[21]||(e[21]=n=>le("idcard_back"))},{default:d(()=>[...e[73]||(e[73]=[f(" 移除 ",-1)])]),_:1},8,["disabled"])):U("",!0)])])])])])])]),_:1}),a(J,{shadow:"never",class:"section-card"},{header:d(()=>[l("div",Qt,[e[75]||(e[75]=l("div",{class:"section-title"},"行驶证/行驶证副件",-1)),a(r,{class:"icon-btn",circle:"",size:"small",onClick:e[22]||(e[22]=n=>ue.value=!ue.value)},{default:d(()=>[a(me,null,{default:d(()=>[ue.value?(o(),x(te(Be),{key:0})):(o(),x(te(Fe),{key:1}))]),_:1})]),_:1})])]),default:d(()=>[l("div",Xt,[l("div",Zt,[e[89]||(e[89]=l("div",{class:"sub-title"},"行驶证主页",-1)),l("div",Kt,[l("div",es,[ue.value?(o(),v("div",as,[l("div",is,[e[77]||(e[77]=l("div",{class:"kv-label"},"号牌号码",-1)),l("div",os,[a(V,{modelValue:m.value.dl_plate_no,"onUpdate:modelValue":e[24]||(e[24]=n=>m.value.dl_plate_no=n),placeholder:"车牌号",clearable:"",class:"fv fv-input"},null,8,["modelValue"])])]),l("div",ns,[e[78]||(e[78]=l("div",{class:"kv-label"},"车辆类型",-1)),l("div",ds,[a(V,{modelValue:m.value.dl_vehicle_type,"onUpdate:modelValue":e[25]||(e[25]=n=>m.value.dl_vehicle_type=n),placeholder:"车辆类型",clearable:"",class:"fv fv-input"},null,8,["modelValue"])])]),l("div",rs,[e[79]||(e[79]=l("div",{class:"kv-label"},"所有人",-1)),l("div",us,[a(V,{modelValue:m.value.dl_owner,"onUpdate:modelValue":e[26]||(e[26]=n=>m.value.dl_owner=n),placeholder:"所有人",clearable:"",class:"fv fv-input"},null,8,["modelValue"])])]),l("div",cs,[e[80]||(e[80]=l("div",{class:"kv-label"},"使用性质",-1)),l("div",vs,[a(V,{modelValue:m.value.dl_use_nature,"onUpdate:modelValue":e[27]||(e[27]=n=>m.value.dl_use_nature=n),placeholder:"使用性质",clearable:"",class:"fv fv-input"},null,8,["modelValue"])])]),l("div",_s,[e[81]||(e[81]=l("div",{class:"kv-label"},"品牌型号",-1)),l("div",ps,[a(V,{modelValue:m.value.dl_brand_model,"onUpdate:modelValue":e[28]||(e[28]=n=>m.value.dl_brand_model=n),placeholder:"品牌型号",clearable:"",class:"fv fv-input"},null,8,["modelValue"])])])])):(o(),v("div",ls,[l("div",ts,[e[76]||(e[76]=l("div",{class:"kv-label"},"号牌号码",-1)),l("div",ss,[a(V,{modelValue:m.value.dl_plate_no,"onUpdate:modelValue":e[23]||(e[23]=n=>m.value.dl_plate_no=n),placeholder:"车牌号",clearable:"",class:"fv fv-input"},null,8,["modelValue"])])])]))]),l("div",ms,[l("div",fs,[e[84]||(e[84]=l("span",null,"行驶证主页图片",-1)),w("driving_license_main")>0?(o(),v("span",gs,[f(" （已就绪 "+$(w("driving_license_main"))+" 张 ",1),e[82]||(e[82]=l("span",{class:"ready-dot","aria-hidden":"true"},null,-1)),e[83]||(e[83]=f("） ",-1))])):U("",!0)]),a(ne,{drag:"","auto-upload":!1,multiple:!1,limit:1,"show-file-list":!1,"file-list":y.value.driving_license_main,disabled:j("driving_license_main")||z.value||R.value>0,"on-change":n=>_e("driving_license_main",n),"on-exceed":()=>q("driving_license_main"),accept:"image/*",class:"upload-box upload-one"},{default:d(()=>[C("driving_license_main")?(o(),v("div",ks,[a(fe,{src:C("driving_license_main")?.url,"preview-src-list":ee("driving_license_main"),fit:"contain",class:"one-img"},null,8,["src","preview-src-list"]),e[85]||(e[85]=l("div",{class:"one-mask"},[l("div",{class:"one-mask-text"},"已上传，删除后可重新上传")],-1))])):(o(),v("div",bs,[...e[86]||(e[86]=[l("div",{class:"empty-center"},[l("div",{class:"empty-title"},"拖拽图片到此处"),l("div",{class:"empty-sub"},"或点击选择文件")],-1)])]))]),_:1},8,["file-list","disabled","on-change","on-exceed"]),M("driving_license_main")>0?(o(),v("div",ys," 正在上传："+$(M("driving_license_main"))+" 个文件…（上传完成后才能提交） ",1)):U("",!0),l("div",hs,[l("div",ws,[w("driving_license_main")>0?(o(),v(P,{key:0},[l("span",null,"已就绪："+$(w("driving_license_main"))+" 张",1),e[87]||(e[87]=l("span",{class:"ready-dot","aria-hidden":"true"},null,-1))],64)):(o(),v("span",Vs,"未上传"))]),l("div",Us,[(y.value.driving_license_main||[]).length?(o(),x(r,{key:0,size:"small",type:"danger",link:"",class:"slot-remove",disabled:z.value||R.value>0,onClick:e[29]||(e[29]=n=>le("driving_license_main"))},{default:d(()=>[...e[88]||(e[88]=[f(" 移除 ",-1)])]),_:1},8,["disabled"])):U("",!0)])])])])]),l("div",$s,[e[98]||(e[98]=l("div",{class:"sub-title"},"行驶证副页",-1)),l("div",xs,[l("div",Cs,[ue.value?(o(),v("div",Ss,[l("div",zs,[e[90]||(e[90]=l("div",{class:"kv-label"},"副页备注",-1)),l("div",Ls,[a(V,{modelValue:m.value.dl_attach_note,"onUpdate:modelValue":e[30]||(e[30]=n=>m.value.dl_attach_note=n),placeholder:"可选",clearable:"",class:"fv fv-input"},null,8,["modelValue"])])])])):U("",!0)]),l("div",Os,[l("div",Rs,[e[93]||(e[93]=l("span",null,"行驶证副页图片",-1)),w("driving_license_sub")>0?(o(),v("span",Es,[f(" （已就绪 "+$(w("driving_license_sub"))+" 张 ",1),e[91]||(e[91]=l("span",{class:"ready-dot","aria-hidden":"true"},null,-1)),e[92]||(e[92]=f("） ",-1))])):U("",!0)]),a(ne,{drag:"","auto-upload":!1,multiple:!1,limit:1,"show-file-list":!1,"file-list":y.value.driving_license_sub,disabled:j("driving_license_sub")||z.value||R.value>0,"on-change":n=>_e("driving_license_sub",n),"on-exceed":()=>q("driving_license_sub"),accept:"image/*",class:"upload-box upload-one"},{default:d(()=>[C("driving_license_sub")?(o(),v("div",Is,[a(fe,{src:C("driving_license_sub")?.url,"preview-src-list":ee("driving_license_sub"),fit:"contain",class:"one-img"},null,8,["src","preview-src-list"]),e[94]||(e[94]=l("div",{class:"one-mask"},[l("div",{class:"one-mask-text"},"已上传，删除后可重新上传")],-1))])):(o(),v("div",As,[...e[95]||(e[95]=[l("div",{class:"empty-center"},[l("div",{class:"empty-title"},"拖拽图片到此处"),l("div",{class:"empty-sub"},"或点击选择文件")],-1)])]))]),_:1},8,["file-list","disabled","on-change","on-exceed"]),M("driving_license_sub")>0?(o(),v("div",Ms," 正在上传："+$(M("driving_license_sub"))+" 个文件…（上传完成后才能提交） ",1)):U("",!0),l("div",Ns,[l("div",Ts,[w("driving_license_sub")>0?(o(),v(P,{key:0},[l("span",null,"已就绪："+$(w("driving_license_sub"))+" 张",1),e[96]||(e[96]=l("span",{class:"ready-dot","aria-hidden":"true"},null,-1))],64)):(o(),v("span",Ds,"未上传"))]),l("div",Bs,[(y.value.driving_license_sub||[]).length?(o(),x(r,{key:0,size:"small",type:"danger",link:"",class:"slot-remove",disabled:z.value||R.value>0,onClick:e[31]||(e[31]=n=>le("driving_license_sub"))},{default:d(()=>[...e[97]||(e[97]=[f(" 移除 ",-1)])]),_:1},8,["disabled"])):U("",!0)])])])])])])]),_:1}),a(J,{shadow:"never",class:"section-card"},{header:d(()=>[...e[99]||(e[99]=[l("div",{class:"section-header"},[l("div",{class:"section-title"},"备用图")],-1)])]),default:d(()=>[l("div",Fs,[e[102]||(e[102]=l("span",null,"相关图片（可多张）",-1)),w("related")>0?(o(),v("span",Ps,[f(" （已就绪 "+$(w("related"))+" 张 ",1),e[100]||(e[100]=l("span",{class:"ready-dot","aria-hidden":"true"},null,-1)),e[101]||(e[101]=f("） ",-1))])):U("",!0)]),a(ne,{class:"upload-card upload-wide","file-list":y.value.related,"list-type":"picture-card",limit:20,multiple:!0,"auto-upload":!1,drag:"",accept:"image/*",disabled:z.value||R.value>0,"on-change":(n,Ue)=>Oe("related",n,Ue),"on-remove":(n,Ue)=>Te("related",n,Ue)},{default:d(()=>[l("div",Gs,[a(me,{class:"upload-plus"},{default:d(()=>[a(te(gl))]),_:1}),e[103]||(e[103]=l("div",{class:"upload-text"},"拖拽图片到此处",-1))])]),_:1},8,["file-list","disabled","on-change","on-remove"]),M("related")>0?(o(),v("div",js," 正在上传："+$(M("related"))+" 个文件…（上传完成后才能提交） ",1)):U("",!0)]),_:1}),a(J,{shadow:"never",class:"section-card"},{header:d(()=>[...e[104]||(e[104]=[l("div",{class:"section-header"},[l("div",{class:"section-title"},"更多字段（可选）")],-1)])]),default:d(()=>[a(V,{modelValue:ie.value,"onUpdate:modelValue":e[32]||(e[32]=n=>ie.value=n),type:"textarea",rows:6,placeholder:'可粘贴 JSON（会合并进 dynamic_data），例如：{ "custom_key": "value" }',class:"fv"},null,8,["modelValue"])]),_:1}),l("div",qs,[a(r,{onClick:De,disabled:z.value||R.value>0},{default:d(()=>[...e[105]||(e[105]=[f("清空",-1)])]),_:1},8,["disabled"]),a(r,{type:"primary",loading:z.value,disabled:R.value>0,onClick:Ae},{default:d(()=>[...e[106]||(e[106]=[f("提交",-1)])]),_:1},8,["loading","disabled"])])])}}},Ys=al(Hs,[["__scopeId","data-v-dc285f2f"]]),Js={class:"page"},Ws={class:"page-header"},Qs={class:"page-header-right"},Xs={class:"card-title"},Zs={class:"card-title-right"},Ks={class:"upload-mode"},ea={class:"filters"},la={class:"upload-grid"},ta={class:"slot-head"},sa={class:"slot-name"},aa={class:"slot-tip"},ia={key:0,class:"one-wrap"},oa={key:1,class:"upload-empty"},na={key:0,class:"preview-wall"},da={key:1,class:"preview-img preview-empty"},ra={class:"preview-meta"},ua=["title"],ca={class:"preview-status"},va={key:2,class:"uploading-tip"},_a={class:"slot-foot"},pa={class:"slot-foot-left"},ma={key:1,class:"muted"},fa={class:"slot-foot-right"},ga={class:"drawer-header"},ka={class:"drawer-actions"},ba={class:"table-scroll"},ya=["onClick","title"],ha={key:1},Xe="order_import_upload_mode",wa=" - ",Va={__name:"OrderImport",setup(je){const se=Ze(),ae=fl(),z=g("import");function xe(){se.replace({path:"/orders/import",query:{tab:z.value}})}Ge(()=>{const t=ae.query?.tab;(t==="manual"||t==="import")&&(z.value=t)});function O(){const t=ae.query?.from;if(typeof t=="string"&&t.startsWith("/")){se.push(t);return}if(window.history.length>1){se.back();return}se.push({path:"/orders/all"})}const Z=g("smart");function Ce(){const t=localStorage.getItem(Xe);(t==="smart"||t==="direct"||t==="stable")&&(Z.value=t)}function ye(){try{localStorage.setItem(Xe,Z.value)}catch{}}Ce();function G(t){return/[\u4e00-\u9fa5]/.test(String(t||""))}function Se(t){const s=t?.response?.data?.detail||t?.response?.data?.message||t?.message||"";return String(s||"")}function K(t,s="操作失败，请稍后重试"){const u=t?.response?.data?.detail,c=Se(t),b=t?.response?.status,L=String(t?.code||"");if(typeof u=="string"&&u&&G(u))return u;if(c&&G(c))return c;const N=c.toLowerCase();return N.includes("network error")||N.includes("failed to fetch")?"网络异常，请检查网络连接":N.includes("timeout")||L.includes("ECONNABORTED")?"请求超时，请稍后重试":N.includes("cors")?"跨域受限或网络拦截，请切换网络后重试":b===401?"登录状态已失效，请重新登录":b===403?"无权限执行该操作":b>=500?"服务器异常，请稍后重试":s}function m(t){const s=Se(t).toLowerCase();return s.includes("failed to fetch")||s.includes("network error")||s.includes("err_")||s.includes("cors")||s.includes("代理")||s.includes("vpn")||s.includes("hint=浏览器请求可能走了本机代理")||s.includes("127.0.0.1:7890")}async function ie(){try{return await bl.confirm(`上传可能被当前网络环境拦截（常见于 VPN/代理/公司网关）。

建议切换到【稳定模式上传】继续，无需任何设置。`,"上传失败（网络拦截）",{confirmButtonText:"切换为稳定模式",cancelButtonText:"继续直传重试",type:"warning",center:!0,distinguishCancelAndClose:!0}),Z.value="stable",ye(),!0}catch{return!1}}const re=g(null),I=g({customer_group_id:null,channel_group_id:null}),ue={customer_group_id:[{required:!0,message:"客户必选",trigger:"change"}],channel_group_id:[{required:!0,message:"渠道必选",trigger:"change"}]},oe=Ne(()=>!!I.value.customer_group_id&&!!I.value.channel_group_id),ze=g([]),Le=g([]),j=g(!1);function q(t,s=[]){if(!t||typeof t!="object")return"";for(const u of s){const c=t?.[u];if(c==null)continue;const b=String(c).trim();if(b)return b}return""}function y(t,s,u=""){const c=String(t||"").trim(),b=String(s||"").trim();return c&&b?`${c}${wa}${b}`:c||b||String(u||"").trim()||"-"}function W(t){const s=q(t,["customer_code","customerCode","code","group_code","groupCode"]),u=q(t,["customer_name","customerName","name","group_name","groupName"]),c=q(t,["group_name","groupName","customer_name","customerName"])||(t?.id!=null?String(t.id):"");return y(s,u,c)}function R(t){const s=q(t,["channel_code","channelCode","code","group_code","groupCode"]),u=q(t,["channel_name","channelName","name","group_name","groupName"]),c=q(t,["group_name","groupName","channel_name","channelName"])||(t?.id!=null?String(t.id):"");return y(s,u,c)}async function Q(){j.value=!0;try{const[t,s]=await Promise.all([Ke(),el()]);ze.value=t?.data?.items||t?.data||[],Le.value=s?.data?.items||s?.data||[]}catch(t){console.error(t),de.error({title:"加载失败",message:K(t,"加载客户/渠道群失败，请稍后重试"),duration:4e3})}finally{j.value=!1}}const B=[{key:"vehicle_cert",label:"合格证",multiple:!1},{key:"idcard_front",label:"身份证正面",multiple:!1},{key:"idcard_back",label:"身份证反面",multiple:!1},{key:"driving_license_main",label:"行驶证主页",multiple:!1},{key:"driving_license_sub",label:"行驶证副页",multiple:!1},{key:"related",label:"相关图片(多张)",multiple:!0}],S=g(B.reduce((t,s)=>(t[s.key]=[],t),{})),H=g(!1),F=g({}),A=g({}),Y=g(0),C=g({}),ee=g("");let ce=null,ve=0;function le(t){try{return Date.parse(t)}catch{return 0}}async function _e(){const t=Date.now();if(ce&&ve&&t+12e4<ve)return ce;const u=(await Pe.get("/orders/bos-sts"))?.data;if(!u?.accessKeyId||!u?.secretAccessKey||!u?.sessionToken)throw new Error("获取上传凭证失败：返回数据不完整");return ce=u,ee.value=u.bosHost||"",ve=le(u.expiration)||t+600*1e3,ce}function Oe(t){return!!B.find(u=>u.key===t)?.multiple}function Te(t){return B.find(s=>s.key===t)?.label||t}function he(t){return Oe(t)?!1:(S.value[t]||[]).length>=1}function w(t){D.warning(`${Te(t)}：请先删除当前图片，再上传新图片`)}function M(t){const s=S.value[t]||[];return s.length?s[0]:null}function Re(t){const s=t?.raw;if(s&&!t.url){const u=URL.createObjectURL(s);t.url=u,C.value[t.uid]=u}}function De(t,s){if(!t||!s)return;const u=t.uid,c=u?C.value[u]:t.url;if(c){try{URL.revokeObjectURL(c)}catch{}u&&delete C.value[u]}const b=URL.createObjectURL(s);t.raw=s,t.url=b,u&&(C.value[u]=b)}function Ee(t){const s=S.value[t]||[];for(const u of s){const c=u?.uid;if(!c)continue;F.value[c]&&delete F.value[c],A.value[c]&&delete A.value[c];const b=C.value[c];if(b){try{URL.revokeObjectURL(b)}catch{}delete C.value[c]}}S.value[t]=[]}function Ie(t,s){if(!Oe(t)){if(he(t)){w(t);return}Ee(t),Re(s),S.value[t]=[s],Ae(t,s).catch(c=>{console.error(c),de.error({title:"上传失败",message:K(c,"上传失败，请稍后重试"),duration:5e3})});return}const u=S.value[t]||[];u.find(c=>c.uid===s.uid)||u.push(s),S.value[t]=u,Re(s),Ae(t,s).catch(c=>{console.error(c),de.error({title:"上传失败",message:K(c,"上传失败，请稍后重试"),duration:5e3})})}async function Ae(t,s){const u=s?.raw;if(u&&!F.value[s.uid]){Y.value+=1,A.value[s.uid]={status:"uploading"};try{let c=u;try{const N=await wl({file:u,slotKey:t});N?.file&&(c=N.file,De(s,c),N?.note&&console.info("[image-preprocess]",N.note))}catch{c=u}if(Z.value==="stable"){const E=(await Qe({slot_key:t,file:c}))?.data;F.value[s.uid]={slot_key:t,md5:E?.md5,storage_key:E?.storage_key,etag:E?.etag||"",size:E?.size||c.size||0,content_type:E?.content_type||c.type||"application/octet-stream",original_name:E?.original_name||c.name||"file",preview_url:E?.preview_url||""},A.value[s.uid]={status:"done"};return}const b=await _e();if(!ee.value)throw new Error("上传配置缺失：bosHost 为空");const L=await sl({bosHost:ee.value,slotKey:t,file:c,sts:b});F.value[s.uid]={slot_key:t,...L,size:L?.size||c.size||0,content_type:L?.content_type||c.type||"application/octet-stream",original_name:L?.original_name||c.name||"file"},A.value[s.uid]={status:"done"}}catch(c){if(Z.value==="smart"&&m(c)&&await ie())try{const L=s?.raw||u,E=(await Qe({slot_key:t,file:L}))?.data;F.value[s.uid]={slot_key:t,md5:E?.md5,storage_key:E?.storage_key,etag:E?.etag||"",size:E?.size||L.size||0,content_type:E?.content_type||L.type||"application/octet-stream",original_name:E?.original_name||L.name||"file",preview_url:E?.preview_url||""},A.value[s.uid]={status:"done"};return}catch(L){throw A.value[s.uid]={status:"error",msg:K(L,"上传失败，请稍后重试")},L}throw A.value[s.uid]={status:"error",msg:K(c,"上传失败，请稍后重试")},c}finally{Y.value-=1}}}function Me(t){const s=S.value[t]||[];let u=0;for(const c of s)F.value[c.uid]&&(u+=1);return u}function i(t){const s=S.value[t]||[];let u=0;for(const c of s)A.value[c.uid]?.status==="uploading"&&(u+=1);return u}const e=Ne(()=>B.some(t=>(S.value[t.key]||[]).length>0));function r(){const t=[];for(const s of B){const u=S.value[s.key]||[];for(const c of u){const b=F.value[c.uid];b&&t.push(b)}}return t}function p(){for(const t of Object.keys(C.value))try{URL.revokeObjectURL(C.value[t])}catch{}C.value={},S.value=B.reduce((t,s)=>(t[s.key]=[],t),{}),F.value={},A.value={}}function h(t){return(S.value[t]||[]).map(u=>u.url).filter(Boolean)}async function we(){if(!oe.value){D.warning("客户和渠道为必选项，请先选择后再提交");try{await re.value?.validate?.()}catch{}return}if(!e.value){D.warning("请至少上传一张图片");return}if(Y.value>0){D.warning("还有文件在上传中，请稍后再提交");return}const t=r();if(!t.length){D.warning("未检测到已上传文件（可能上传失败）");return}H.value=!0;try{const s={},u=await ll({module:"order",dynamic_data:s,customer_group_id:I.value.customer_group_id??void 0,channel_group_id:I.value.channel_group_id??void 0}),b=(u?.data?.data??u?.data??u)?.order_id;if(!b)throw new Error("创建订单失败：未获取到订单ID");await tl({order_id:b,images:t,dynamic_data:s,customer_group_id:I.value.customer_group_id??void 0,channel_group_id:I.value.channel_group_id??void 0}),p(),await J(),D.success(`订单 ${b} 已创建，OCR 识别任务已提交`)}catch(s){console.error(s),de.error({title:"提交失败",message:K(s,"提交失败，请稍后重试"),duration:5e3})}finally{H.value=!1}}const X=g(!1),Ve=g([]),pe=g(!1);async function J(){if(!pe.value){pe.value=!0;try{const s=(await Pe.get("/orders/ocr-tasks",{params:{limit:50}}))?.data;Ve.value=Array.isArray(s?.items)?s.items:Array.isArray(s)?s:[]}catch(t){console.error(t),de.error({title:"加载任务失败",message:K(t,"加载失败，请稍后重试"),duration:4e3})}finally{pe.value=!1}}}const me=Ne(()=>(Ve.value||[]).filter(s=>s?.status==="pending"||s?.status==="processing").length);function V(t){const s=String(t||"").trim();return s?G(s)?s:"识别失败（点击查看详情）":"-"}function fe(t){const s=String(t?.error_message||"").trim();s&&(G(s)||(console.warn("[OCR任务原始错误信息]",{taskId:t?.id,orderId:t?.order_id,error_message:s}),D.info("已在控制台输出任务原始错误信息")))}function ne(t){t&&se.push({path:`/orders/${t}`,query:{from:ae.fullPath}})}function n(){se.push({path:"/orders/unfinished",query:{from:ae.fullPath}})}function Ue(t){return t==="pending"?"排队中":t==="processing"?"识别中":t==="finished"?"已完成":t==="finished_with_errors"?"部分成功":t==="failed"?"失败":t==="skipped"?"已跳过":t||"-"}function il(t){return t==="finished"?"success":t==="finished_with_errors"?"warning":t==="failed"?"danger":t==="processing"?"warning":"info"}let $e=null;function ol(){$e||($e=window.setInterval(()=>{X.value&&J()},3e3))}function qe(){$e&&(window.clearInterval($e),$e=null)}return Vl(X,async t=>{t?(await J(),ol()):qe()},{immediate:!1}),Ge(async()=>{await Promise.all([Q(),J()])}),Ul(()=>{qe();for(const t of Object.keys(C.value))try{URL.revokeObjectURL(C.value[t])}catch{}C.value={}}),(t,s)=>{const u=k("el-button"),c=k("el-icon"),b=k("el-badge"),L=k("el-option"),N=k("el-select"),E=k("el-form-item"),He=k("el-col"),nl=k("el-row"),dl=k("el-form"),rl=k("el-alert"),ge=k("el-tag"),Ye=k("el-image"),Je=k("el-upload"),ul=k("el-card"),ke=k("el-table-column"),cl=k("el-progress"),vl=k("el-table"),_l=k("el-drawer"),We=k("el-tab-pane"),pl=k("el-tabs"),ml=$l("loading");return o(),v("div",Js,[l("div",Ws,[s[8]||(s[8]=l("h2",null,"导入 / 创建订单",-1)),l("div",Qs,[a(u,{size:"small",onClick:O},{default:d(()=>[...s[6]||(s[6]=[f("返回",-1)])]),_:1}),a(b,{value:me.value,hidden:me.value===0,max:99,class:"task-badge"},{default:d(()=>[a(u,{class:"task-btn",type:"primary",onClick:s[0]||(s[0]=_=>X.value=!0)},{default:d(()=>[a(c,{class:"task-icon"},{default:d(()=>[a(te(kl))]),_:1}),s[7]||(s[7]=f(" 图片识别任务 ",-1))]),_:1})]),_:1},8,["value","hidden"])])]),a(pl,{modelValue:z.value,"onUpdate:modelValue":s[5]||(s[5]=_=>z.value=_),class:"top-tabs",onTabChange:xe},{default:d(()=>[a(We,{label:"导入订单",name:"import"},{default:d(()=>[a(ul,{shadow:"never",class:"block-card"},{header:d(()=>[l("div",Xs,[s[12]||(s[12]=l("span",null,"创建订单（拖拽上传：MD5 去重 + 直传 BOS）",-1)),l("div",Zs,[l("div",Ks,[s[9]||(s[9]=l("span",{class:"upload-mode-label"},"上传模式",-1)),a(N,{modelValue:Z.value,"onUpdate:modelValue":s[1]||(s[1]=_=>Z.value=_),size:"small",style:{width:"160px"},onChange:ye},{default:d(()=>[a(L,{label:"智能（推荐）",value:"smart"}),a(L,{label:"直传（更快）",value:"direct"}),a(L,{label:"稳定（兼容VPN）",value:"stable"})]),_:1},8,["modelValue"])]),a(u,{size:"small",onClick:p,disabled:H.value||Y.value>0},{default:d(()=>[...s[10]||(s[10]=[f(" 清空图片 ",-1)])]),_:1},8,["disabled"]),a(u,{size:"small",type:"primary",loading:H.value,disabled:Y.value>0||!oe.value,onClick:we},{default:d(()=>[...s[11]||(s[11]=[f(" 提交 OCR 导入 ",-1)])]),_:1},8,["loading","disabled"])])])]),default:d(()=>[l("div",ea,[a(dl,{ref_key:"filtersFormRef",ref:re,model:I.value,rules:ue,"label-width":"80px",class:"filters-form"},{default:d(()=>[a(nl,{gutter:12},{default:d(()=>[a(He,{span:12},{default:d(()=>[a(E,{label:"客户群",prop:"customer_group_id"},{default:d(()=>[a(N,{modelValue:I.value.customer_group_id,"onUpdate:modelValue":s[2]||(s[2]=_=>I.value.customer_group_id=_),clearable:"",filterable:"",placeholder:"必选",style:{width:"100%"},loading:j.value,disabled:j.value},{default:d(()=>[(o(!0),v(P,null,be(ze.value,_=>(o(),x(L,{key:String(_.id),label:W(_),value:_.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","loading","disabled"])]),_:1})]),_:1}),a(He,{span:12},{default:d(()=>[a(E,{label:"渠道群",prop:"channel_group_id"},{default:d(()=>[a(N,{modelValue:I.value.channel_group_id,"onUpdate:modelValue":s[3]||(s[3]=_=>I.value.channel_group_id=_),clearable:"",filterable:"",placeholder:"必选",style:{width:"100%"},loading:j.value,disabled:j.value},{default:d(()=>[(o(!0),v(P,null,be(Le.value,_=>(o(),x(L,{key:String(_.id),label:R(_),value:_.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","loading","disabled"])]),_:1})]),_:1})]),_:1})]),_:1},8,["model"])]),Y.value>0?(o(),x(rl,{key:0,class:"upload-alert",type:"warning",closable:!1,"show-icon":"",title:"正在上传",description:`正在上传 ${Y.value} 个文件…（全部上传完成后才能提交）`},null,8,["description"])):U("",!0),l("div",la,[(o(),v(P,null,be(B,_=>l("div",{key:_.key,class:"slot-card"},[l("div",ta,[l("div",sa,$(_.label),1),l("div",aa,[a(ge,{size:"small",type:"info",effect:"plain"},{default:d(()=>[f($(_.multiple?"可多张":"单张"),1)]),_:2},1024)])]),_.multiple?(o(),v(P,{key:1},[a(Je,{drag:"","auto-upload":!1,multiple:!0,limit:20,"show-file-list":!1,"file-list":S.value[_.key],disabled:H.value||Y.value>0,"on-change":T=>Ie(_.key,T),accept:"image/*",class:"upload-box upload-multi"},{default:d(()=>[...s[15]||(s[15]=[l("div",{class:"upload-empty"},[l("div",{class:"empty-center"},[l("div",{class:"empty-title"},"拖拽图片到此处"),l("div",{class:"empty-sub"},"或点击选择文件（可多张）")])],-1)])]),_:1},8,["file-list","disabled","on-change"]),(S.value[_.key]||[]).length?(o(),v("div",na,[(o(!0),v(P,null,be(S.value[_.key],T=>(o(),v("div",{key:T.uid,class:"preview-item"},[T.url?(o(),x(Ye,{key:0,src:T.url,"preview-src-list":h(_.key),fit:"cover",class:"preview-img"},null,8,["src","preview-src-list"])):(o(),v("div",da)),l("div",ra,[l("div",{class:"preview-name",title:T.name},$(T.name),9,ua),l("div",ca,[A.value[T.uid]?.status==="uploading"?(o(),x(ge,{key:0,size:"small",type:"warning"},{default:d(()=>[...s[16]||(s[16]=[f(" 上传中 ",-1)])]),_:1})):A.value[T.uid]?.status==="done"?(o(),x(ge,{key:1,size:"small",type:"success"},{default:d(()=>[...s[17]||(s[17]=[f(" 已就绪 ",-1)])]),_:1})):A.value[T.uid]?.status==="error"?(o(),x(ge,{key:2,size:"small",type:"danger"},{default:d(()=>[...s[18]||(s[18]=[f(" 失败 ",-1)])]),_:1})):(o(),x(ge,{key:3,size:"small",type:"info",effect:"plain"},{default:d(()=>[...s[19]||(s[19]=[f(" 待上传 ",-1)])]),_:1}))])])]))),128))])):U("",!0)],64)):(o(),x(Je,{key:0,drag:"","auto-upload":!1,multiple:!1,limit:1,"show-file-list":!1,"file-list":S.value[_.key],disabled:he(_.key)||H.value||Y.value>0,"on-change":T=>Ie(_.key,T),"on-exceed":()=>w(_.key),accept:"image/*",class:"upload-box upload-one"},{default:d(()=>[M(_.key)?(o(),v("div",ia,[a(Ye,{src:M(_.key)?.url,"preview-src-list":h(_.key),fit:"contain",class:"one-img"},null,8,["src","preview-src-list"]),s[13]||(s[13]=l("div",{class:"one-mask"},[l("div",{class:"one-mask-text"},"已上传，删除后可重新上传")],-1))])):(o(),v("div",oa,[...s[14]||(s[14]=[l("div",{class:"empty-center"},[l("div",{class:"empty-title"},"拖拽图片到此处"),l("div",{class:"empty-sub"},"或点击选择文件")],-1)])]))]),_:2},1032,["file-list","disabled","on-change","on-exceed"])),i(_.key)>0?(o(),v("div",va," 正在上传："+$(i(_.key))+" 个文件…（上传完成后才能提交） ",1)):U("",!0),l("div",_a,[l("div",pa,[Me(_.key)>0?(o(),v(P,{key:0},[l("span",null,"已就绪："+$(Me(_.key))+" 张",1),s[20]||(s[20]=l("span",{class:"ready-dot","aria-hidden":"true"},null,-1))],64)):(o(),v("span",ma,"未上传"))]),l("div",fa,[(S.value[_.key]||[]).length?(o(),x(u,{key:0,size:"small",type:"danger",link:"",class:"slot-remove",disabled:H.value||Y.value>0,onClick:T=>Ee(_.key)},{default:d(()=>[...s[21]||(s[21]=[f(" 移除 ",-1)])]),_:1},8,["disabled","onClick"])):U("",!0)])])])),64))])]),_:1}),a(_l,{modelValue:X.value,"onUpdate:modelValue":s[4]||(s[4]=_=>X.value=_),direction:"rtl",size:"60%","with-header":!0},{header:d(()=>[l("div",ga,[s[24]||(s[24]=l("div",{class:"drawer-title"},"图片识别任务列表",-1)),l("div",ka,[a(u,{size:"small",loading:pe.value,onClick:J},{default:d(()=>[...s[22]||(s[22]=[f("刷新",-1)])]),_:1},8,["loading"]),a(u,{size:"small",onClick:n},{default:d(()=>[...s[23]||(s[23]=[f("去未完成订单",-1)])]),_:1})])])]),default:d(()=>[l("div",ba,[xl((o(),x(vl,{data:Ve.value,border:"",stripe:"",height:"calc(100vh - 140px)"},{default:d(()=>[a(ke,{prop:"id",label:"任务ID",width:"90"}),a(ke,{prop:"order_id",label:"订单ID",width:"90"}),a(ke,{label:"状态",width:"120"},{default:d(({row:_})=>[a(ge,{type:il(_.status)},{default:d(()=>[f($(Ue(_.status)),1)]),_:2},1032,["type"])]),_:1}),a(ke,{label:"进度",width:"180"},{default:d(({row:_})=>[a(cl,{percentage:_.progress||0,status:_.status==="failed"?"exception":_.status==="finished"?"success":"active"},null,8,["percentage","status"])]),_:1}),a(ke,{label:"错误信息"},{default:d(({row:_})=>[_?.error_message?(o(),v("span",{key:0,class:"task-error",onClick:T=>fe(_),title:G(_.error_message)?"":"点击查看详情"},$(V(_.error_message)),9,ya)):(o(),v("span",ha,"-"))]),_:1}),a(ke,{label:"查看",width:"140"},{default:d(({row:_})=>[a(u,{size:"small",onClick:T=>ne(_.order_id),disabled:!_.order_id},{default:d(()=>[...s[25]||(s[25]=[f("详情",-1)])]),_:1},8,["onClick","disabled"])]),_:1})]),_:1},8,["data"])),[[ml,pe.value]])])]),_:1},8,["modelValue"])]),_:1}),a(We,{label:"手动新建",name:"manual"},{default:d(()=>[a(Ys,{embedded:!0})]),_:1})]),_:1},8,["modelValue"])])}}},Ma=al(Va,[["__scopeId","data-v-121cc73a"]]);export{Ma as default};
