import{h as K}from"./http-DGyH82Tn.js";import{_ as be,u as me,R as h,T as we}from"./index-BFJc87xd.js";import{E as C,d as Ae}from"./vendor-element-plus-CtVxZ4Oy.js";import{r as k,c as p,Z as Ne,o as W,q as de,ay as M,G as y,y as m,H as s,z as E,P as u,J as U,x as L,O as ee,ac as ae,u as Se,L as G,M as te,I as Ee,aI as he}from"./vendor-vue-fFWwKrgY.js";import"./vendor-axios-C0Zqfgkc.js";import"./vendor-vue-router-CVyACjsp.js";import"./vendor-pinia-CMXa-Za0.js";import"./vendor-lodash-rvV0CIkQ.js";import"./vendor-DWCz07M-.js";import"./vendor-dates-DVKSwKij.js";function fe(r){try{const l=r?.data;return Array.isArray(l)?r:Array.isArray(l?.items)?(r.data=l.items,r):Array.isArray(l?.data)?(r.data=l.data,r):Array.isArray(l?.data?.items)?(r.data=l.data.items,r):(r.data=[],r)}catch{return r}}function B(r){return String(r??"").trim()}function Ce(){return K.get("/users/me")}function Me(){return K.get("/users/children").then(fe)}function Ve(r={}){return K.get("/users/managers",{params:{...r}}).then(fe)}function xe(r={}){const l=Number(r.role_id),v={username:B(r.username),password:B(r.password),role_id:Number.isNaN(l)?0:l,real_name:B(r.real_name)};return r.manager_id!==void 0&&(v.manager_id=r.manager_id),r.team_name!==void 0&&(v.team_name=r.team_name),Array.isArray(r.team_names)&&(v.team_names=r.team_names),K.post("/users",v)}function ke(r,l={}){const v=Number(r);if(!Number.isFinite(v)||v<=0)throw new Error("invalid userId");const N={};if(l.username!==void 0&&(N.username=B(l.username)),l.real_name!==void 0&&(N.real_name=B(l.real_name)),l.password!==void 0){const R=B(l.password);R&&(N.password=R)}return l.status!==void 0&&(N.status=l.status),l.manager_id!==void 0&&(N.manager_id=l.manager_id),l.team_name!==void 0&&(N.team_name=l.team_name),l.team_names!==void 0&&(N.team_names=l.team_names),K.put(`/users/${v}`,N)}function Re(r){const l=Number(r);if(!Number.isFinite(l)||l<=0)throw new Error("invalid userId");return K.delete(`/users/${l}`)}const Le={key:0,style:{"margin-left":"8px",color:"#999","font-size":"12px"}},Ue={key:0,style:{"margin-left":"8px",color:"#999","font-size":"12px"}},Ie={key:1,style:{"margin-left":"8px",color:"#999","font-size":"12px"}},Te={key:0,style:{"margin-left":"8px",color:"#999","font-size":"12px"}},De={key:1,style:{"margin-left":"8px",color:"#999","font-size":"12px"}},ze={class:"form-actions"},Fe={__name:"CreateUser",props:{mode:{type:String,default:"create"},initialUser:{type:Object,default:null},user:{type:Object,default:null}},emits:["success"],setup(r,{emit:l}){const v=r,N=l,R=k(null),O=k(!1),q=me(),_=p(()=>String(v.mode||"create").toLowerCase()==="edit"),I=p(()=>String(q.roleName||"").trim().toLowerCase()),V=p(()=>I.value===String(h.SUPER_ADMIN).toLowerCase()),T=p(()=>I.value===String(h.MANAGER).toLowerCase()),e=Ne({username:"",real_name:"",password:"",role_id:null,manager_id:null,team_names:[],team_name:null,status:1}),P=k({id:null,username:"",role_id:null}),j=k([]),H=k(!1),J=k([]),D=k(!1),g={MANAGER:2,SALES:3,FINANCE:4,MARKET:5},le={[String(h.SUPER_ADMIN).toLowerCase()]:[{label:"经理账号",value:g.MANAGER},{label:"业务账号",value:g.SALES},{label:"财务账号",value:g.FINANCE},{label:"市场账号",value:g.MARKET}],[String(h.MANAGER).toLowerCase()]:[{label:"业务账号",value:g.SALES},{label:"财务账号",value:g.FINANCE},{label:"市场账号",value:g.MARKET}]},Z=p(()=>le[I.value]||[]),i=p(()=>V.value),n=p(()=>Number(e.role_id)===g.MANAGER),f=p(()=>{const t=Number(e.role_id);return t===g.SALES||t===g.FINANCE||t===g.MARKET}),b=p(()=>V.value&&f.value),A=p(()=>V.value&&n.value),x=p(()=>f.value&&(T.value||V.value&&b.value));function ne(t){return t?Array.isArray(t)?t:[t]:[]}function z(t){const a=[];for(const c of ne(t)){const d=(c==null?"":String(c)).trim();d&&a.push(d)}return Array.from(new Set(a)).sort()}const X=p(()=>{if(!e.manager_id)return null;const t=Number(e.manager_id);return(j.value||[]).find(a=>Number(a.id)===t)||null}),F=p(()=>{if(!x.value)return[];if(T.value)return z(J.value||[]);if(V.value){const t=X.value;if(!t)return[];const a=z(t.team_names||[]),c=(t.team_name||"").trim();return z([...a,...c?[c]:[]])}return[]}),w=p(()=>!!(!F.value.length||V.value&&b.value&&!e.manager_id||F.value.length===1)),re=p(()=>{const t={username:[{required:!0,message:"请输入用户名",trigger:"blur"},{min:3,max:32,message:"长度在 3-32 个字符",trigger:"blur"}],real_name:[{required:!0,message:"请输入角色姓名",trigger:"blur"}],role_id:[{required:!0,message:"请选择角色",trigger:"change"}],status:[{required:!0,message:"请选择状态",trigger:"change"}]};return _.value?t.password=[{validator:(a,c,d)=>{const S=String(c??"").trim();return S&&S.length<6?d(new Error("至少 6 位密码")):d()},trigger:"blur"}]:t.password=[{required:!0,message:"请输入密码",trigger:"blur"},{min:6,message:"至少 6 位密码",trigger:"blur"}],b.value&&(t.manager_id=[{required:!0,message:"请选择归属经理",trigger:"change"}]),A.value&&(t.team_names=[{required:!0,type:"array",message:"请选择团队（可多选）",trigger:"change"}]),x.value&&F.value.length>0&&(t.team_name=[{required:!0,message:"请选择所属团队",trigger:"change"}]),t});async function se(){if(b.value){H.value=!0;try{const t=await Ve({status:1});j.value=t?.data||t||[]}catch(t){console.error(t),C.error(t?.response?.data?.detail||"加载经理列表失败")}finally{H.value=!1}}}async function Y(){if(!T.value||!x.value)return;const t=q.user||null,a=z([...t?.team_names||[],...t?.team_name?[t.team_name]:[]]);if(a.length){J.value=a;return}D.value=!0;try{const c=await Ce(),d=c?.data||c||{},S=z([...d.team_names||[],...d.team_name?[d.team_name]:[]]);J.value=S}catch(c){console.error(c),C.error(c?.response?.data?.detail||"加载当前账号团队失败")}finally{D.value=!1}}function Q(){const t=F.value||[];t.length===1&&(e.team_name=t[0])}function ce(){e.team_name=null,Q()}function _e(){_.value||(e.manager_id=null,e.team_name=null,e.team_names=[],b.value&&se(),x.value&&Y())}W(()=>b.value,t=>{t||(e.manager_id=null),t&&se()}),W(()=>A.value,t=>{t||(e.team_names=[])}),W(()=>x.value,t=>{t||(e.team_name=null),t&&(Y(),Q())}),W(()=>[e.manager_id,F.value.length],()=>{Q()});function pe(t){const a=String(t||"").trim().toLowerCase();return a===String(h.MANAGER).toLowerCase()?g.MANAGER:a===String(h.SALES).toLowerCase()?g.SALES:a===String(h.FINANCE).toLowerCase()?g.FINANCE:a===String(h.MARKET).toLowerCase()?g.MARKET:null}function ue(t){const a=t&&typeof t=="object"?t:null;if(!a)return;const c=pe(a.role_name);e.role_id=c,e.username=a.username||"",e.real_name=a.real_name||"",e.password="",e.status=Number.isFinite(Number(a.status))?Number(a.status):1,e.team_name=a.team_name||null;const d=Array.isArray(a.team_names)?[...a.team_names]:[],S=String(a.team_name||"").trim(),$=z([...d,...S?[S]:[]]);e.team_names=$,e.manager_id=a.manager_id||null,P.value={id:a.id??null,username:a.username||"",role_id:c},x.value&&(Y(),Q())}const oe=p(()=>v.initialUser||v.user||null);async function ve(){if(R.value)try{if(O.value=!0,await R.value.validate(),!Z.value.length&&!_.value){C.error("当前账号无可创建的角色类型");return}if(!_.value){const d=A.value&&Array.isArray(e.team_names)&&e.team_names.length?String(e.team_names[0]||"").trim():"";await xe({username:e.username,password:e.password,real_name:e.real_name,role_id:e.role_id,manager_id:b.value?e.manager_id:void 0,team_names:A.value?e.team_names:void 0,team_name:x.value?e.team_name:d||void 0}),C.success("创建成功"),N("success"),e.username="",e.real_name="",e.password="",e.role_id=null,e.manager_id=null,e.team_names=[],e.team_name=null,e.status=1,R.value?.clearValidate?.();return}const t=Number(P.value?.id);if(!Number.isFinite(t)||t<=0){C.error("缺少 user.id，无法保存");return}const a={real_name:e.real_name,status:Number(e.status)};i.value&&String(e.username||"")!==String(P.value.username||"")&&(a.username=e.username);const c=String(e.password||"").trim();c&&(a.password=c),A.value?(a.team_names=e.team_names,e.team_name&&(a.team_name=e.team_name),!a.team_name&&Array.isArray(e.team_names)&&e.team_names.length&&(a.team_name=String(e.team_names[0]||"").trim()||void 0)):x.value&&(a.team_name=e.team_name),b.value&&(a.manager_id=e.manager_id),await ke(t,a),C.success("保存成功"),N("success"),e.password="",R.value?.clearValidate?.()}catch(t){console.error(t);const a=t?.response?.data?.detail||t?.message||(_.value?"保存失败":"创建失败");C.error(a)}finally{O.value=!1}}return de(()=>{b.value&&se(),x.value&&Y(),Q(),_.value&&oe.value&&ue(oe.value)}),W(()=>oe.value,t=>{_.value&&t&&ue(t)},{deep:!0}),(t,a)=>{const c=M("el-input"),d=M("el-form-item"),S=M("el-option"),$=M("el-select"),ge=M("el-button"),ye=M("el-form");return m(),y(ye,{ref_key:"formRef",ref:R,model:e,rules:re.value,"label-width":"90px",autocomplete:"off"},{default:s(()=>[a[10]||(a[10]=E("input",{type:"text",style:{display:"none"},autocomplete:"off"},null,-1)),a[11]||(a[11]=E("input",{type:"password",style:{display:"none"},autocomplete:"new-password"},null,-1)),u(d,{label:"用户名",prop:"username"},{default:s(()=>[u(c,{modelValue:e.username,"onUpdate:modelValue":a[0]||(a[0]=o=>e.username=o),placeholder:"请输入登录账号",autocomplete:"off",disabled:_.value&&!i.value},null,8,["modelValue","disabled"]),_.value&&!i.value?(m(),L("div",Le," 当前角色无权限修改用户名 ")):U("",!0)]),_:1}),u(d,{label:"角色姓名",prop:"real_name"},{default:s(()=>[u(c,{modelValue:e.real_name,"onUpdate:modelValue":a[1]||(a[1]=o=>e.real_name=o),placeholder:"请输入业务员/财务姓名",autocomplete:"off"},null,8,["modelValue"])]),_:1}),u(d,{label:_.value?"密码(可选)":"密码",prop:"password"},{default:s(()=>[u(c,{modelValue:e.password,"onUpdate:modelValue":a[2]||(a[2]=o=>e.password=o),type:"password","show-password":"",autocomplete:"new-password",placeholder:_.value?"不修改请留空":"请输入登录密码"},null,8,["modelValue","placeholder"])]),_:1},8,["label"]),u(d,{label:"角色类型",prop:"role_id"},{default:s(()=>[u($,{modelValue:e.role_id,"onUpdate:modelValue":a[3]||(a[3]=o=>e.role_id=o),placeholder:"请选择角色类型",style:{width:"100%"},disabled:_.value,onChange:_e},{default:s(()=>[(m(!0),L(ee,null,ae(Z.value,o=>(m(),y(S,{key:o.value,label:o.label,value:o.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled"]),Z.value.length?U("",!0):(m(),L("div",Ue," 当前账号暂无可创建的下级角色 ")),_.value?(m(),L("div",Ie," 编辑模式不允许修改角色类型 ")):U("",!0)]),_:1}),_.value?(m(),y(d,{key:0,label:"状态",prop:"status"},{default:s(()=>[u($,{modelValue:e.status,"onUpdate:modelValue":a[4]||(a[4]=o=>e.status=o),style:{width:"100%"},placeholder:"请选择状态"},{default:s(()=>[u(S,{label:"启用",value:1}),u(S,{label:"禁用",value:0})]),_:1},8,["modelValue"])]),_:1})):U("",!0),A.value?(m(),y(d,{key:1,label:"团队",prop:"team_names"},{default:s(()=>[u($,{modelValue:e.team_names,"onUpdate:modelValue":a[5]||(a[5]=o=>e.team_names=o),multiple:"",filterable:"",clearable:"","collapse-tags":"","collapse-tags-tooltip":"",placeholder:"请选择团队（可多选）",style:{width:"100%"}},{default:s(()=>[(m(!0),L(ee,null,ae(Se(we),o=>(m(),y(S,{key:o,label:o,value:o},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),a[8]||(a[8]=E("div",{style:{"margin-left":"8px",color:"#999","font-size":"12px"}}," 经理账号必须分配团队（可多选） ",-1))]),_:1})):U("",!0),b.value?(m(),y(d,{key:2,label:"归属经理",prop:"manager_id"},{default:s(()=>[u($,{modelValue:e.manager_id,"onUpdate:modelValue":a[6]||(a[6]=o=>e.manager_id=o),placeholder:"请选择归属经理",filterable:"",clearable:"",style:{width:"100%"},loading:H.value,onChange:ce},{default:s(()=>[(m(!0),L(ee,null,ae(j.value,o=>(m(),y(S,{key:o.id,label:`${o.real_name||"-"}（${o.username}）`,value:o.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","loading"]),a[9]||(a[9]=E("div",{style:{"margin-left":"8px",color:"#999","font-size":"12px"}}," 超级账号创建业务/财务/市场必须挂在某个经理名下 ",-1))]),_:1})):U("",!0),x.value?(m(),y(d,{key:3,label:"所属团队",prop:"team_name"},{default:s(()=>[u($,{modelValue:e.team_name,"onUpdate:modelValue":a[7]||(a[7]=o=>e.team_name=o),placeholder:"请选择所属团队",filterable:"",clearable:"",style:{width:"100%"},disabled:w.value,loading:D.value},{default:s(()=>[(m(!0),L(ee,null,ae(F.value,o=>(m(),y(S,{key:o,label:o,value:o},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled","loading"]),V.value&&b.value?(m(),L("div",Te," 团队选项来自“所选归属经理”的团队集合 ")):T.value?(m(),L("div",De," 团队选项来自“当前经理账号创建时分配的团队集合” ")):U("",!0)]),_:1})):U("",!0),u(d,null,{default:s(()=>[E("div",ze,[u(ge,{type:"primary",loading:O.value,onClick:ve},{default:s(()=>[G(te(_.value?"保存":"创建"),1)]),_:1},8,["loading"])])]),_:1})]),_:1},8,["model","rules"])}}},ie=be(Fe,[["__scopeId","data-v-61b5496c"]]),Ge={style:{display:"flex","justify-content":"space-between","align-items":"center"}},$e={style:{display:"flex",gap:"12px","align-items":"center"}},Oe={class:"table-scroll",style:{"margin-top":"15px"}},Xe={__name:"UserList",setup(r){const l=me(),v=p(()=>String(l.roleName||"").trim().toLowerCase()),N=p(()=>v.value===h.SUPER_ADMIN||v.value===h.MANAGER),R=p(()=>v.value===h.SUPER_ADMIN||v.value===h.MANAGER),O=p(()=>v.value===h.SUPER_ADMIN||v.value===h.MANAGER),q=k([]),_=k(!1),I=k(!1),V=k(!1),T=k(null);function e(i){const n=Array.isArray(i?.team_names)?i.team_names:[],f=[...new Set(n.map(A=>String(A||"").trim()).filter(Boolean))];return f.length?f.join("、"):String(i?.team_name||"").trim()||"-"}function P(i){const n=Number(l.userId||l.user?.id||l.id||0),f=Number(i?.id||i?.user_id||0);return!n||!f?!1:n===f}function j(){if(!N.value){C.error("无权限");return}I.value=!0}function H(i){if(!R.value){C.error("无权限");return}i?.id&&(T.value={...i||{}},V.value=!0)}function J(i){const n=i?.data??i??{};if(Array.isArray(n))return n;const f=n?.items??n?.data?.items??n?.data;return Array.isArray(f)?f:[]}async function D(){_.value=!0;try{const i=await Me();q.value=J(i)}catch(i){console.error(i),C.error(i?.response?.data?.detail||"加载账号失败")}finally{_.value=!1}}async function g(){I.value=!1,await D()}async function le(){V.value=!1,T.value=null,await D()}async function Z(i){if(!O.value){C.error("无权限");return}const n=Number(i?.id);if(n){if(P(i)){C.warning("不能删除当前登录账号");return}try{await Ae.confirm(`确认删除账号：${i?.real_name||i?.username||n}？删除后无法恢复`,"删除确认",{type:"warning",confirmButtonText:"删除",cancelButtonText:"取消"}),await Re(n),C.success("删除成功"),await D()}catch(f){if(f==="cancel"||f==="close")return;console.error(f),C.error(f?.response?.data?.detail||f?.message||"删除失败")}}}return de(()=>{D()}),(i,n)=>{const f=M("el-button"),b=M("el-tooltip"),A=M("el-table-column"),x=M("el-tag"),ne=M("el-table"),z=M("el-empty"),X=M("el-dialog"),F=he("loading");return m(),L("div",null,[E("div",Ge,[n[4]||(n[4]=E("h2",null,"子账号管理",-1)),E("div",$e,[N.value?(m(),y(f,{key:1,type:"primary",onClick:j},{default:s(()=>[...n[3]||(n[3]=[G(" 创建子账号 ",-1)])]),_:1})):(m(),y(b,{key:0,content:"无权限",placement:"top"},{default:s(()=>[E("span",null,[u(f,{type:"primary",disabled:""},{default:s(()=>[...n[2]||(n[2]=[G("创建子账号",-1)])]),_:1})])]),_:1}))])]),E("div",Oe,[Ee((m(),y(ne,{data:q.value,stripe:"","row-key":"id",fit:!0},{default:s(()=>[u(A,{prop:"team_name",label:"团队","min-width":"180","show-overflow-tooltip":""},{default:s(({row:w})=>[E("span",null,te(e(w)),1)]),_:1}),u(A,{prop:"username",label:"账号","min-width":"180","show-overflow-tooltip":""}),u(A,{prop:"real_name",label:"真实姓名","min-width":"180","show-overflow-tooltip":""},{default:s(({row:w})=>[E("span",null,te(w?.real_name||"-"),1)]),_:1}),u(A,{prop:"role_name",label:"角色","min-width":"160","show-overflow-tooltip":""}),u(A,{label:"在线状态","min-width":"140"},{default:s(({row:w})=>[u(x,{type:w.is_online?"success":"info"},{default:s(()=>[G(te(w.is_online?"在线":"离线"),1)]),_:2},1032,["type"])]),_:1}),u(A,{label:"操作",width:"220",align:"center"},{default:s(({row:w})=>[R.value?(m(),y(f,{key:1,size:"small",onClick:re=>H(w)},{default:s(()=>[...n[6]||(n[6]=[G("编辑",-1)])]),_:1},8,["onClick"])):(m(),y(b,{key:0,content:"无权限",placement:"top"},{default:s(()=>[E("span",null,[u(f,{size:"small",disabled:""},{default:s(()=>[...n[5]||(n[5]=[G("编辑",-1)])]),_:1})])]),_:1})),O.value?(m(),y(f,{key:3,size:"small",type:"danger",disabled:P(w),onClick:re=>Z(w)},{default:s(()=>[...n[8]||(n[8]=[G(" 删除 ",-1)])]),_:1},8,["disabled","onClick"])):(m(),y(b,{key:2,content:"无权限",placement:"top"},{default:s(()=>[E("span",null,[u(f,{size:"small",type:"danger",disabled:""},{default:s(()=>[...n[7]||(n[7]=[G("删除",-1)])]),_:1})])]),_:1}))]),_:1})]),_:1},8,["data"])),[[F,_.value]])]),!_.value&&!q.value.length?(m(),y(z,{key:0,description:"暂无子账号",style:{"margin-top":"20px"}})):U("",!0),u(X,{modelValue:I.value,"onUpdate:modelValue":n[0]||(n[0]=w=>I.value=w),title:"创建子账号",width:"420px","destroy-on-close":""},{default:s(()=>[u(ie,{mode:"create",onSuccess:g})]),_:1},8,["modelValue"]),u(X,{modelValue:V.value,"onUpdate:modelValue":n[1]||(n[1]=w=>V.value=w),title:"编辑账号",width:"420px","destroy-on-close":""},{default:s(()=>[u(ie,{mode:"edit","initial-user":T.value,onSuccess:le},null,8,["initial-user"])]),_:1},8,["modelValue"])])}}};export{Xe as default};
