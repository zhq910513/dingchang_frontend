import{r as x,c as ct,o as dt,q as ut,x as v,P as p,z as s,H as y,ay as E,D as ft,y as _,J as R,L as S,M as h,u as m,O as tt,ac as et,C as nt,X as at,G as Q,ap as mt}from"./vendor-vue-fFWwKrgY.js";import{h as Z}from"./http-CBIyYC5i.js";import{E as P,b as F,d as _t}from"./vendor-element-plus-CtVxZ4Oy.js";import{_ as gt}from"./index-C11rPtdm.js";import"./vendor-axios-C0Zqfgkc.js";import"./vendor-lodash-rvV0CIkQ.js";import"./vendor-DWCz07M-.js";import"./vendor-dates-DVKSwKij.js";import"./vendor-vue-router-CVyACjsp.js";import"./vendor-pinia-CMXa-Za0.js";function pt(e){const o={};for(const[l,n]of Object.entries(e||{}))n!==void 0&&(o[l]=n);return o}function ot(e){const o=String(e||"").trim();if(!o)throw new Error("aiAssistant api: invalid session_id");return o}function yt(){return Z.get("/ai-assistant/sessions")}function vt(e){return Z.get(`/ai-assistant/sessions/${encodeURIComponent(ot(e))}/history`)}function wt(e){return Z.delete(`/ai-assistant/sessions/${encodeURIComponent(ot(e))}`)}function ht(e={}){return Z.post("/ai-assistant/chat",pt({session_id:e.session_id?String(e.session_id).trim():void 0,message:String(e.message||"").trim(),history:Array.isArray(e.history)?e.history:[],context:e.context&&typeof e.context=="object"?e.context:{},stream:!1}))}async function St({session_id:e,message:o,history:l=[],context:n={},onEvent:g,signal:u}={}){const a=sessionStorage.getItem("sessionToken")||"",k=await fetch("/api/ai-assistant/chat/stream",{method:"POST",headers:{"Content-Type":"application/json",...a?{"X-Session-Token":a}:{}},body:JSON.stringify({session_id:e?String(e).trim():void 0,message:String(o||"").trim(),history:Array.isArray(l)?l:[],context:n&&typeof n=="object"?n:{},stream:!0}),signal:u});if(!k.ok||!k.body){let I=`HTTP ${k.status}`;try{const T=await k.text();T&&(I=T)}catch{}throw new Error(I)}const b=k.body.getReader(),C=new TextDecoder("utf-8");let w="";for(;;){const{done:I,value:T}=await b.read();if(I)break;w+=C.decode(T,{stream:!0});let L;for(;(L=w.indexOf(`

`))>=0;){const V=w.slice(0,L);w=w.slice(L+2);const U=V.split(`
`);for(const W of U){const j=String(W||"").trim();if(!j.startsWith("data:"))continue;const f=j.slice(5).trim();if(f)try{const A=JSON.parse(f);typeof g=="function"&&g(A)}catch{typeof g=="function"&&g({type:"raw",raw:f})}}}}}function kt(e){return String(e||"").trim()}function At(e){const o=kt(e);if(!o)return{kind:"empty"};if(o==="新一单"||o.toLowerCase()==="/new")return{kind:"action",action:"new_session",text:o};const l=o.match(/^(.+?)\s*报价$/);if(l){const n=String(l[1]||"").trim();if(n)return{kind:"quote",action:"quote",platform_hint:n,text:o}}return{kind:"text",text:o}}function it(e){return/[\u4e00-\u9fa5]/.test(String(e||""))}function G(e,o="操作失败，请稍后重试"){const l=e?.response?.data?.detail,n=e?.response?.data?.message||e?.message||"";if(typeof l=="string"&&l&&it(l))return l;if(typeof n=="string"&&n&&it(n))return n;const g=e?.response?.status;return g===401?"登录状态已失效，请重新登录":g===403?"无权限执行该操作":g>=500?"服务器异常，请稍后重试":o}function bt(e){const o=e?.data?.data??e?.data??{};return(Array.isArray(o?.items)?o.items:[]).map(n=>({session_id:n.session_id,title:n.title||"新会话",created_at:n.created_at||"",updated_at:n.updated_at||"",last_message_preview:n.last_message_preview||"",message_count:n.message_count??0}))}function xt(e){const o=e?.data?.data??e?.data??{};return(Array.isArray(o?.items)?o.items:[]).map((n,g)=>({id:`${n.created_at||"t"}_${g}`,role:n.role||"assistant",content:n.content||"",created_at:n.created_at||"",metadata:n.metadata||{}}))}function Ct(){const e=x(!1),o=x(!1),l=x(!1),n=x(!1),g=x([]),u=x(""),a=x([]),k=x("");let b=null;async function C(){o.value=!0;try{const f=await yt();g.value=bt(f)}catch(f){F.error({title:"会话列表加载失败",message:G(f,"加载会话列表失败"),duration:4e3})}finally{o.value=!1}}async function w(f){const A=String(f||u.value||"").trim();if(!A){a.value=[];return}l.value=!0;try{const D=await vt(A);u.value=A,a.value=xt(D)}catch(D){F.error({title:"历史消息加载失败",message:G(D,"加载历史消息失败"),duration:4e3}),a.value=[]}finally{l.value=!1}}async function I(){e.value=!0;try{await C(),g.value.length>0?await w(g.value[0].session_id):(u.value="",a.value=[{id:`local_${Date.now()}`,role:"system",content:"伪AI助手已就绪。你可以直接问：查订单 / 查财务 / 某字段是什么意思 / 平台A 报价",created_at:new Date().toISOString(),metadata:{}}])}finally{e.value=!1}}function T(f){a.value.push({id:`local_${Date.now()}_${Math.random().toString(36).slice(2,8)}`,...f})}async function L(f){if(f){if(n.value&&b)try{b.abort()}catch{}await w(f)}}async function V(){u.value="",a.value=[{id:`local_${Date.now()}`,role:"system",content:"已新建会话（本地态）。发送第一条消息后后端会生成 session_id。",created_at:new Date().toISOString(),metadata:{}}],P.success("已新建会话")}async function U(f){try{await wt(f),String(u.value)===String(f)&&(u.value="",a.value=[]),await C(),P.success("会话已删除")}catch(A){F.error({title:"删除失败",message:G(A,"删除会话失败"),duration:4e3})}}async function W(f,{useStream:A=!0,pageContext:D={}}={}){const M=At(f);if(M.kind==="empty"){P.warning("请输入内容");return}if(M.kind==="action"&&M.action==="new_session"){await V();return}const q=M.text;T({role:"user",content:q,created_at:new Date().toISOString(),metadata:{}});const O=`assistant_pending_${Date.now()}`;T({id:O,role:"assistant",content:"",created_at:new Date().toISOString(),metadata:{status:"sending"}}),n.value=!0,k.value=M.kind==="quote"?"已识别报价指令，正在处理…":"正在处理…";try{if(!A){const d=await ht({session_id:u.value||void 0,message:q,context:D}),r=d?.data?.data??d?.data??{},H=a.value.findIndex(c=>c.id===O);H>=0&&(a.value[H]={...a.value[H],content:r.reply||"",metadata:{...a.value[H].metadata,status:r.ok?"success":"error",trace_id:r.trace_id,intent:r.intent,confidence:r.confidence,actions:r.actions||[],error:r.error||null}}),r.session_id&&(u.value=r.session_id),r.ok||F.warning({title:"AI助手返回异常",message:r?.error?.message||"请求处理失败",duration:4e3}),await C(),u.value&&await w(u.value);return}const N=new AbortController;b=N;let $={trace_id:"",intent:"",confidence:0,actions:[]};await St({session_id:u.value||void 0,message:q,context:D,signal:N.signal,onEvent:d=>{const r=a.value.findIndex(H=>H.id===O);if(!(r<0)){if(d.type==="meta"){d.session_id&&(u.value=d.session_id),a.value[r].metadata={...a.value[r].metadata||{},trace_id:d.trace_id||"",model:d.model||"",status:"streaming"};return}if(d.type==="delta"){a.value[r].content=(a.value[r].content||"")+String(d.content||""),a.value[r].metadata={...a.value[r].metadata||{},status:"streaming"};return}if(d.type==="done"){$={trace_id:d.trace_id||"",intent:d.intent||"",confidence:d.confidence||0,actions:Array.isArray(d.actions)?d.actions:[]},a.value[r].metadata={...a.value[r].metadata||{},...$,status:"success",cost_ms:d.cost_ms||0};return}d.type==="error"&&(a.value[r].content=d.message||"AI助手流式处理失败",a.value[r].metadata={...a.value[r].metadata||{},status:"error",error_code:d.code||"INTERNAL_ERROR"})}}}),await C(),u.value&&await w(u.value)}catch(N){const $=a.value.findIndex(d=>d.id===O);$>=0&&(a.value[$]={...a.value[$],content:G(N,"发送失败，请稍后重试"),metadata:{...a.value[$].metadata||{},status:"error"}}),F.error({title:"发送失败",message:G(N,"发送失败，请稍后重试"),duration:4e3})}finally{k.value="",n.value=!1,b=null}}const j=ct(()=>g.value.find(A=>A.session_id===u.value)?.title||(u.value?"当前会话":"新会话"));return{loadingInit:e,loadingSessions:o,loadingHistory:l,sending:n,sessions:g,currentSessionId:u,currentSessionTitle:j,messages:a,processHint:k,ensureInit:I,refreshSessions:C,loadHistory:w,switchSession:L,createNewSessionLocal:V,removeSession:U,sendMessage:W}}const It={class:"ai-page"},Tt={class:"head-row"},$t={class:"title-wrap"},zt={class:"head-meta"},Dt={key:0},Nt={class:"head-actions"},Ht={key:0,class:"top-hint"},Lt={class:"main-grid"},Mt={class:"card-header"},Ot={class:"side-body"},Bt={key:0,class:"empty-wrap"},Et={key:1,class:"empty-wrap"},Rt={key:2,class:"session-list"},Vt=["onClick"],jt={class:"s-title"},qt={class:"s-preview"},Pt={class:"s-foot"},Ut={class:"card-header"},Wt={key:0,class:"empty-wrap"},Jt={key:1,class:"empty-wrap"},Kt={key:2,class:"msg-list"},Ft={class:"msg-avatar"},Gt={class:"msg-content"},Xt={class:"msg-head"},Yt={class:"msg-role"},Qt={class:"msg-time"},Zt={class:"msg-bubble"},te={class:"msg-text"},ee={key:0,class:"action-wrap"},se={class:"action-list"},ne={key:1,class:"err-wrap"},ae={class:"chat-input-wrap"},ie={class:"input-actions"},oe={class:"btns"},re={__name:"AiAssistantWorkbench",setup(e){const o=x(null),l=x(""),{loadingInit:n,loadingSessions:g,loadingHistory:u,sending:a,sessions:k,currentSessionId:b,currentSessionTitle:C,messages:w,processHint:I,ensureInit:T,refreshSessions:L,loadHistory:V,switchSession:U,createNewSessionLocal:W,removeSession:j,sendMessage:f}=Ct();function A(c){const t=String(c||"").toLowerCase();return t==="user"?"我":t==="assistant"?"AI":"系"}function D(c){const t=String(c||"").toLowerCase();return t==="user"?"用户":t==="assistant"?"AI助手":"系统"}function M(c){const t=String(c||"").toLowerCase();return t==="success"?"success":t==="streaming"||t==="sending"?"warning":t==="error"?"danger":"info"}function q(c){if(!c)return"-";const t=new Date(c);if(Number.isNaN(t.getTime()))return String(c);const B=t.getFullYear(),z=String(t.getMonth()+1).padStart(2,"0"),X=String(t.getDate()).padStart(2,"0"),J=String(t.getHours()).padStart(2,"0"),Y=String(t.getMinutes()).padStart(2,"0");return`${B}-${z}-${X} ${J}:${Y}`}async function O(){await ft();const c=o.value;c&&(c.scrollTop=c.scrollHeight)}dt(()=>w.value.length,async()=>{await O()});async function N(){const c=String(l.value||"").trim();if(!c){P.warning("请输入内容");return}const t=c;l.value="",await f(t,{useStream:!0,pageContext:{module:"ai_assistant_workbench",page:"AiAssistantWorkbench"}})}async function $(){b.value&&await V(b.value)}async function d(c){await U(c)}async function r(c){try{await _t.confirm("确认删除该会话？此操作仅删除 AI 助手内存会话记录。","删除会话",{type:"warning",confirmButtonText:"删除",cancelButtonText:"取消"})}catch{return}await j(c)}function H(c){const t=c||{};if(t.type==="suggest"&&t.label){l.value=t.label;return}if(t.type==="navigate"&&t.target){P.info(`导航动作预留：${t.target}`);return}P.info("动作已识别（预留）")}return ut(async()=>{await T(),await O()}),(c,t)=>{const B=E("el-tag"),z=E("el-button"),X=E("el-alert"),J=E("el-card"),Y=E("el-skeleton"),st=E("el-empty"),rt=E("el-input");return _(),v("div",It,[p(J,{shadow:"never",class:"head-card"},{default:y(()=>[s("div",Tt,[s("div",null,[s("div",$t,[t[4]||(t[4]=s("h2",{class:"page-title"},"AI助手（伪AI规则引擎）",-1)),p(B,{size:"small",type:"warning",effect:"plain"},{default:y(()=>[...t[3]||(t[3]=[S("非GPT接入版",-1)])]),_:1})]),s("div",zt,[s("span",null,[t[5]||(t[5]=S("当前会话：",-1)),s("b",null,h(m(C)),1)]),m(b)?(_(),v("span",Dt,[t[6]||(t[6]=S("Session: ",-1)),s("code",null,h(m(b)),1)])):R("",!0)])]),s("div",Nt,[p(z,{size:"small",onClick:m(W)},{default:y(()=>[...t[7]||(t[7]=[S("新会话",-1)])]),_:1},8,["onClick"]),p(z,{size:"small",onClick:m(L),loading:m(g)},{default:y(()=>[...t[8]||(t[8]=[S("刷新会话",-1)])]),_:1},8,["onClick","loading"])])]),m(I)?(_(),v("div",Ht,[p(X,{title:m(I),type:"info",closable:!1,"show-icon":""},null,8,["title"])])):R("",!0)]),_:1}),s("div",Lt,[p(J,{shadow:"never",class:"side-card"},{header:y(()=>[s("div",Mt,[t[9]||(t[9]=s("span",null,"会话列表",-1)),p(B,{size:"small",effect:"plain"},{default:y(()=>[S(h(m(k).length),1)]),_:1})])]),default:y(()=>[s("div",Ot,[m(n)||m(g)?(_(),v("div",Bt,[p(Y,{rows:4,animated:""})])):m(k).length?(_(),v("div",Rt,[(_(!0),v(tt,null,et(m(k),i=>(_(),v("div",{key:i.session_id,class:nt(["session-item",{active:i.session_id===m(b)}]),onClick:K=>d(i.session_id)},[s("div",jt,h(i.title||"新会话"),1),s("div",qt,h(i.last_message_preview||"暂无回复预览"),1),s("div",Pt,[s("span",null,h(q(i.updated_at||i.created_at)),1),s("span",null,"消息 "+h(i.message_count??0),1)]),s("div",{class:"s-actions",onClick:t[0]||(t[0]=at(()=>{},["stop"]))},[p(z,{size:"small",type:"danger",link:"",onClick:K=>r(i.session_id)},{default:y(()=>[...t[10]||(t[10]=[S(" 删除 ",-1)])]),_:1},8,["onClick"])])],10,Vt))),128))])):(_(),v("div",Et,[p(st,{description:"暂无历史会话"})]))])]),_:1}),p(J,{shadow:"never",class:"chat-card"},{header:y(()=>[s("div",Ut,[t[12]||(t[12]=s("span",null,"聊天区",-1)),s("div",null,[p(z,{size:"small",text:"",onClick:$,loading:m(u)},{default:y(()=>[...t[11]||(t[11]=[S("刷新消息",-1)])]),_:1},8,["loading"])])])]),default:y(()=>[s("div",{class:"chat-body",ref_key:"chatBodyRef",ref:o},[m(n)||m(u)?(_(),v("div",Wt,[p(Y,{rows:6,animated:""})])):m(w).length?(_(),v("div",Kt,[(_(!0),v(tt,null,et(m(w),i=>(_(),v("div",{key:i.id,class:nt(["msg-item",[`msg-${i.role||"system"}`]])},[s("div",Ft,h(A(i.role)),1),s("div",Gt,[s("div",Xt,[s("span",Yt,h(D(i.role)),1),s("span",Qt,h(q(i.created_at)),1),i.metadata?.status?(_(),Q(B,{key:0,size:"small",type:M(i.metadata?.status),effect:"plain"},{default:y(()=>[S(h(i.metadata.status),1)]),_:2},1032,["type"])):R("",!0),i.metadata?.intent?(_(),Q(B,{key:1,size:"small",type:"info",effect:"plain"},{default:y(()=>[S(h(i.metadata.intent),1)]),_:2},1024)):R("",!0),i.metadata?.trace_id?(_(),Q(B,{key:2,size:"small",type:"warning",effect:"plain"},{default:y(()=>[S(" trace: "+h(String(i.metadata.trace_id).slice(0,8)),1)]),_:2},1024)):R("",!0)]),s("div",Zt,[s("div",te,h(i.content),1),Array.isArray(i.metadata?.actions)&&i.metadata.actions.length?(_(),v("div",ee,[t[13]||(t[13]=s("div",{class:"action-title"},"建议动作",-1)),s("div",se,[(_(!0),v(tt,null,et(i.metadata.actions,(K,lt)=>(_(),Q(z,{key:`${i.id}_${lt}`,size:"small",onClick:le=>H(K)},{default:y(()=>[S(h(K.label||K.type),1)]),_:2},1032,["onClick"]))),128))])])):R("",!0),i.metadata?.error?(_(),v("div",ne,[p(X,{title:i.metadata.error.message||"处理失败",type:"error",closable:!1,"show-icon":""},null,8,["title"])])):R("",!0)])])],2))),128))])):(_(),v("div",Jt,[p(st,{description:"还没有消息，先发一句试试（例如：查订单 / 平台A 报价）"})]))],512),s("div",ae,[p(rt,{modelValue:l.value,"onUpdate:modelValue":t[1]||(t[1]=i=>l.value=i),type:"textarea",rows:3,resize:"none",placeholder:"输入示例：查订单 / 订单备注是什么意思 / 平台A 报价",onKeydown:mt(at(N,["exact","prevent"]),["enter"])},null,8,["modelValue","onKeydown"]),s("div",ie,[t[16]||(t[16]=s("div",{class:"input-tip"},[s("span",null,"Shift + Enter 换行；Enter 发送")],-1)),s("div",oe,[p(z,{onClick:t[2]||(t[2]=i=>l.value=""),disabled:m(a)},{default:y(()=>[...t[14]||(t[14]=[S("清空",-1)])]),_:1},8,["disabled"]),p(z,{type:"primary",loading:m(a),onClick:N},{default:y(()=>[...t[15]||(t[15]=[S("发送",-1)])]),_:1},8,["loading"])])])])]),_:1})])])}}},we=gt(re,[["__scopeId","data-v-93c9eb62"]]);export{we as default};
