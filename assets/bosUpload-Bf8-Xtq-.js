const K={driving_license_main:{maxEdge:4096,targetBytes:Math.floor(27262976e-1),minShortEdge:900},driving_license_sub:{maxEdge:4096,targetBytes:Math.floor(27262976e-1),minShortEdge:900},vehicle_cert:{maxEdge:4096,targetBytes:Math.floor(54525952e-1),minShortEdge:900},idcard_front:{maxEdge:8192,targetBytes:Math.floor(54525952e-1),minShortEdge:800},idcard_back:{maxEdge:8192,targetBytes:Math.floor(54525952e-1),minShortEdge:800},related:{maxEdge:4096,targetBytes:Math.floor(8388608),minShortEdge:800}};function V(r){return K[String(r||"").trim()]||{maxEdge:4096,targetBytes:Math.floor(8*1048576),minShortEdge:800}}function G(r,c,a){return Math.max(c,Math.min(a,r))}function Q(r){if(r)try{URL.revokeObjectURL(r)}catch{}}function Z(r){if(String(r?.type||"").toLowerCase().startsWith("image/"))return!0;const a=String(r?.name||"").toLowerCase();return/\.(jpg|jpeg|png|bmp|webp|heic|heif)$/i.test(a)}function P(r){const c=String(r?.type||"").toLowerCase(),a=String(r?.name||"").toLowerCase();return c.includes("heic")||c.includes("heif")||/\.heic$|\.heif$/i.test(a)}async function J(r){if(P(r))throw new Error("HEIC/HEIF browser decode unsupported");if(typeof createImageBitmap=="function")try{return await createImageBitmap(r,{imageOrientation:"from-image"})}catch{}const c=URL.createObjectURL(r);try{const a=await new Promise((f,h)=>{const g=new Image;g.crossOrigin="anonymous",g.onload=()=>f(g),g.onerror=h,g.src=c}),u=a.naturalWidth||a.width||0,d=a.naturalHeight||a.height||0;if(!u||!d)throw new Error("图片尺寸读取失败");if(typeof createImageBitmap=="function"){const f=document.createElement("canvas");f.width=u,f.height=d;const h=f.getContext("2d");if(!h)throw new Error("无法获取画布上下文");return h.drawImage(a,0,0),await createImageBitmap(f)}return a}finally{Q(c)}}function Y(r,c,a){return new Promise(u=>{try{r.toBlob(d=>u(d||null),c,a)}catch{u(null)}})}function tt(){return"image/jpeg"}function et(r){return`${(r?.name||"image").replace(/\.(jpg|jpeg|png|bmp|webp|heic|heif)$/i,"")}.jpg`}function A(r){const c=r?.size||0;return{file:r,changed:!1,note:"",beforeBytes:c,afterBytes:c}}function nt(r,c){let a=Math.max(1,Math.round(r)),u=Math.max(1,Math.round(c));const d=Math.max(a,u);if(d>8192){const h=8192/d;a=Math.max(1,Math.round(a*h)),u=Math.max(1,Math.round(u*h))}const f=a*u;if(f>36e6){const h=Math.sqrt(36e6/f);a=Math.max(1,Math.round(a*h)),u=Math.max(1,Math.round(u*h))}return{w:a,h:u}}function rt(r,c,a){try{return new File([r],c,{type:a,lastModified:Date.now()})}catch{return r.name=c,r.lastModified=Date.now(),r}}async function at({file:r,slotKey:c}){const a=r;if(!a)return A(a);const u=a.size||0;if(!Z(a))return A(a);if(P(a))return{file:a,changed:!1,note:"",beforeBytes:u,afterBytes:u};const d=V(c),f=Number(d.maxEdge)||4096,h=Number(d.targetBytes)||Math.floor(8*1048576),g=Number(d.minShortEdge)||800,y=u>2*1048576;let s=null;try{s=await J(a);const t=s?.width||s?.naturalWidth||0,e=s?.height||s?.naturalHeight||0;if(!t||!e)return A(a);const i=Math.max(t,e),o=Math.min(t,e),n=i>f;if(!(y||n))return A(a);let E=n?f/i:1;o*E<g&&(E=G(g/o,.1,1));let m=.92;const l=.78,w=tt();let p=null,S=Number.POSITIVE_INFINITY;for(let O=0;O<10;O++){const D=Math.max(1,Math.round(t*E)),X=Math.max(1,Math.round(e*E)),k=nt(D,X),$=document.createElement("canvas");$.width=k.w,$.height=k.h;const T=$.getContext("2d",{alpha:!1});if(!T)break;T.imageSmoothingEnabled=!0,T.imageSmoothingQuality="high",T.drawImage(s,0,0,k.w,k.h);const C=await Y($,w,m);if(!C)break;const I=C.size,L=Math.max(0,I-h)+Math.max(0,I-u);if(L<S&&(S=L,p=C),I<=h){p=C;break}if(m>l)m=Math.max(l,m-.04);else{const F=E*.92;if(Math.min(t,e)*F<g)break;E=F,m=.86}}if(!p||!n&&p.size>=u)return A(a);const x=rt(p,et(a),w),M=x.size||p.size||0,U=M!==u||String(x.type||"")!==String(a.type||""),q=U?`已优化：${(u/1048576).toFixed(2)}MB → ${(M/1048576).toFixed(2)}MB（最长边≤${f}px，Q≥${l.toFixed(2)}）`:"";return{file:x,changed:U,note:q,beforeBytes:u,afterBytes:M}}catch(t){return console.warn("[图片预处理失败，已自动跳过]",t),A(a)}finally{try{s&&typeof s.close=="function"&&s.close()}catch{}}}const ot={vehicle_cert:"cert",idcard_front:"idcard",idcard_back:"idcard",driving_license_main:"dl",driving_license_sub:"dl",related:"backup"};function _(r,c){const a=new Error(String(r||"上传失败"));if(c)try{a.__debug=typeof c=="string"?c:JSON.stringify(c)}catch{a.__debug=String(c)}return a}function H(r){const c=String(r||"").trim(),a=ot[c];if(!a)throw _("上传失败：图片类型不支持或参数异常",{slotKey:c});return a}function it({bosHost:r,slotKey:c,file:a,sts:u}){if(!String(r||"").trim())throw _("上传失败：存储配置缺失（bosHost）");if(H(c),!a||typeof a.arrayBuffer!="function")throw _("上传失败：文件对象无效");if(!u||typeof u!="object")throw _("上传失败：上传凭证缺失");if(!u.accessKeyId||!u.secretAccessKey||!u.sessionToken)throw _("上传失败：上传凭证不完整")}function v(r){return Array.from(r).map(c=>c.toString(16).padStart(2,"0")).join("")}function st(r){const c=new Uint8Array(r),a=c.length;function u(m,l,w,p,S,x){return l=l+m+p+x|0,(l<<S|l>>>32-S)+w|0}function d(m,l,w,p,S,x,M){return u(l&w|~l&p,m,l,S,x,M)}function f(m,l,w,p,S,x,M){return u(l&p|w&~p,m,l,S,x,M)}function h(m,l,w,p,S,x,M){return u(l^w^p,m,l,S,x,M)}function g(m,l,w,p,S,x,M){return u(w^(l|~p),m,l,S,x,M)}const y=(a+8>>>6<<4)+16>>>0,s=new Uint32Array(y);let t;for(t=0;t<a;t++)s[t>>2]|=c[t]<<t%4*8;s[t>>2]|=128<<t%4*8,s[y-2]=a*8>>>0,s[y-1]=a*8/4294967296>>>0;let e=1732584193,i=-271733879,o=-1732584194,n=271733878;for(t=0;t<s.length;t+=16){const m=e,l=i,w=o,p=n;e=d(e,i,o,n,s[t+0],7,-680876936),n=d(n,e,i,o,s[t+1],12,-389564586),o=d(o,n,e,i,s[t+2],17,606105819),i=d(i,o,n,e,s[t+3],22,-1044525330),e=d(e,i,o,n,s[t+4],7,-176418897),n=d(n,e,i,o,s[t+5],12,1200080426),o=d(o,n,e,i,s[t+6],17,-1473231341),i=d(i,o,n,e,s[t+7],22,-45705983),e=d(e,i,o,n,s[t+8],7,1770035416),n=d(n,e,i,o,s[t+9],12,-1958414417),o=d(o,n,e,i,s[t+10],17,-42063),i=d(i,o,n,e,s[t+11],22,-1990404162),e=d(e,i,o,n,s[t+12],7,1804603682),n=d(n,e,i,o,s[t+13],12,-40341101),o=d(o,n,e,i,s[t+14],17,-1502002290),i=d(i,o,n,e,s[t+15],22,1236535329),e=f(e,i,o,n,s[t+1],5,-165796510),n=f(n,e,i,o,s[t+6],9,-1069501632),o=f(o,n,e,i,s[t+11],14,643717713),i=f(i,o,n,e,s[t+0],20,-373897302),e=f(e,i,o,n,s[t+5],5,-701558691),n=f(n,e,i,o,s[t+10],9,38016083),o=f(o,n,e,i,s[t+15],14,-660478335),i=f(i,o,n,e,s[t+4],20,-405537848),e=f(e,i,o,n,s[t+9],5,568446438),n=f(n,e,i,o,s[t+14],9,-1019803690),o=f(o,n,e,i,s[t+3],14,-187363961),i=f(i,o,n,e,s[t+8],20,1163531501),e=f(e,i,o,n,s[t+13],5,-1444681467),n=f(n,e,i,o,s[t+2],9,-51403784),o=f(o,n,e,i,s[t+7],14,1735328473),i=f(i,o,n,e,s[t+12],20,-1926607734),e=h(e,i,o,n,s[t+5],4,-378558),n=h(n,e,i,o,s[t+8],11,-2022574463),o=h(o,n,e,i,s[t+11],16,1839030562),i=h(i,o,n,e,s[t+14],23,-35309556),e=h(e,i,o,n,s[t+1],4,-1530992060),n=h(n,e,i,o,s[t+4],11,1272893353),o=h(o,n,e,i,s[t+7],16,-155497632),i=h(i,o,n,e,s[t+10],23,-1094730640),e=h(e,i,o,n,s[t+13],4,681279174),n=h(n,e,i,o,s[t+0],11,-358537222),o=h(o,n,e,i,s[t+3],16,-722521979),i=h(i,o,n,e,s[t+6],23,76029189),e=h(e,i,o,n,s[t+9],4,-640364487),n=h(n,e,i,o,s[t+12],11,-421815835),o=h(o,n,e,i,s[t+15],16,530742520),i=h(i,o,n,e,s[t+2],23,-995338651),e=g(e,i,o,n,s[t+0],6,-198630844),n=g(n,e,i,o,s[t+7],10,1126891415),o=g(o,n,e,i,s[t+14],15,-1416354905),i=g(i,o,n,e,s[t+5],21,-57434055),e=g(e,i,o,n,s[t+12],6,1700485571),n=g(n,e,i,o,s[t+3],10,-1894986606),o=g(o,n,e,i,s[t+10],15,-1051523),i=g(i,o,n,e,s[t+1],21,-2054922799),e=g(e,i,o,n,s[t+8],6,1873313359),n=g(n,e,i,o,s[t+15],10,-30611744),o=g(o,n,e,i,s[t+6],15,-1560198380),i=g(i,o,n,e,s[t+13],21,1309151649),e=g(e,i,o,n,s[t+4],6,-145523070),n=g(n,e,i,o,s[t+11],10,-1120210379),o=g(o,n,e,i,s[t+2],15,718787259),i=g(i,o,n,e,s[t+9],21,-343485551),e=e+m|0,i=i+l|0,o=o+w|0,n=n+p|0}const b=new Uint8Array(16),E=[e,i,o,n];for(let m=0;m<4;m++){const l=E[m];b[m*4+0]=l&255,b[m*4+1]=l>>>8&255,b[m*4+2]=l>>>16&255,b[m*4+3]=l>>>24&255}return v(b)}async function ct(r){if(!r||typeof r.arrayBuffer!="function")throw _("上传失败：文件读取异常");const c=await r.arrayBuffer();return st(c)}function z(){return new Date().toISOString().replace(/\.\d{3}Z$/,"Z")}function j(r,c=!0){const a=encodeURIComponent(String(r));return c?a:a.replace(/%2F/gi,"/")}function ut(r,c){const a=[],u=Array.from(new Set((c||[]).map(d=>String(d).trim().toLowerCase()))).sort();for(const d of u){const f=(r?.[d]??"").toString().trim();f&&a.push(`${j(d)}:${j(f)}`)}return a.sort().join(`
`)}function dt(r){return r instanceof Uint8Array?r:r instanceof ArrayBuffer?new Uint8Array(r):ArrayBuffer.isView(r)?new Uint8Array(r.buffer,r.byteOffset,r.byteLength):null}async function N(r,c){if(!globalThis.crypto?.subtle)throw _("当前浏览器环境不支持安全签名，请更换现代浏览器后重试",{hasCrypto:!!globalThis.crypto,hasSubtle:!!globalThis.crypto?.subtle,isSecureContext:globalThis.isSecureContext});const a=new TextEncoder,u=a.encode(String(c));let d=dt(r);d||(d=a.encode(String(r)));const f=await crypto.subtle.importKey("raw",d,{name:"HMAC",hash:"SHA-256"},!1,["sign"]),h=await crypto.subtle.sign("HMAC",f,u);return new Uint8Array(h)}async function ft(r,c){const a=await N(r,c);return v(a)}async function R({ak:r,sk:c,method:a,path:u,timestamp:d,expireSeconds:f=1800,headersToSign:h,headers:g}){const y=`bce-auth-v1/${r}/${d}/${f}`,s=await N(c,y),t=j(u,!1),e="",i=ut(g,h),o=[String(a||"GET").toUpperCase(),t,e,i].join(`
`),n=await ft(s,o),b=Array.from(new Set((h||[]).map(E=>String(E).toLowerCase()))).sort().join(";");return`${y}/${b}/${n}`}function ht(r){const c=(r?.name||"").toLowerCase();if(c.endsWith(".jpeg")||c.endsWith(".jpg"))return".jpg";if(c.endsWith(".png"))return".png";if(c.endsWith(".webp"))return".webp";if(c.endsWith(".bmp"))return".bmp";if(c.endsWith(".heic"))return".heic";const a=(r?.type||"").toLowerCase();return a.includes("jpeg")?".jpg":a.includes("png")?".png":a.includes("webp")?".webp":".bin"}function gt({slotKey:r,md5:c,file:a}){const u=String(c||"").toLowerCase();if(!/^[a-f0-9]{32}$/.test(u))throw _("上传失败：文件校验异常，请重试",{md5:u});const d=ht(a);return`${H(r)}/${u.slice(0,2)}/${u.slice(2,4)}/${u}${d}`}function B(r,c){return r?.headers&&(r.headers.get(c)||r.headers.get(String(c).toLowerCase())||r.headers.get(String(c).toUpperCase()))||""}async function W(r){try{return await r.text()}catch{return""}}function lt(r,c){const a=String(r||"").trim(),u=`/${String(c||"").replace(/^\/+/,"")}`;return`https://${a}${u}`}async function mt({bosHost:r,key:c}){const a=`/${String(c||"").replace(/^\/+/,"")}`,u=`https://${r}${a}`;let d;try{d=await fetch(u,{method:"HEAD",mode:"cors",credentials:"omit",cache:"no-store"})}catch(f){return{exists:!1,mode:"public",fallback:!0,error:f?.message||String(f)}}return d.status===200?{exists:!0,etag:B(d,"ETag"),mode:"public",status:200}:d.status===404?{exists:!1,mode:"public",status:404}:{exists:!1,mode:"public",fallback:!0,status:d.status}}async function pt({bosHost:r,key:c,sts:a}){const u=`/${String(c||"").replace(/^\/+/,"")}`,d=`https://${r}${u}`,f=z(),h={host:r,"x-bce-date":f,"x-bce-security-token":a.sessionToken},g=["host","x-bce-date","x-bce-security-token"],y=await R({ak:a.accessKeyId,sk:a.secretAccessKey,method:"HEAD",path:u,timestamp:f,expireSeconds:1800,headersToSign:g,headers:h}),s={"x-bce-date":f,"x-bce-security-token":a.sessionToken,Authorization:y};let t;try{t=await fetch(d,{method:"HEAD",mode:"cors",credentials:"omit",headers:s,cache:"no-store"})}catch(n){throw _("网络异常：无法访问存储服务，请检查网络/代理设置后重试",{step:"HEAD",url:d,error:n?.message||String(n),hint:"可能走了本机代理(如 127.0.0.1:7890) 或公司网关拦截"})}if(t.status===200)return{exists:!0,etag:B(t,"ETag"),mode:"signed",status:200};if(t.status===404)return{exists:!1,mode:"signed",status:404};const e=B(t,"x-bce-request-id"),i=B(t,"x-bce-debug-id");let o={};try{const n=await fetch(d,{method:"GET",mode:"cors",credentials:"omit",headers:s,cache:"no-store"}),b=await W(n);o={get_status:n.status,get_request_id:B(n,"x-bce-request-id"),get_debug_id:B(n,"x-bce-debug-id"),get_body_preview:String(b||"").slice(0,2e3)}}catch(n){o={get_diag_failed:n?.message||String(n)}}throw _("存储服务校验失败，请稍后重试",{step:"HEAD",status:t.status,url:d,"x-bce-request-id":e,"x-bce-debug-id":i,diag:o})}async function yt({bosHost:r,key:c,sts:a}){const u=await mt({bosHost:r,key:c});return u?.status===200||u?.status===404?u:await pt({bosHost:r,key:c,sts:a})}async function wt({bosHost:r,key:c,file:a,sts:u}){const d=`/${String(c||"").replace(/^\/+/,"")}`,f=`https://${r}${d}`,h=z(),g=a?.type||"application/octet-stream",y={host:r,"content-type":g,"x-bce-date":h,"x-bce-security-token":u.sessionToken},s=["host","content-type","x-bce-date","x-bce-security-token"],t=await R({ak:u.accessKeyId,sk:u.secretAccessKey,method:"PUT",path:d,timestamp:h,expireSeconds:1800,headersToSign:s,headers:y});let e;try{e=await fetch(f,{method:"PUT",mode:"cors",credentials:"omit",headers:{"x-bce-date":h,"x-bce-security-token":u.sessionToken,Authorization:t,"Content-Type":g},body:a,cache:"no-store"})}catch(b){throw _("网络异常：上传失败，请检查网络/代理设置后重试",{step:"PUT",url:f,error:b?.message||String(b),hint:"可能走了本机代理(如 127.0.0.1:7890) 或公司网关拦截"})}if(e.status>=200&&e.status<300)return{etag:B(e,"ETag")};const i=B(e,"x-bce-request-id"),o=B(e,"x-bce-debug-id"),n=await W(e);throw _("存储服务上传失败，请稍后重试",{step:"PUT",status:e.status,url:f,"x-bce-request-id":i,"x-bce-debug-id":o,body_preview:String(n||"").slice(0,2e3)})}async function St({bosHost:r,slotKey:c,file:a,sts:u}){it({bosHost:r,slotKey:c,file:a,sts:u});let d=null,f=a;try{d=await at({file:a,slotKey:c}),f=d?.file||a}catch(t){console.warn("[BOS 上传诊断] preprocessImageForUpload failed, fallback to original file",t),d=null,f=a}const h=await ct(f),g=gt({slotKey:c,md5:h,file:f});let y;try{y=await yt({bosHost:r,key:g,sts:u})}catch(t){throw t?.__debug&&console.warn("[BOS 上传诊断] headObjectWithSts failed",t.__debug),t}let s=y?.etag||"";if(!y?.exists)try{s=(await wt({bosHost:r,key:g,file:f,sts:u})).etag||""}catch(t){throw t?.__debug&&console.warn("[BOS 上传诊断] putObjectWithSts failed",t.__debug),t}return{md5:h,storage_key:g,etag:s,size:f?.size||0,content_type:f?.type||"application/octet-stream",original_name:a?.name||"file",preview_url:lt(r,g),preprocess_note:d?.note||"",before_bytes:d?.beforeBytes??void 0,after_bytes:d?.afterBytes??void 0}}export{at as p,St as u};
