import{h as K}from"./http-DGyH82Tn.js";import{_ as be,u as me}from"./index-BffKbIYS.js";import{R as z,T as we}from"./index-DBEvR4Eq.js";import{E as h,d as Ae}from"./vendor-element-plus-nv6hIq5t.js";import{r as R,c as d,Z as Ne,o as W,q as de,ay as C,G as y,y as m,H as s,z as E,P as o,J as k,x as L,O as ee,ac as ae,u as Se,L as F,M as te,I as Ee,aI as he}from"./vendor-vue-CZOMRj4y.js";import"./vendor-axios-C0Zqfgkc.js";import"./vendor-vue-router-o2a2TmKO.js";import"./vendor-pinia--LqfdQ-h.js";import"./vendor-lodash-rvV0CIkQ.js";import"./vendor-DWCz07M-.js";import"./vendor-dates-DVKSwKij.js";function fe(r){try{const l=r?.data;return Array.isArray(l)?r:Array.isArray(l?.items)?(r.data=l.items,r):Array.isArray(l?.data)?(r.data=l.data,r):Array.isArray(l?.data?.items)?(r.data=l.data.items,r):(r.data=[],r)}catch{return r}}function B(r){return String(r??"").trim()}function Ce(){return K.get("/users/me")}function Me(){return K.get("/users/children").then(fe)}function Ve(r={}){return K.get("/users/managers",{params:{...r}}).then(fe)}function Re(r={}){const l=Number(r.role_id),v={username:B(r.username),password:B(r.password),role_id:Number.isNaN(l)?0:l,real_name:B(r.real_name)};return r.manager_id!==void 0&&(v.manager_id=r.manager_id),r.team_name!==void 0&&(v.team_name=r.team_name),Array.isArray(r.team_names)&&(v.team_names=r.team_names),K.post("/users",v)}function xe(r,l={}){const v=Number(r);if(!Number.isFinite(v)||v<=0)throw new Error("invalid userId");const N={};if(l.username!==void 0&&(N.username=B(l.username)),l.real_name!==void 0&&(N.real_name=B(l.real_name)),l.password!==void 0){const x=B(l.password);x&&(N.password=x)}return l.status!==void 0&&(N.status=l.status),l.manager_id!==void 0&&(N.manager_id=l.manager_id),l.team_name!==void 0&&(N.team_name=l.team_name),l.team_names!==void 0&&(N.team_names=l.team_names),K.put(`/users/${v}`,N)}function Le(r){const l=Number(r);if(!Number.isFinite(l)||l<=0)throw new Error("invalid userId");return K.delete(`/users/${l}`)}const ke={key:0,style:{"margin-left":"8px",color:"#999","font-size":"12px"}},Ue={key:0,style:{"margin-left":"8px",color:"#999","font-size":"12px"}},Ie={key:1,style:{"margin-left":"8px",color:"#999","font-size":"12px"}},Te={key:0,style:{"margin-left":"8px",color:"#999","font-size":"12px"}},De={key:1,style:{"margin-left":"8px",color:"#999","font-size":"12px"}},Oe={class:"form-actions"},ze={__name:"CreateUser",props:{mode:{type:String,default:"create"},initialUser:{type:Object,default:null},user:{type:Object,default:null}},emits:["success"],setup(r,{emit:l}){const v=r,N=l,x=R(null),G=R(!1),q=me();d(()=>!0),d(()=>!0),d(()=>!0);const p=d(()=>String(v.mode||"create").toLowerCase()==="edit"),U=d(()=>String(q.roleName||"").trim().toLowerCase()),M=d(()=>U.value===String(z.SUPER_ADMIN).toLowerCase()),I=d(()=>U.value===String(z.MANAGER).toLowerCase()),e=Ne({username:"",real_name:"",password:"",role_id:null,manager_id:null,team_names:[],team_name:null,status:1}),P=R({id:null,username:"",role_id:null}),j=R([]),H=R(!1),J=R([]),T=R(!1),g={MANAGER:2,SALES:3,FINANCE:4,MARKET:5},le={[String(z.SUPER_ADMIN).toLowerCase()]:[{label:"经理账号",value:g.MANAGER},{label:"业务账号",value:g.SALES},{label:"财务账号",value:g.FINANCE},{label:"市场账号",value:g.MARKET}],[String(z.MANAGER).toLowerCase()]:[{label:"业务账号",value:g.SALES},{label:"财务账号",value:g.FINANCE},{label:"市场账号",value:g.MARKET}]},Z=d(()=>le[U.value]||[]),i=d(()=>M.value),n=d(()=>Number(e.role_id)===g.MANAGER),c=d(()=>{const t=Number(e.role_id);return t===g.SALES||t===g.FINANCE||t===g.MARKET}),b=d(()=>M.value&&c.value),A=d(()=>M.value&&n.value),V=d(()=>c.value&&(I.value||M.value&&b.value));function ne(t){return t?Array.isArray(t)?t:[t]:[]}function D(t){const a=[];for(const _ of ne(t)){const f=(_==null?"":String(_)).trim();f&&a.push(f)}return Array.from(new Set(a)).sort()}const X=d(()=>{if(!e.manager_id)return null;const t=Number(e.manager_id);return(j.value||[]).find(a=>Number(a.id)===t)||null}),O=d(()=>{if(!V.value)return[];if(I.value)return D(J.value||[]);if(M.value){const t=X.value;if(!t)return[];const a=D(t.team_names||[]),_=(t.team_name||"").trim();return D([...a,..._?[_]:[]])}return[]}),w=d(()=>!!(!O.value.length||M.value&&b.value&&!e.manager_id||O.value.length===1)),re=d(()=>{const t={username:[{required:!0,message:"请输入用户名",trigger:"blur"},{min:3,max:32,message:"长度在 3-32 个字符",trigger:"blur"}],real_name:[{required:!0,message:"请输入角色姓名",trigger:"blur"}],role_id:[{required:!0,message:"请选择角色",trigger:"change"}],status:[{required:!0,message:"请选择状态",trigger:"change"}]};return p.value?t.password=[{validator:(a,_,f)=>{const S=String(_??"").trim();return S&&S.length<6?f(new Error("至少 6 位密码")):f()},trigger:"blur"}]:t.password=[{required:!0,message:"请输入密码",trigger:"blur"},{min:6,message:"至少 6 位密码",trigger:"blur"}],b.value&&(t.manager_id=[{required:!0,message:"请选择归属经理",trigger:"change"}]),A.value&&(t.team_names=[{required:!0,type:"array",message:"请选择团队（可多选）",trigger:"change"}]),V.value&&O.value.length>0&&(t.team_name=[{required:!0,message:"请选择所属团队",trigger:"change"}]),t});async function se(){if(b.value){H.value=!0;try{const t=await Ve({status:1});j.value=t?.data||t||[]}catch(t){console.error(t),h.error(t?.response?.data?.detail||"加载经理列表失败")}finally{H.value=!1}}}async function Y(){if(!I.value||!V.value)return;const t=q.user||null,a=D([...t?.team_names||[],...t?.team_name?[t.team_name]:[]]);if(a.length){J.value=a;return}T.value=!0;try{const _=await Ce(),f=_?.data||_||{},S=D([...f.team_names||[],...f.team_name?[f.team_name]:[]]);J.value=S}catch(_){console.error(_),h.error(_?.response?.data?.detail||"加载当前账号团队失败")}finally{T.value=!1}}function Q(){const t=O.value||[];t.length===1&&(e.team_name=t[0])}function ce(){e.team_name=null,Q()}function _e(){p.value||(e.manager_id=null,e.team_name=null,e.team_names=[],b.value&&se(),V.value&&Y())}W(()=>b.value,t=>{t||(e.manager_id=null),t&&se()}),W(()=>A.value,t=>{t||(e.team_names=[])}),W(()=>V.value,t=>{t||(e.team_name=null),t&&(Y(),Q())}),W(()=>[e.manager_id,O.value.length],()=>{Q()});function pe(t){const a=String(t||"").trim().toLowerCase();return a===String(z.MANAGER).toLowerCase()?g.MANAGER:a===String(z.SALES).toLowerCase()?g.SALES:a===String(z.FINANCE).toLowerCase()?g.FINANCE:a===String(z.MARKET).toLowerCase()?g.MARKET:null}function oe(t){const a=t&&typeof t=="object"?t:null;if(!a)return;const _=pe(a.role_name);e.role_id=_,e.username=a.username||"",e.real_name=a.real_name||"",e.password="",e.status=Number.isFinite(Number(a.status))?Number(a.status):1,e.team_name=a.team_name||null;const f=Array.isArray(a.team_names)?[...a.team_names]:[],S=String(a.team_name||"").trim(),$=D([...f,...S?[S]:[]]);e.team_names=$,e.manager_id=a.manager_id||null,P.value={id:a.id??null,username:a.username||"",role_id:_},V.value&&(Y(),Q())}const ue=d(()=>v.initialUser||v.user||null);async function ve(){if(x.value)try{if(G.value=!0,await x.value.validate(),!Z.value.length&&!p.value){h.error("当前账号无可创建的角色类型");return}if(!p.value){const f=A.value&&Array.isArray(e.team_names)&&e.team_names.length?String(e.team_names[0]||"").trim():"";await Re({username:e.username,password:e.password,real_name:e.real_name,role_id:e.role_id,manager_id:b.value?e.manager_id:void 0,team_names:A.value?e.team_names:void 0,team_name:V.value?e.team_name:f||void 0}),h.success("创建成功"),N("success"),e.username="",e.real_name="",e.password="",e.role_id=null,e.manager_id=null,e.team_names=[],e.team_name=null,e.status=1,x.value?.clearValidate?.();return}const t=Number(P.value?.id);if(!Number.isFinite(t)||t<=0){h.error("缺少 user.id，无法保存");return}const a={real_name:e.real_name,status:Number(e.status)};i.value&&String(e.username||"")!==String(P.value.username||"")&&(a.username=e.username);const _=String(e.password||"").trim();_&&(a.password=_),A.value?(a.team_names=e.team_names,e.team_name&&(a.team_name=e.team_name),!a.team_name&&Array.isArray(e.team_names)&&e.team_names.length&&(a.team_name=String(e.team_names[0]||"").trim()||void 0)):V.value&&(a.team_name=e.team_name),b.value&&(a.manager_id=e.manager_id),await xe(t,a),h.success("保存成功"),N("success"),e.password="",x.value?.clearValidate?.()}catch(t){console.error(t);const a=t?.response?.data?.detail||t?.message||(p.value?"保存失败":"创建失败");h.error(a)}finally{G.value=!1}}return de(()=>{b.value&&se(),V.value&&Y(),Q(),p.value&&ue.value&&oe(ue.value)}),W(()=>ue.value,t=>{p.value&&t&&oe(t)},{deep:!0}),(t,a)=>{const _=C("el-input"),f=C("el-form-item"),S=C("el-option"),$=C("el-select"),ge=C("el-button"),ye=C("el-form");return m(),y(ye,{ref_key:"formRef",ref:x,model:e,rules:re.value,"label-width":"90px",autocomplete:"off"},{default:s(()=>[a[10]||(a[10]=E("input",{type:"text",style:{display:"none"},autocomplete:"off"},null,-1)),a[11]||(a[11]=E("input",{type:"password",style:{display:"none"},autocomplete:"new-password"},null,-1)),o(f,{label:"用户名",prop:"username"},{default:s(()=>[o(_,{modelValue:e.username,"onUpdate:modelValue":a[0]||(a[0]=u=>e.username=u),placeholder:"请输入登录账号",autocomplete:"off",disabled:p.value&&!i.value},null,8,["modelValue","disabled"]),p.value&&!i.value?(m(),L("div",ke," 当前角色无权限修改用户名 ")):k("",!0)]),_:1}),o(f,{label:"角色姓名",prop:"real_name"},{default:s(()=>[o(_,{modelValue:e.real_name,"onUpdate:modelValue":a[1]||(a[1]=u=>e.real_name=u),placeholder:"请输入业务员/财务姓名",autocomplete:"off"},null,8,["modelValue"])]),_:1}),o(f,{label:p.value?"密码(可选)":"密码",prop:"password"},{default:s(()=>[o(_,{modelValue:e.password,"onUpdate:modelValue":a[2]||(a[2]=u=>e.password=u),type:"password","show-password":"",autocomplete:"new-password",placeholder:p.value?"不修改请留空":"请输入登录密码"},null,8,["modelValue","placeholder"])]),_:1},8,["label"]),o(f,{label:"角色类型",prop:"role_id"},{default:s(()=>[o($,{modelValue:e.role_id,"onUpdate:modelValue":a[3]||(a[3]=u=>e.role_id=u),placeholder:"请选择角色类型",style:{width:"100%"},disabled:p.value,onChange:_e},{default:s(()=>[(m(!0),L(ee,null,ae(Z.value,u=>(m(),y(S,{key:u.value,label:u.label,value:u.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled"]),Z.value.length?k("",!0):(m(),L("div",Ue," 当前账号暂无可创建的下级角色 ")),p.value?(m(),L("div",Ie," 编辑模式不允许修改角色类型 ")):k("",!0)]),_:1}),p.value?(m(),y(f,{key:0,label:"状态",prop:"status"},{default:s(()=>[o($,{modelValue:e.status,"onUpdate:modelValue":a[4]||(a[4]=u=>e.status=u),style:{width:"100%"},placeholder:"请选择状态"},{default:s(()=>[o(S,{label:"启用",value:1}),o(S,{label:"禁用",value:0})]),_:1},8,["modelValue"])]),_:1})):k("",!0),A.value?(m(),y(f,{key:1,label:"团队",prop:"team_names"},{default:s(()=>[o($,{modelValue:e.team_names,"onUpdate:modelValue":a[5]||(a[5]=u=>e.team_names=u),multiple:"",filterable:"",clearable:"","collapse-tags":"","collapse-tags-tooltip":"",placeholder:"请选择团队（可多选）",style:{width:"100%"}},{default:s(()=>[(m(!0),L(ee,null,ae(Se(we),u=>(m(),y(S,{key:u,label:u,value:u},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),a[8]||(a[8]=E("div",{style:{"margin-left":"8px",color:"#999","font-size":"12px"}}," 经理账号必须分配团队（可多选） ",-1))]),_:1})):k("",!0),b.value?(m(),y(f,{key:2,label:"归属经理",prop:"manager_id"},{default:s(()=>[o($,{modelValue:e.manager_id,"onUpdate:modelValue":a[6]||(a[6]=u=>e.manager_id=u),placeholder:"请选择归属经理",filterable:"",clearable:"",style:{width:"100%"},loading:H.value,onChange:ce},{default:s(()=>[(m(!0),L(ee,null,ae(j.value,u=>(m(),y(S,{key:u.id,label:`${u.real_name||"-"}（${u.username}）`,value:u.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","loading"]),a[9]||(a[9]=E("div",{style:{"margin-left":"8px",color:"#999","font-size":"12px"}}," 超级账号创建业务/财务/市场必须挂在某个经理名下 ",-1))]),_:1})):k("",!0),V.value?(m(),y(f,{key:3,label:"所属团队",prop:"team_name"},{default:s(()=>[o($,{modelValue:e.team_name,"onUpdate:modelValue":a[7]||(a[7]=u=>e.team_name=u),placeholder:"请选择所属团队",filterable:"",clearable:"",style:{width:"100%"},disabled:w.value,loading:T.value},{default:s(()=>[(m(!0),L(ee,null,ae(O.value,u=>(m(),y(S,{key:u,label:u,value:u},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled","loading"]),M.value&&b.value?(m(),L("div",Te," 团队选项来自“所选归属经理”的团队集合 ")):I.value?(m(),L("div",De," 团队选项来自“当前经理账号创建时分配的团队集合” ")):k("",!0)]),_:1})):k("",!0),o(f,null,{default:s(()=>[E("div",Oe,[o(ge,{type:"primary",loading:G.value,onClick:ve},{default:s(()=>[F(te(p.value?"保存":"创建"),1)]),_:1},8,["loading"])])]),_:1})]),_:1},8,["model","rules"])}}},ie=be(ze,[["__scopeId","data-v-715ed11f"]]),Fe={style:{display:"flex","justify-content":"space-between","align-items":"center"}},$e={style:{display:"flex",gap:"12px","align-items":"center"}},Ge={class:"table-scroll",style:{"margin-top":"15px"}},Ye={__name:"UserList",setup(r){const l=me();d(()=>!0),d(()=>!0),d(()=>!0);const v=d(()=>String(l.roleName||"").trim().toLowerCase()),N=d(()=>v.value===ROLE.SUPER_ADMIN||v.value===ROLE.MANAGER),x=d(()=>v.value===ROLE.SUPER_ADMIN||v.value===ROLE.MANAGER),G=d(()=>v.value===ROLE.SUPER_ADMIN||v.value===ROLE.MANAGER),q=R([]),p=R(!1),U=R(!1),M=R(!1),I=R(null);function e(i){const n=Array.isArray(i?.team_names)?i.team_names:[],c=[...new Set(n.map(A=>String(A||"").trim()).filter(Boolean))];return c.length?c.join("、"):String(i?.team_name||"").trim()||"-"}function P(i){const n=Number(l.userId||l.user?.id||l.id||0),c=Number(i?.id||i?.user_id||0);return!n||!c?!1:n===c}function j(){if(!N.value){h.error("无权限");return}U.value=!0}function H(i){if(!x.value){h.error("无权限");return}i?.id&&(I.value={...i||{}},M.value=!0)}function J(i){const n=i?.data??i??{};if(Array.isArray(n))return n;const c=n?.items??n?.data?.items??n?.data;return Array.isArray(c)?c:[]}async function T(){p.value=!0;try{const i=await Me();q.value=J(i)}catch(i){console.error(i),h.error(i?.response?.data?.detail||"加载账号失败")}finally{p.value=!1}}async function g(){U.value=!1,await T()}async function le(){M.value=!1,I.value=null,await T()}async function Z(i){if(!G.value){h.error("无权限");return}const n=Number(i?.id);if(n){if(P(i)){h.warning("不能删除当前登录账号");return}try{await Ae.confirm(`确认删除账号：${i?.real_name||i?.username||n}？删除后无法恢复`,"删除确认",{type:"warning",confirmButtonText:"删除",cancelButtonText:"取消"}),await Le(n),h.success("删除成功"),await T()}catch(c){if(c==="cancel"||c==="close")return;console.error(c),h.error(c?.response?.data?.detail||c?.message||"删除失败")}}}return de(()=>{T()}),(i,n)=>{const c=C("el-button"),b=C("el-tooltip"),A=C("el-table-column"),V=C("el-tag"),ne=C("el-table"),D=C("el-empty"),X=C("el-dialog"),O=he("loading");return m(),L("div",null,[E("div",Fe,[n[4]||(n[4]=E("h2",null,"子账号管理",-1)),E("div",$e,[N.value?(m(),y(c,{key:1,type:"primary",onClick:j},{default:s(()=>[...n[3]||(n[3]=[F(" 创建子账号 ",-1)])]),_:1})):(m(),y(b,{key:0,content:"无权限",placement:"top"},{default:s(()=>[E("span",null,[o(c,{type:"primary",disabled:""},{default:s(()=>[...n[2]||(n[2]=[F("创建子账号",-1)])]),_:1})])]),_:1}))])]),E("div",Ge,[Ee((m(),y(ne,{data:q.value,stripe:"","row-key":"id",fit:!0},{default:s(()=>[o(A,{prop:"team_name",label:"团队","min-width":"180","show-overflow-tooltip":""},{default:s(({row:w})=>[E("span",null,te(e(w)),1)]),_:1}),o(A,{prop:"username",label:"账号","min-width":"180","show-overflow-tooltip":""}),o(A,{prop:"real_name",label:"真实姓名","min-width":"180","show-overflow-tooltip":""},{default:s(({row:w})=>[E("span",null,te(w?.real_name||"-"),1)]),_:1}),o(A,{prop:"role_name",label:"角色","min-width":"160","show-overflow-tooltip":""}),o(A,{label:"在线状态","min-width":"140"},{default:s(({row:w})=>[o(V,{type:w.is_online?"success":"info"},{default:s(()=>[F(te(w.is_online?"在线":"离线"),1)]),_:2},1032,["type"])]),_:1}),o(A,{label:"操作",width:"220",align:"center"},{default:s(({row:w})=>[x.value?(m(),y(c,{key:1,size:"small",onClick:re=>H(w)},{default:s(()=>[...n[6]||(n[6]=[F("编辑",-1)])]),_:1},8,["onClick"])):(m(),y(b,{key:0,content:"无权限",placement:"top"},{default:s(()=>[E("span",null,[o(c,{size:"small",disabled:""},{default:s(()=>[...n[5]||(n[5]=[F("编辑",-1)])]),_:1})])]),_:1})),G.value?(m(),y(c,{key:3,size:"small",type:"danger",disabled:P(w),onClick:re=>Z(w)},{default:s(()=>[...n[8]||(n[8]=[F(" 删除 ",-1)])]),_:1},8,["disabled","onClick"])):(m(),y(b,{key:2,content:"无权限",placement:"top"},{default:s(()=>[E("span",null,[o(c,{size:"small",type:"danger",disabled:""},{default:s(()=>[...n[7]||(n[7]=[F("删除",-1)])]),_:1})])]),_:1}))]),_:1})]),_:1},8,["data"])),[[O,p.value]])]),!p.value&&!q.value.length?(m(),y(D,{key:0,description:"暂无子账号",style:{"margin-top":"20px"}})):k("",!0),o(X,{modelValue:U.value,"onUpdate:modelValue":n[0]||(n[0]=w=>U.value=w),title:"创建子账号",width:"420px","destroy-on-close":""},{default:s(()=>[o(ie,{mode:"create",onSuccess:g})]),_:1},8,["modelValue"]),o(X,{modelValue:M.value,"onUpdate:modelValue":n[1]||(n[1]=w=>M.value=w),title:"编辑账号",width:"420px","destroy-on-close":""},{default:s(()=>[o(ie,{mode:"edit","initial-user":I.value,onSuccess:le},null,8,["initial-user"])]),_:1},8,["modelValue"])])}}};export{Ye as default};
