import{_ as X}from"./index-1e9zDAa1.js";import{e as G}from"./vendor-element-plus-CtVxZ4Oy.js";import{r as C,o as A,x as J,y as ee,z as a,P as p,u as d,l as le,c as te,ai as H}from"./vendor-vue-fFWwKrgY.js";const ne={class:"cert-full"},oe={class:"cert-table"},ae={class:"cell-value",colspan:"3"},se={class:"cell-value",colspan:"3"},re={class:"cell-value",colspan:"7"},de={class:"cell-value",colspan:"7"},ue={class:"cell-value",colspan:"3"},ie={class:"cell-value",colspan:"3"},ce={class:"cell-value",colspan:"3"},me={class:"cell-value",colspan:"3"},ye={class:"cell-value",colspan:"3"},fe={class:"cell-value",colspan:"3"},ge={class:"cell-value",colspan:"7"},pe={class:"cell-value",colspan:"3"},be={class:"cell-value",colspan:"3"},Ve={class:"split2"},ve={class:"split-cell"},we={class:"split-cell"},xe={class:"cell-value",colspan:"7"},he={class:"cell-value",colspan:"7"},Se={class:"cell-value"},Ue={class:"cell-value"},ke={class:"cell-value"},Be={class:"cell-value"},Ee={class:"cell-value"},Me={class:"cell-value"},$e={class:"cell-value",colspan:"3"},je={class:"cell-value",colspan:"3"},Ae={class:"cell-value",colspan:"7"},Te={class:"cell-value",colspan:"3"},Ie={class:"cell-value",colspan:"4"},Oe={class:"cell-value",colspan:"7"},Ce={class:"cell-value",colspan:"7"},Pe={class:"cell-value",colspan:"3"},Le={class:"cell-value",colspan:"3"},ze={class:"cell-value",colspan:"3"},De={class:"cell-value",colspan:"3"},Fe={class:"cell-value",colspan:"3"},Re={class:"cell-value",colspan:"3"},We={class:"cell-value",colspan:"3"},qe={class:"cell-value",colspan:"3"},He={class:"cell-value",colspan:"3"},Ne={class:"cell-value",colspan:"3"},_e={class:"cell-value",colspan:"3"},Ye={class:"cell-value",colspan:"3"},Ke={class:"cell-value",colspan:"7"},Qe={__name:"VehicleCertTable",props:{data:{type:Object,required:!0},readonly:{type:Boolean,default:!1}},setup(s){const i=s,t=i.data;function y(o,e,l){const r=o==null?"":String(o).trim();if(!r)return Array.from({length:e},()=>"");let w=[];l==="x3"?w=r.split(/[xX×\*\s]+/).filter(Boolean):l==="x2"?w=r.split(/[\/／\s\|]+/).filter(Boolean):w=[r];const S=Array.from({length:e},(V,b)=>w[b]??"");return w.length>e&&(S[e-1]=w.slice(e-1).join(" ")),S}function c(o,e){const l=(o||[]).map(r=>String(r||"").trim()).filter(Boolean);return l.length?e==="x3"?l.join("×"):e==="x2"?l.join("/"):l.join(" "):""}const m=C(["",""]),f=C(["","",""]),g=C(["","",""]),v=C(["",""]);function u(){m.value=y(t.displacement_and_power,2,"x2"),f.value=y(t.overall_dimensions,3,"x3"),g.value=y(t.cargo_dimensions,3,"x3"),v.value=y(t.wheel_track,2,"x2")}A(()=>[t.displacement_and_power,t.overall_dimensions,t.cargo_dimensions,t.wheel_track],()=>u(),{immediate:!0}),A(m,o=>{i.readonly||(t.displacement_and_power=c(o,"x2"))},{deep:!0}),A(f,o=>{i.readonly||(t.overall_dimensions=c(o,"x3"))},{deep:!0}),A(g,o=>{i.readonly||(t.cargo_dimensions=c(o,"x3"))},{deep:!0}),A(v,o=>{i.readonly||(t.wheel_track=c(o,"x2"))},{deep:!0});const n=le({name:"CellInput",props:{modelValue:{type:[String,Number],default:""},readonly:{type:Boolean,default:!1},placeholder:{type:String,default:""}},emits:["update:modelValue"],setup(o,{emit:e}){const l=te(()=>{const r=o.modelValue,w=r==null?"":String(r).trim();return w||"-"});return()=>o.readonly?H("div",{class:"val-text",title:l.value},l.value):H(G,{modelValue:o.modelValue??"","onUpdate:modelValue":r=>e("update:modelValue",r),clearable:!0,placeholder:o.placeholder||"",class:"fv helpslim"})}});return(o,e)=>(ee(),J("div",ne,[a("table",oe,[e[84]||(e[84]=a("colgroup",null,[a("col",{class:"c-l1"}),a("col",{class:"c-v"}),a("col",{class:"c-v"}),a("col",{class:"c-v"}),a("col",{class:"c-l2"}),a("col",{class:"c-v2"}),a("col",{class:"c-v2"}),a("col",{class:"c-v2"})],-1)),a("tbody",null,[a("tr",null,[e[42]||(e[42]=a("td",{class:"cell-label"},"1. 合格证编号",-1)),a("td",ae,[p(d(n),{modelValue:d(t).cert_no,"onUpdate:modelValue":e[0]||(e[0]=l=>d(t).cert_no=l),readonly:s.readonly},null,8,["modelValue","readonly"])]),e[43]||(e[43]=a("td",{class:"cell-label"},"2. 发证日期",-1)),a("td",se,[p(d(n),{modelValue:d(t).cert_issue_date,"onUpdate:modelValue":e[1]||(e[1]=l=>d(t).cert_issue_date=l),readonly:s.readonly,placeholder:"YYYY-MM-DD"},null,8,["modelValue","readonly"])])]),a("tr",null,[e[44]||(e[44]=a("td",{class:"cell-label"},"3. 车辆制造企业名称",-1)),a("td",re,[p(d(n),{modelValue:d(t).manufacturer_name,"onUpdate:modelValue":e[2]||(e[2]=l=>d(t).manufacturer_name=l),readonly:s.readonly},null,8,["modelValue","readonly"])])]),a("tr",null,[e[45]||(e[45]=a("td",{class:"cell-label"},"4. 车辆品牌/车辆名称",-1)),a("td",de,[p(d(n),{modelValue:d(t).vehicle_brand_name,"onUpdate:modelValue":e[3]||(e[3]=l=>d(t).vehicle_brand_name=l),readonly:s.readonly},null,8,["modelValue","readonly"])])]),a("tr",null,[e[46]||(e[46]=a("td",{class:"cell-label"},"5. 车辆型号",-1)),a("td",ue,[p(d(n),{modelValue:d(t).vehicle_model,"onUpdate:modelValue":e[4]||(e[4]=l=>d(t).vehicle_model=l),readonly:s.readonly},null,8,["modelValue","readonly"])]),e[47]||(e[47]=a("td",{class:"cell-label"},"6. 车辆识别代号/车架号",-1)),a("td",ie,[p(d(n),{modelValue:d(t).vin,"onUpdate:modelValue":e[5]||(e[5]=l=>d(t).vin=l),readonly:s.readonly},null,8,["modelValue","readonly"])])]),a("tr",null,[e[48]||(e[48]=a("td",{class:"cell-label"},"7. 车身颜色",-1)),a("td",ce,[p(d(n),{modelValue:d(t).body_color,"onUpdate:modelValue":e[6]||(e[6]=l=>d(t).body_color=l),readonly:s.readonly},null,8,["modelValue","readonly"])]),e[49]||(e[49]=a("td",{class:"cell-value",colspan:"4"},null,-1))]),a("tr",null,[e[50]||(e[50]=a("td",{class:"cell-label"},"8. 底盘型号/底盘ID",-1)),a("td",me,[p(d(n),{modelValue:d(t).chassis_model_id,"onUpdate:modelValue":e[7]||(e[7]=l=>d(t).chassis_model_id=l),readonly:s.readonly},null,8,["modelValue","readonly"])]),e[51]||(e[51]=a("td",{class:"cell-value",colspan:"4"},null,-1))]),a("tr",null,[e[52]||(e[52]=a("td",{class:"cell-label"},"9. 底盘合格证编号",-1)),a("td",ye,[p(d(n),{modelValue:d(t).chassis_cert_no,"onUpdate:modelValue":e[8]||(e[8]=l=>d(t).chassis_cert_no=l),readonly:s.readonly},null,8,["modelValue","readonly"])]),e[53]||(e[53]=a("td",{class:"cell-label"},"10. 发动机型号",-1)),a("td",fe,[p(d(n),{modelValue:d(t).engine_model,"onUpdate:modelValue":e[9]||(e[9]=l=>d(t).engine_model=l),readonly:s.readonly},null,8,["modelValue","readonly"])])]),a("tr",null,[e[54]||(e[54]=a("td",{class:"cell-label"},"11. 发动机号",-1)),a("td",ge,[p(d(n),{modelValue:d(t).engine_no,"onUpdate:modelValue":e[10]||(e[10]=l=>d(t).engine_no=l),readonly:s.readonly},null,8,["modelValue","readonly"])])]),a("tr",null,[e[55]||(e[55]=a("td",{class:"cell-label"},"12. 燃料种类",-1)),a("td",pe,[p(d(n),{modelValue:d(t).fuel_type,"onUpdate:modelValue":e[11]||(e[11]=l=>d(t).fuel_type=l),readonly:s.readonly},null,8,["modelValue","readonly"])]),e[56]||(e[56]=a("td",{class:"cell-label"},"13. 排量和功率(mL/kW)",-1)),a("td",be,[a("div",Ve,[a("div",ve,[p(d(n),{modelValue:m.value[0],"onUpdate:modelValue":e[12]||(e[12]=l=>m.value[0]=l),readonly:s.readonly,placeholder:"排量(mL)"},null,8,["modelValue","readonly"])]),a("div",we,[p(d(n),{modelValue:m.value[1],"onUpdate:modelValue":e[13]||(e[13]=l=>m.value[1]=l),readonly:s.readonly,placeholder:"功率(kW)"},null,8,["modelValue","readonly"])])])])]),a("tr",null,[e[57]||(e[57]=a("td",{class:"cell-label"},"14. 排放标准",-1)),a("td",xe,[p(d(n),{modelValue:d(t).emission_standard,"onUpdate:modelValue":e[14]||(e[14]=l=>d(t).emission_standard=l),readonly:s.readonly},null,8,["modelValue","readonly"])])]),a("tr",null,[e[58]||(e[58]=a("td",{class:"cell-label"},"15. 油耗",-1)),a("td",he,[p(d(n),{modelValue:d(t).fuel_consumption,"onUpdate:modelValue":e[15]||(e[15]=l=>d(t).fuel_consumption=l),readonly:s.readonly},null,8,["modelValue","readonly"])])]),a("tr",null,[e[59]||(e[59]=a("td",{class:"cell-label"},"16. 外廓尺寸(mm)",-1)),a("td",Se,[p(d(n),{modelValue:f.value[0],"onUpdate:modelValue":e[16]||(e[16]=l=>f.value[0]=l),readonly:s.readonly,placeholder:"长"},null,8,["modelValue","readonly"])]),a("td",Ue,[p(d(n),{modelValue:f.value[1],"onUpdate:modelValue":e[17]||(e[17]=l=>f.value[1]=l),readonly:s.readonly,placeholder:"宽"},null,8,["modelValue","readonly"])]),a("td",ke,[p(d(n),{modelValue:f.value[2],"onUpdate:modelValue":e[18]||(e[18]=l=>f.value[2]=l),readonly:s.readonly,placeholder:"高"},null,8,["modelValue","readonly"])]),e[60]||(e[60]=a("td",{class:"cell-label"},"17. 货箱内部尺寸(mm)",-1)),a("td",Be,[p(d(n),{modelValue:g.value[0],"onUpdate:modelValue":e[19]||(e[19]=l=>g.value[0]=l),readonly:s.readonly,placeholder:"长"},null,8,["modelValue","readonly"])]),a("td",Ee,[p(d(n),{modelValue:g.value[1],"onUpdate:modelValue":e[20]||(e[20]=l=>g.value[1]=l),readonly:s.readonly,placeholder:"宽"},null,8,["modelValue","readonly"])]),a("td",Me,[p(d(n),{modelValue:g.value[2],"onUpdate:modelValue":e[21]||(e[21]=l=>g.value[2]=l),readonly:s.readonly,placeholder:"高"},null,8,["modelValue","readonly"])])]),a("tr",null,[e[61]||(e[61]=a("td",{class:"cell-label"},"18. 钢板弹簧片数(片)",-1)),a("td",$e,[p(d(n),{modelValue:d(t).leaf_spring_count,"onUpdate:modelValue":e[22]||(e[22]=l=>d(t).leaf_spring_count=l),readonly:s.readonly},null,8,["modelValue","readonly"])]),e[62]||(e[62]=a("td",{class:"cell-label"},"19. 轮胎数",-1)),a("td",je,[p(d(n),{modelValue:d(t).tire_count,"onUpdate:modelValue":e[23]||(e[23]=l=>d(t).tire_count=l),readonly:s.readonly},null,8,["modelValue","readonly"])])]),a("tr",null,[e[63]||(e[63]=a("td",{class:"cell-label"},"20. 轮胎规格",-1)),a("td",Ae,[p(d(n),{modelValue:d(t).tire_spec,"onUpdate:modelValue":e[24]||(e[24]=l=>d(t).tire_spec=l),readonly:s.readonly},null,8,["modelValue","readonly"])])]),a("tr",null,[e[64]||(e[64]=a("td",{class:"cell-label"},"21. 轮距(前/后)(mm)",-1)),a("td",Te,[p(d(n),{modelValue:v.value[0],"onUpdate:modelValue":e[25]||(e[25]=l=>v.value[0]=l),readonly:s.readonly,placeholder:"前轮距"},null,8,["modelValue","readonly"])]),a("td",Ie,[p(d(n),{modelValue:v.value[1],"onUpdate:modelValue":e[26]||(e[26]=l=>v.value[1]=l),readonly:s.readonly,placeholder:"后轮距"},null,8,["modelValue","readonly"])])]),a("tr",null,[e[65]||(e[65]=a("td",{class:"cell-label"},"22. 轴距(mm)",-1)),a("td",Oe,[p(d(n),{modelValue:d(t).wheel_base,"onUpdate:modelValue":e[27]||(e[27]=l=>d(t).wheel_base=l),readonly:s.readonly},null,8,["modelValue","readonly"])])]),a("tr",null,[e[66]||(e[66]=a("td",{class:"cell-label"},"23. 轴荷(kg)",-1)),a("td",Ce,[p(d(n),{modelValue:d(t).axle_load_kg,"onUpdate:modelValue":e[28]||(e[28]=l=>d(t).axle_load_kg=l),readonly:s.readonly},null,8,["modelValue","readonly"])])]),a("tr",null,[e[67]||(e[67]=a("td",{class:"cell-label"},"24. 轴数",-1)),a("td",Pe,[p(d(n),{modelValue:d(t).axle_count,"onUpdate:modelValue":e[29]||(e[29]=l=>d(t).axle_count=l),readonly:s.readonly},null,8,["modelValue","readonly"])]),e[68]||(e[68]=a("td",{class:"cell-label"},"25. 转向形式",-1)),a("td",Le,[p(d(n),{modelValue:d(t).steering_type,"onUpdate:modelValue":e[30]||(e[30]=l=>d(t).steering_type=l),readonly:s.readonly},null,8,["modelValue","readonly"])])]),a("tr",null,[e[69]||(e[69]=a("td",{class:"cell-label"},"26. 整备质量(kg)",-1)),a("td",ze,[p(d(n),{modelValue:d(t).curb_weight,"onUpdate:modelValue":e[31]||(e[31]=l=>d(t).curb_weight=l),readonly:s.readonly},null,8,["modelValue","readonly"])]),e[70]||(e[70]=a("td",{class:"cell-label"},"27. 总质量(kg)",-1)),a("td",De,[p(d(n),{modelValue:d(t).gross_weight,"onUpdate:modelValue":e[32]||(e[32]=l=>d(t).gross_weight=l),readonly:s.readonly},null,8,["modelValue","readonly"])])]),a("tr",null,[e[71]||(e[71]=a("td",{class:"cell-label"},"28. 额定载质量(kg)",-1)),a("td",Fe,[p(d(n),{modelValue:d(t).rated_load,"onUpdate:modelValue":e[33]||(e[33]=l=>d(t).rated_load=l),readonly:s.readonly},null,8,["modelValue","readonly"])]),e[72]||(e[72]=a("td",{class:"cell-label"},"29. 额定牵引总质量(kg)",-1)),a("td",Re,[p(d(n),{modelValue:d(t).rated_traction_weight,"onUpdate:modelValue":e[34]||(e[34]=l=>d(t).rated_traction_weight=l),readonly:s.readonly},null,8,["modelValue","readonly"])])]),a("tr",null,[e[73]||(e[73]=a("td",{class:"cell-label"},"30. 载质量利用系数",-1)),a("td",We,[p(d(n),{modelValue:d(t).load_utilization_factor,"onUpdate:modelValue":e[35]||(e[35]=l=>d(t).load_utilization_factor=l),readonly:s.readonly},null,8,["modelValue","readonly"])]),e[74]||(e[74]=a("td",{class:"cell-label"},"31. 准牵引总质量(kg)",-1)),a("td",qe,[p(d(n),{modelValue:d(t).allowed_traction_weight,"onUpdate:modelValue":e[36]||(e[36]=l=>d(t).allowed_traction_weight=l),readonly:s.readonly},null,8,["modelValue","readonly"])])]),a("tr",null,[e[75]||(e[75]=a("td",{class:"cell-label"},"32. 半挂车鞍座最大允许总质量(kg)",-1)),a("td",He,[p(d(n),{modelValue:d(t).semi_trailer_weight,"onUpdate:modelValue":e[37]||(e[37]=l=>d(t).semi_trailer_weight=l),readonly:s.readonly},null,8,["modelValue","readonly"])]),e[76]||(e[76]=a("td",{class:"cell-value",colspan:"4"},null,-1))]),a("tr",null,[e[77]||(e[77]=a("td",{class:"cell-label"},"33. 驾驶室准乘人数(人)",-1)),a("td",Ne,[p(d(n),{modelValue:d(t).cab_passenger_count,"onUpdate:modelValue":e[38]||(e[38]=l=>d(t).cab_passenger_count=l),readonly:s.readonly},null,8,["modelValue","readonly"])]),e[78]||(e[78]=a("td",{class:"cell-value",colspan:"4"},null,-1))]),a("tr",null,[e[79]||(e[79]=a("td",{class:"cell-label"},"34. 额定载客(人)",-1)),a("td",_e,[p(d(n),{modelValue:d(t).approved_passenger_count,"onUpdate:modelValue":e[39]||(e[39]=l=>d(t).approved_passenger_count=l),readonly:s.readonly},null,8,["modelValue","readonly"])]),e[80]||(e[80]=a("td",{class:"cell-value",colspan:"4"},null,-1))]),a("tr",null,[e[81]||(e[81]=a("td",{class:"cell-label"},"35. 车辆制造日期",-1)),a("td",Ye,[p(d(n),{modelValue:d(t).manufacture_date,"onUpdate:modelValue":e[40]||(e[40]=l=>d(t).manufacture_date=l),readonly:s.readonly,placeholder:"YYYY-MM-DD"},null,8,["modelValue","readonly"])]),e[82]||(e[82]=a("td",{class:"cell-value",colspan:"4"},null,-1))]),a("tr",null,[e[83]||(e[83]=a("td",{class:"cell-label"},"36. 备注",-1)),a("td",Ke,[p(d(n),{modelValue:d(t).cert_remark,"onUpdate:modelValue":e[41]||(e[41]=l=>d(t).cert_remark=l),readonly:s.readonly},null,8,["modelValue","readonly"])])])])])]))}},Ul=X(Qe,[["__scopeId","data-v-d1dbe8dc"]]),E=1024*1024,Ze={driving_license_main:{maxEdge:4096,targetBytes:Math.floor(2.6*E),minShortEdge:900},driving_license_sub:{maxEdge:4096,targetBytes:Math.floor(2.6*E),minShortEdge:900},vehicle_cert:{maxEdge:4096,targetBytes:Math.floor(5.2*E),minShortEdge:900},idcard_front:{maxEdge:8192,targetBytes:Math.floor(5.2*E),minShortEdge:800},idcard_back:{maxEdge:8192,targetBytes:Math.floor(5.2*E),minShortEdge:800},related:{maxEdge:4096,targetBytes:Math.floor(8*E),minShortEdge:800}};function Xe(s){return Ze[String(s||"").trim()]||{maxEdge:4096,targetBytes:Math.floor(8*E),minShortEdge:800}}function Ge(s,i,t){return Math.max(i,Math.min(t,s))}function Je(s){if(s)try{URL.revokeObjectURL(s)}catch{}}function el(s){if(String(s?.type||"").toLowerCase().startsWith("image/"))return!0;const t=String(s?.name||"").toLowerCase();return/\.(jpg|jpeg|png|bmp|webp|heic)$/i.test(t)}async function ll(s){try{return await createImageBitmap(s,{imageOrientation:"from-image"})}catch{const i=URL.createObjectURL(s);try{const t=await new Promise((g,v)=>{const u=new Image;u.crossOrigin="anonymous",u.onload=()=>g(u),u.onerror=v,u.src=i}),y=t.naturalWidth||t.width||0,c=t.naturalHeight||t.height||0;if(!y||!c)throw new Error("图片尺寸读取失败");const m=document.createElement("canvas");m.width=y,m.height=c;const f=m.getContext("2d");if(!f)throw new Error("无法获取画布上下文");return f.drawImage(t,0,0),await createImageBitmap(m)}finally{Je(i)}}}function tl(s,i,t){return new Promise(y=>{s.toBlob(c=>y(c||null),i,t)})}function nl(s){return"image/jpeg"}function ol(s){return`${(s?.name||"image").replace(/\.(jpg|jpeg|png|bmp|webp|heic)$/i,"")}.jpg`}function $(s){const i=s?.size||0;return{file:s,changed:!1,note:"",beforeBytes:i,afterBytes:i}}async function al({file:s,slotKey:i}){const t=s;if(!t)return $(t);const y=t.size||0;if(!el(t))return $(t);const c=Xe(i),m=Number(c.maxEdge)||4096,f=Number(c.targetBytes)||Math.floor(8*E),g=Number(c.minShortEdge)||800,v=y>2*E;let u=null;try{u=await ll(t);const n=u?.width||0,o=u?.height||0;if(!n||!o)return $(t);const e=Math.max(n,o),l=Math.min(n,o),r=e>m;if(!(v||r))return $(t);let S=r?m/e:1;l*S<g&&(S=Ge(g/l,.1,1));let V=.92;const b=.78,h=nl(t);let x=null,U=Number.POSITIVE_INFINITY;for(let D=0;D<10;D++){const F=Math.max(1,Math.round(n*S)),R=Math.max(1,Math.round(o*S)),T=document.createElement("canvas");T.width=F,T.height=R;const I=T.getContext("2d",{alpha:!1});if(!I)break;I.imageSmoothingEnabled=!0,I.imageSmoothingQuality="high",I.drawImage(u,0,0,F,R);const O=await tl(T,h,V);if(!O)break;const P=O.size,W=Math.max(0,P-f)+Math.max(0,P-y);if(W<U&&(U=W,x=O),P<=f){x=O;break}if(V>b)V=Math.max(b,V-.04);else{const q=S*.92;if(Math.min(n,o)*q<g)break;S=q,V=.86}}if(!x||!r&&x.size>=y)return $(t);const k=new File([x],ol(t),{type:h,lastModified:Date.now()}),B=k.size,z=B!==y||k.type!==t.type,Z=z?`已优化：${(y/E).toFixed(2)}MB → ${(B/E).toFixed(2)}MB（最长边≤${m}px，Q≥${.78}）`:"";return{file:k,changed:z,note:Z,beforeBytes:y,afterBytes:B}}catch(n){return console.warn("[图片预处理失败，已自动跳过]",n),$(t)}finally{try{u&&typeof u.close=="function"&&u.close()}catch{}}}const sl={vehicle_cert:"cert",idcard_front:"idcard",idcard_back:"idcard",driving_license_main:"dl",driving_license_sub:"dl",related:"backup"};function j(s,i){const t=new Error(String(s||"上传失败"));return i&&(t.__debug=typeof i=="string"?i:JSON.stringify(i)),t}function rl(s){const i=String(s||"").trim(),t=sl[i];if(!t)throw j("上传失败：图片类型不支持或参数异常",{slotKey:i});return t}function N(s){return Array.from(s).map(i=>i.toString(16).padStart(2,"0")).join("")}function dl(s){const i=new Uint8Array(s),t=i.length;function y(V,b,h,x,U,k){return b=b+V+x+k|0,(b<<U|b>>>32-U)+h|0}function c(V,b,h,x,U,k,B){return y(b&h|~b&x,V,b,U,k,B)}function m(V,b,h,x,U,k,B){return y(b&x|h&~x,V,b,U,k,B)}function f(V,b,h,x,U,k,B){return y(b^h^x,V,b,U,k,B)}function g(V,b,h,x,U,k,B){return y(h^(b|~x),V,b,U,k,B)}const v=(t+8>>>6<<4)+16,u=new Uint32Array(v);let n;for(n=0;n<t;n++)u[n>>2]|=i[n]<<n%4*8;u[n>>2]|=128<<n%4*8,u[v-2]=t*8>>>0,u[v-1]=t*8/4294967296>>>0;let o=1732584193,e=-271733879,l=-1732584194,r=271733878;for(n=0;n<u.length;n+=16){const V=o,b=e,h=l,x=r;o=c(o,e,l,r,u[n+0],7,-680876936),r=c(r,o,e,l,u[n+1],12,-389564586),l=c(l,r,o,e,u[n+2],17,606105819),e=c(e,l,r,o,u[n+3],22,-1044525330),o=c(o,e,l,r,u[n+4],7,-176418897),r=c(r,o,e,l,u[n+5],12,1200080426),l=c(l,r,o,e,u[n+6],17,-1473231341),e=c(e,l,r,o,u[n+7],22,-45705983),o=c(o,e,l,r,u[n+8],7,1770035416),r=c(r,o,e,l,u[n+9],12,-1958414417),l=c(l,r,o,e,u[n+10],17,-42063),e=c(e,l,r,o,u[n+11],22,-1990404162),o=c(o,e,l,r,u[n+12],7,1804603682),r=c(r,o,e,l,u[n+13],12,-40341101),l=c(l,r,o,e,u[n+14],17,-1502002290),e=c(e,l,r,o,u[n+15],22,1236535329),o=m(o,e,l,r,u[n+1],5,-165796510),r=m(r,o,e,l,u[n+6],9,-1069501632),l=m(l,r,o,e,u[n+11],14,643717713),e=m(e,l,r,o,u[n+0],20,-373897302),o=m(o,e,l,r,u[n+5],5,-701558691),r=m(r,o,e,l,u[n+10],9,38016083),l=m(l,r,o,e,u[n+15],14,-660478335),e=m(e,l,r,o,u[n+4],20,-405537848),o=m(o,e,l,r,u[n+9],5,568446438),r=m(r,o,e,l,u[n+14],9,-1019803690),l=m(l,r,o,e,u[n+3],14,-187363961),e=m(e,l,r,o,u[n+8],20,1163531501),o=m(o,e,l,r,u[n+13],5,-1444681467),r=m(r,o,e,l,u[n+2],9,-51403784),l=m(l,r,o,e,u[n+7],14,1735328473),e=m(e,l,r,o,u[n+12],20,-1926607734),o=f(o,e,l,r,u[n+5],4,-378558),r=f(r,o,e,l,u[n+8],11,-2022574463),l=f(l,r,o,e,u[n+11],16,1839030562),e=f(e,l,r,o,u[n+14],23,-35309556),o=f(o,e,l,r,u[n+1],4,-1530992060),r=f(r,o,e,l,u[n+4],11,1272893353),l=f(l,r,o,e,u[n+7],16,-155497632),e=f(e,l,r,o,u[n+10],23,-1094730640),o=f(o,e,l,r,u[n+13],4,681279174),r=f(r,o,e,l,u[n+0],11,-358537222),l=f(l,r,o,e,u[n+3],16,-722521979),e=f(e,l,r,o,u[n+6],23,76029189),o=f(o,e,l,r,u[n+9],4,-640364487),r=f(r,o,e,l,u[n+12],11,-421815835),l=f(l,r,o,e,u[n+15],16,530742520),e=f(e,l,r,o,u[n+2],23,-995338651),o=g(o,e,l,r,u[n+0],6,-198630844),r=g(r,o,e,l,u[n+7],10,1126891415),l=g(l,r,o,e,u[n+14],15,-1416354905),e=g(e,l,r,o,u[n+5],21,-57434055),o=g(o,e,l,r,u[n+12],6,1700485571),r=g(r,o,e,l,u[n+3],10,-1894986606),l=g(l,r,o,e,u[n+10],15,-1051523),e=g(e,l,r,o,u[n+1],21,-2054922799),o=g(o,e,l,r,u[n+8],6,1873313359),r=g(r,o,e,l,u[n+15],10,-30611744),l=g(l,r,o,e,u[n+6],15,-1560198380),e=g(e,l,r,o,u[n+13],21,1309151649),o=g(o,e,l,r,u[n+4],6,-145523070),r=g(r,o,e,l,u[n+11],10,-1120210379),l=g(l,r,o,e,u[n+2],15,718787259),e=g(e,l,r,o,u[n+9],21,-343485551),o=o+V|0,e=e+b|0,l=l+h|0,r=r+x|0}const w=new Uint8Array(16),S=[o,e,l,r];for(let V=0;V<4;V++){const b=S[V];w[V*4+0]=b&255,w[V*4+1]=b>>>8&255,w[V*4+2]=b>>>16&255,w[V*4+3]=b>>>24&255}return N(w)}async function ul(s){const i=await s.arrayBuffer();return dl(i)}function _(){return new Date().toISOString().replace(/\.\d{3}Z$/,"Z")}function L(s,i=!0){const t=encodeURIComponent(String(s));return i?t:t.replace(/%2F/gi,"/")}function il(s,i){const t=[],y=Array.from(new Set(i.map(c=>String(c).trim().toLowerCase()))).sort();for(const c of y){const m=(s[c]??"").toString().trim();m&&t.push(`${L(c)}:${L(m)}`)}return t.sort().join(`
`)}function cl(s){return s instanceof Uint8Array?s:s instanceof ArrayBuffer?new Uint8Array(s):ArrayBuffer.isView(s)?new Uint8Array(s.buffer):null}async function Y(s,i){const t=new TextEncoder,y=t.encode(String(i));let c=cl(s);c||(c=t.encode(String(s)));const m=await crypto.subtle.importKey("raw",c,{name:"HMAC",hash:"SHA-256"},!1,["sign"]),f=await crypto.subtle.sign("HMAC",m,y);return new Uint8Array(f)}async function ml(s,i){const t=await Y(s,i);return N(t)}async function K({ak:s,sk:i,method:t,path:y,timestamp:c,expireSeconds:m=1800,headersToSign:f,headers:g}){const v=`bce-auth-v1/${s}/${c}/${m}`,u=await Y(i,v),n=L(y,!1),o="",e=il(g,f),l=[t.toUpperCase(),n,o,e].join(`
`),r=await ml(u,l),w=Array.from(new Set(f.map(S=>String(S).toLowerCase()))).sort().join(";");return`${v}/${w}/${r}`}function yl(s){const i=(s?.name||"").toLowerCase();if(i.endsWith(".jpeg")||i.endsWith(".jpg"))return".jpg";if(i.endsWith(".png"))return".png";if(i.endsWith(".webp"))return".webp";if(i.endsWith(".bmp"))return".bmp";if(i.endsWith(".heic"))return".heic";const t=(s?.type||"").toLowerCase();return t.includes("jpeg")?".jpg":t.includes("png")?".png":t.includes("webp")?".webp":".bin"}function fl({slotKey:s,md5:i,file:t}){const y=(i||"").toLowerCase();if(!/^[a-f0-9]{32}$/.test(y))throw j("上传失败：文件校验异常，请重试",{md5:y});const c=yl(t);return`${rl(s)}/${y.slice(0,2)}/${y.slice(2,4)}/${y}${c}`}function M(s,i){return s.headers.get(i)||s.headers.get(String(i).toLowerCase())||s.headers.get(String(i).toUpperCase())||""}async function Q(s){try{return await s.text()}catch{return""}}function gl(s,i){const t=`/${String(i||"").replace(/^\/+/,"")}`;return`https://${s}${t}`}async function pl({bosHost:s,key:i}){const t=`/${String(i||"").replace(/^\/+/,"")}`,y=`https://${s}${t}`,c=await fetch(y,{method:"HEAD",mode:"cors",credentials:"omit",cache:"no-store"});return c.status===200?{exists:!0,etag:M(c,"ETag"),mode:"public"}:c.status===404?{exists:!1,mode:"public"}:{exists:!1,mode:"public",fallback:!0,status:c.status}}async function bl({bosHost:s,key:i,sts:t}){const y=`/${String(i||"").replace(/^\/+/,"")}`,c=`https://${s}${y}`,m=_(),f={host:s,"x-bce-date":m,"x-bce-security-token":t.sessionToken},g=["host","x-bce-date","x-bce-security-token"],v=await K({ak:t.accessKeyId,sk:t.secretAccessKey,method:"HEAD",path:y,timestamp:m,expireSeconds:1800,headersToSign:g,headers:f}),u={"x-bce-date":m,"x-bce-security-token":t.sessionToken,Authorization:v};let n;try{n=await fetch(c,{method:"HEAD",mode:"cors",credentials:"omit",headers:u,cache:"no-store"})}catch(r){throw j("网络异常：无法访问存储服务，请检查网络/代理设置后重试",{step:"HEAD",url:c,error:r?.message||String(r),hint:"可能走了本机代理(如 127.0.0.1:7890) 或公司网关拦截"})}if(n.status===200)return{exists:!0,etag:M(n,"ETag"),mode:"signed"};if(n.status===404)return{exists:!1,mode:"signed"};const o=M(n,"x-bce-request-id"),e=M(n,"x-bce-debug-id");let l={};try{const r=await fetch(c,{method:"GET",mode:"cors",credentials:"omit",headers:u,cache:"no-store"}),w=await Q(r);l={get_status:r.status,get_request_id:M(r,"x-bce-request-id"),get_debug_id:M(r,"x-bce-debug-id"),get_body_preview:String(w||"").slice(0,2e3)}}catch(r){l={get_diag_failed:r?.message||String(r)}}throw j("存储服务校验失败，请稍后重试",{step:"HEAD",status:n.status,url:c,"x-bce-request-id":o,"x-bce-debug-id":e,diag:l})}async function Vl({bosHost:s,key:i,sts:t}){const y=await pl({bosHost:s,key:i});return y.exists||y.mode==="public"&&y.status===404?y:y.fallback?await bl({bosHost:s,key:i,sts:t}):y}async function vl({bosHost:s,key:i,file:t,sts:y}){const c=`/${String(i||"").replace(/^\/+/,"")}`,m=`https://${s}${c}`,f=_(),g=t?.type||"application/octet-stream",v={host:s,"content-type":g,"x-bce-date":f,"x-bce-security-token":y.sessionToken},u=["host","content-type","x-bce-date","x-bce-security-token"],n=await K({ak:y.accessKeyId,sk:y.secretAccessKey,method:"PUT",path:c,timestamp:f,expireSeconds:1800,headersToSign:u,headers:v});let o;try{o=await fetch(m,{method:"PUT",mode:"cors",credentials:"omit",headers:{"x-bce-date":f,"x-bce-security-token":y.sessionToken,Authorization:n,"Content-Type":g},body:t,cache:"no-store"})}catch(w){throw j("网络异常：上传失败，请检查网络/代理设置后重试",{step:"PUT",url:m,error:w?.message||String(w),hint:"可能走了本机代理(如 127.0.0.1:7890) 或公司网关拦截"})}if(o.status>=200&&o.status<300)return{etag:M(o,"ETag")};const e=M(o,"x-bce-request-id"),l=M(o,"x-bce-debug-id"),r=await Q(o);throw j("存储服务上传失败，请稍后重试",{step:"PUT",status:o.status,url:m,"x-bce-request-id":e,"x-bce-debug-id":l,body_preview:String(r||"").slice(0,2e3)})}async function kl({bosHost:s,slotKey:i,file:t,sts:y}){const c=await al({file:t,slotKey:i}),m=c?.file||t,f=await ul(m),g=fl({slotKey:i,md5:f,file:m});let v;try{v=await Vl({bosHost:s,key:g,sts:y})}catch(n){throw n?.__debug&&console.warn("[BOS 上传诊断] headObjectWithSts failed",n.__debug),n}let u=v.etag||"";if(!v.exists)try{u=(await vl({bosHost:s,key:g,file:m,sts:y})).etag||""}catch(n){throw n?.__debug&&console.warn("[BOS 上传诊断] putObjectWithSts failed",n.__debug),n}return{md5:f,storage_key:g,etag:u,size:m?.size||0,content_type:m?.type||"application/octet-stream",original_name:t?.name||"file",preview_url:gl(s,g),preprocess_note:c?.note||"",before_bytes:c?.beforeBytes??void 0,after_bytes:c?.afterBytes??void 0}}export{Ul as V,al as p,kl as u};
