import{b as st,u as ht}from"./vendor-vue-router-CVyACjsp.js";import{c as He,a as je,p as Vt,E as q,b as ce,d as at,t as Ut}from"./vendor-element-plus-CtVxZ4Oy.js";import{h as We}from"./http-DGyH82Tn.js";import{d as it,e as ot,u as De,c as nt,f as rt}from"./orders-DVGDUW2c.js";import{V as Ct}from"./VehicleCertTable-DMJrmHc4.js";import{p as dt,u as ut}from"./bosUpload-Bf8-Xtq-.js";import{_ as ct}from"./index-BFJc87xd.js";import{r as g,q as Je,Y as vt,ay as y,x as c,y as n,J as x,P as i,z as l,H as r,L as f,u as ae,O as H,ac as be,G as z,M as $,o as et,c as Ye,aI as xt,I as $t}from"./vendor-vue-fFWwKrgY.js";import"./vendor-lodash-rvV0CIkQ.js";import"./vendor-DWCz07M-.js";import"./vendor-dates-DVKSwKij.js";import"./vendor-axios-C0Zqfgkc.js";import"./vendor-pinia-CMXa-Za0.js";const zt={class:"order-create"},St={key:0,class:"detail-header"},Lt={class:"header-actions"},Rt={class:"upload-mode-row"},Et={class:"upload-mode"},Ot={class:"section-header"},Mt={class:"two-col"},It={class:"left"},Tt={key:0,class:"kv-grid kv-grid-2"},At={class:"kv-item"},Dt={class:"kv-value"},Bt={class:"kv-item"},Pt={class:"kv-value"},Ft={class:"kv-item"},Nt={class:"kv-value"},Gt={class:"kv-item"},qt={class:"kv-value"},Ht={key:1},jt={class:"right"},Yt={class:"upload-title"},Wt={key:0,class:"slot-sub"},Jt={key:0,class:"one-wrap"},Qt={key:1,class:"upload-empty"},Xt={key:0,class:"uploading-tip"},Zt={class:"slot-foot"},Kt={class:"slot-foot-left"},el={key:1,class:"muted"},tl={class:"slot-foot-right"},ll={class:"section-header"},sl={class:"stack"},al={class:"sub-block"},il={class:"two-col"},ol={class:"left"},nl={key:0,class:"kv-grid kv-grid-2"},rl={class:"kv-item"},dl={class:"kv-value"},ul={class:"kv-item"},cl={class:"kv-value"},vl={key:1,class:"kv-grid kv-grid-2"},_l={class:"kv-item"},pl={class:"kv-value"},ml={class:"kv-item"},fl={class:"kv-value"},gl={class:"kv-item"},kl={class:"kv-value"},yl={class:"kv-item"},bl={class:"kv-value"},wl={class:"kv-item"},hl={class:"kv-value"},Vl={class:"kv-item"},Ul={class:"kv-value"},Cl={class:"right"},xl={class:"upload-title"},$l={key:0,class:"slot-sub"},zl={key:0,class:"one-wrap"},Sl={key:1,class:"upload-empty"},Ll={key:0,class:"uploading-tip"},Rl={class:"slot-foot"},El={class:"slot-foot-left"},Ol={key:1,class:"muted"},Ml={class:"slot-foot-right"},Il={class:"sub-block"},Tl={class:"two-col"},Al={class:"left"},Dl={key:0,class:"kv-grid kv-grid-2"},Bl={class:"kv-item"},Pl={class:"kv-value"},Fl={class:"kv-item"},Nl={class:"kv-value"},Gl={class:"right"},ql={class:"upload-title"},Hl={key:0,class:"slot-sub"},jl={key:0,class:"one-wrap"},Yl={key:1,class:"upload-empty"},Wl={key:0,class:"uploading-tip"},Jl={class:"slot-foot"},Ql={class:"slot-foot-left"},Xl={key:1,class:"muted"},Zl={class:"slot-foot-right"},Kl={class:"section-header"},es={class:"stack"},ts={class:"sub-block"},ls={class:"two-col"},ss={class:"left"},as={key:0,class:"kv-grid kv-grid-2"},is={class:"kv-item"},os={class:"kv-value"},ns={key:1,class:"kv-grid kv-grid-2"},rs={class:"kv-item"},ds={class:"kv-value"},us={class:"kv-item"},cs={class:"kv-value"},vs={class:"kv-item"},_s={class:"kv-value"},ps={class:"kv-item"},ms={class:"kv-value"},fs={class:"kv-item"},gs={class:"kv-value"},ks={class:"right"},ys={class:"upload-title"},bs={key:0,class:"slot-sub"},ws={key:0,class:"one-wrap"},hs={key:1,class:"upload-empty"},Vs={key:0,class:"uploading-tip"},Us={class:"slot-foot"},Cs={class:"slot-foot-left"},xs={key:1,class:"muted"},$s={class:"slot-foot-right"},zs={class:"sub-block"},Ss={class:"two-col"},Ls={class:"left"},Rs={key:0,class:"kv-grid kv-grid-2"},Es={class:"kv-item"},Os={class:"kv-value"},Ms={class:"right"},Is={class:"upload-title"},Ts={key:0,class:"slot-sub"},As={key:0,class:"one-wrap"},Ds={key:1,class:"upload-empty"},Bs={key:0,class:"uploading-tip"},Ps={class:"slot-foot"},Fs={class:"slot-foot-left"},Ns={key:1,class:"muted"},Gs={class:"slot-foot-right"},qs={class:"upload-title"},Hs={key:0,class:"slot-sub"},js={class:"upload-trigger"},Ys={key:0,class:"uploading-tip"},Ws={class:"footer-actions"},tt="order_create_upload_mode",Js={__name:"OrderCreateForm",props:{embedded:{type:Boolean,default:!1}},setup(Qe){const ie=Qe,oe=st(),L=g(!1),ne=g(!1),X=g("smart");function Z(){const a=localStorage.getItem(tt);(a==="smart"||a==="direct"||a==="stable")&&(X.value=a)}function $e(){try{localStorage.setItem(tt,X.value)}catch{}}const we=g(null),M=g({customer_group_id:null,channel_group_id:null}),ze={customer_group_id:[{required:!0,message:"客户必选",trigger:"change"}],channel_group_id:[{required:!0,message:"渠道必选",trigger:"change"}]},W=g([]),Se=g([]);function re(a){return String(a??"").trim()}function Le(a){const e=re(a?.customer_code||a?.code||""),o=re(a?.customer_name||a?.name||""),d=re(a?.group_name||""),k=a?.id!=null?String(a.id):"";return e&&o?`${e} - ${o}`:e&&d?`${e} - ${d}`:e||o||d||k||"-"}function N(a){const e=re(a?.channel_code||a?.code||""),o=re(a?.channel_name||a?.name||""),d=re(a?.group_name||""),k=a?.id!=null?String(a.id):"";return e&&o?`${e} - ${o}`:e&&d?`${e} - ${d}`:e||o||d||k||"-"}const _=g({cert_no:"",cert_issue_date:"",manufacturer_name:"",vehicle_brand_name:"",vehicle_model:"",vin:"",body_color:"",chassis_model_id:"",chassis_cert_no:"",engine_model:"",engine_no:"",fuel_type:"",displacement_and_power:"",emission_standard:"",fuel_consumption:"",overall_dimensions:"",cargo_dimensions:"",leaf_spring_count:"",tire_count:"",tire_spec:"",wheel_track:"",wheel_base:"",axle_load_kg:"",axle_count:"",steering_type:"",curb_weight:"",gross_weight:"",rated_load:"",rated_traction_weight:"",load_utilization_factor:"",allowed_traction_weight:"",semi_trailer_weight:"",cab_passenger_count:"",approved_passenger_count:"",manufacture_date:"",cert_remark:"",id_name:"",id_number:"",id_gender:"",id_ethnicity:"",id_birth_date:"",id_address:"",id_issuer:"",id_validity:"",dl_plate_no:"",dl_vehicle_type:"",dl_owner:"",dl_use_nature:"",dl_brand_model:"",dl_attach_note:"",remark:""}),ve=g(!1),K=g(!1),ee=g(!1),Y=[{key:"vehicle_cert",label:"合格证",multiple:!1},{key:"idcard_front",label:"身份证正面",multiple:!1},{key:"idcard_back",label:"身份证反面",multiple:!1},{key:"driving_license_main",label:"行驶证主页",multiple:!1},{key:"driving_license_sub",label:"行驶证副页",multiple:!1},{key:"related",label:"相关图片(多张)",multiple:!0}];function he(a){return Y.find(e=>e.key===a)?.multiple===!0}function Re(a){return Y.find(e=>e.key===a)?.label||a}function _e(a){return he(a)?!1:(w.value[a]||[]).length>=1}function pe(a){q.warning(`${Re(a)}：请先删除当前图片，再上传新图片`)}const w=g({vehicle_cert:[],idcard_front:[],idcard_back:[],driving_license_main:[],driving_license_sub:[],related:[]}),G=g({}),V=g(0),b=g({}),I=g({}),j=g("");let E=null,T=0;function B(a){try{return Date.parse(a)}catch{return 0}}async function Ve(){const a=Date.now();if(E&&T&&a+12e4<T)return E;const o=(await We.get("/orders/bos-sts"))?.data;if(!o?.accessKeyId||!o?.secretAccessKey||!o?.sessionToken)throw new Error("获取上传凭证失败：返回数据不完整");return E=o,j.value=o.bosHost||"",T=B(o.expiration)||a+600*1e3,E}function A(a){const e=w.value[a]||[];return e.length?e[0]:null}function te(a){return(w.value[a]||[]).map(o=>o.url).filter(Boolean)}function Ee(a){const e=a?.raw;if(e&&!a.url){const o=URL.createObjectURL(e);a.url=o,I.value[a.uid]=o}}function Be(a,e){if(!a||!e)return;const o=a.uid,d=o?I.value[o]:a.url;if(d){try{URL.revokeObjectURL(d)}catch{}o&&delete I.value[o]}const k=URL.createObjectURL(e);a.raw=e,a.url=k,o&&(I.value[o]=k)}function fe(a){const e=I.value[a];if(e){try{URL.revokeObjectURL(e)}catch{}delete I.value[a]}}function le(a){const e=w.value[a]||[];for(const o of e){const d=o?.uid;d&&(G.value[d]&&delete G.value[d],b.value[d]&&delete b.value[d],fe(d))}w.value[a]=[]}function Ue(a){return/[\u4e00-\u9fa5]/.test(String(a||""))}function Ce(a){const e=a?.response?.data?.detail||a?.response?.data?.message||a?.message||"";return String(e||"")}function ge(a,e="操作失败，请稍后重试"){const o=a?.response?.data?.detail,d=Ce(a),k=a?.response?.status,U=String(a?.code||"");if(typeof o=="string"&&o&&Ue(o))return o;if(d&&Ue(d))return d;const F=d.toLowerCase();return F.includes("network error")||F.includes("failed to fetch")?"网络异常，请检查网络连接":F.includes("timeout")||U.includes("ECONNABORTED")?"请求超时，请稍后重试":F.includes("cors")?"跨域受限或网络拦截，请切换网络后重试":k===401?"登录状态已失效，请重新登录":k===403?"无权限执行该操作":k>=500?"服务器异常，请稍后重试":e}function Oe(a){const e=Ce(a).toLowerCase();return e.includes("failed to fetch")||e.includes("network error")||e.includes("err_")||e.includes("cors")||e.includes("代理")||e.includes("vpn")||e.includes("127.0.0.1:7890")}async function Pe(){try{return await at.confirm(`上传可能被当前网络环境拦截（常见于 VPN/代理/公司网关）。

建议切换到【稳定模式上传】继续，无需任何设置。`,"上传失败（网络拦截）",{confirmButtonText:"切换为稳定模式",cancelButtonText:"继续直传重试",type:"warning",center:!0,distinguishCancelAndClose:!0}),X.value="stable",$e(),!0}catch{return!1}}function de(a,e){le(a),Ee(e),w.value[a]=[e],xe(a,e).catch(o=>{console.error(o),ce({title:"上传失败",message:ge(o,"上传失败，请稍后重试"),type:"error",duration:4500})})}function Me(a,e,o){w.value[a]=Array.isArray(o)?o:[],Ee(e),xe(a,e).catch(d=>{console.error(d),ce({title:"上传失败",message:ge(d,"上传失败，请稍后重试"),type:"error",duration:4500})})}function Ie(a,e,o){w.value[a]=Array.isArray(o)?o:[];const d=e?.uid;d&&G.value[d]&&delete G.value[d],d&&b.value[d]&&delete b.value[d],d&&fe(d)}async function xe(a,e){const o=e?.raw;if(o&&!G.value[e.uid]){V.value+=1,b.value[e.uid]={status:"uploading"};try{let d=o;try{const F=await dt({file:o,slotKey:a});F?.file&&(d=F.file,Be(e,d))}catch{d=o}if(X.value==="stable"){const C=(await De({slot_key:a,file:d}))?.data||{};G.value[e.uid]={slot_key:a,md5:C?.md5,storage_key:C?.storage_key,etag:C?.etag||"",size:C?.size||d.size||0,content_type:C?.content_type||d.type||"application/octet-stream",original_name:C?.original_name||d.name||"file",preview_url:C?.preview_url||""},C?.preview_url&&(e.url=C.preview_url),b.value[e.uid]={status:"done"};return}const k=await Ve();if(!j.value)throw new Error("bosHost missing");const U=await ut({bosHost:j.value,slotKey:a,file:d,sts:k});U?.preview_url&&(e.url=U.preview_url),G.value[e.uid]={slot_key:a,...U,size:U?.size||d.size||0,content_type:U?.content_type||d.type||"application/octet-stream",original_name:U?.original_name||d.name||"file"},b.value[e.uid]={status:"done"}}catch(d){if(X.value==="smart"&&Oe(d)&&await Pe())try{const U=e?.raw||o,C=(await De({slot_key:a,file:U}))?.data||{};G.value[e.uid]={slot_key:a,md5:C?.md5,storage_key:C?.storage_key,etag:C?.etag||"",size:C?.size||U.size||0,content_type:C?.content_type||U.type||"application/octet-stream",original_name:C?.original_name||U.name||"file",preview_url:C?.preview_url||""},C?.preview_url&&(e.url=C.preview_url),b.value[e.uid]={status:"done"};return}catch(U){throw b.value[e.uid]={status:"error"},U}throw b.value[e.uid]={status:"error"},d}finally{V.value-=1}}}function h(a){const e=w.value[a]||[];let o=0;for(const d of e)G.value[d.uid]&&(o+=1);return o}function P(a){const e=w.value[a]||[];let o=0;for(const d of e)b.value[d.uid]?.status==="uploading"&&(o+=1);return o}function Fe(){M.value={customer_group_id:null,channel_group_id:null};for(const a of Object.keys(_.value))_.value[a]="";ve.value=!1,K.value=!1,ee.value=!1;for(const a of Y)le(a.key);G.value={},b.value={}}function Te(){const a={..._.value};for(const[e,o]of Object.entries(a))(o===""||o===null||o===void 0)&&delete a[e];return a}function Ae(){const a=[];for(const e of Y){const o=w.value[e.key]||[];for(const d of o){const k=G.value[d.uid];k&&a.push({slot_key:k.slot_key,storage_key:k.storage_key,md5:k.md5,size:k.size||0,content_type:k.content_type??void 0,etag:k.etag??void 0,original_name:k.original_name??void 0})}}return a}async function Ne(){try{await we.value?.validate?.()}catch{q.warning("客户群、渠道群为必选项，请先选择");return}if(V.value>0){q.warning("还有文件在上传中，请稍后再提交");return}L.value=!0;try{const a=Te(),e=Ae(),o=await nt({module:"order",dynamic_data:a||{},customer_group_id:M.value.customer_group_id??void 0,channel_group_id:M.value.channel_group_id??void 0}),k=(o?.data?.data??o?.data??o)?.order_id;if(!k)throw new Error("draft failed: missing order_id");await rt({order_id:k,images:e,dynamic_data:a||{},customer_group_id:M.value.customer_group_id??void 0,channel_group_id:M.value.channel_group_id??void 0}),e.length>0?ce({title:"创建成功",message:"订单已创建并提交识别任务，稍后可在订单详情查看回填结果。",type:"success",duration:3500}):q.success("订单创建成功"),oe.push({path:`/orders/${k}`})}catch(a){console.error(a),q.error(`提交失败：${ge(a,"提交失败，请稍后重试")}`)}finally{L.value=!1}}async function me(){ne.value=!0;try{const[a,e]=await Promise.all([it(),ot()]);W.value=a?.data?.items||a?.data||[],Se.value=e?.data?.items||e?.data||[]}catch(a){console.error(a),q.error("加载客户/渠道分组失败")}finally{ne.value=!1}}return Je(()=>{Z(),me()}),vt(()=>{for(const a of Object.keys(I.value))fe(a)}),(a,e)=>{const o=y("el-button"),d=y("el-option"),k=y("el-select"),U=y("el-card"),F=y("el-form-item"),C=y("el-col"),Ge=y("el-row"),qe=y("el-form"),J=y("el-icon"),S=y("el-input"),ue=y("el-image"),s=y("el-upload");return n(),c("div",zt,[ie.embedded?x("",!0):(n(),c("div",St,[e[34]||(e[34]=l("h2",null,"手动新建订单",-1)),l("div",Lt,[i(o,{size:"small",onClick:e[0]||(e[0]=t=>ae(oe).back())},{default:r(()=>[...e[33]||(e[33]=[f("返回",-1)])]),_:1})])])),i(U,{shadow:"never",class:"section-card"},{default:r(()=>[l("div",Rt,[l("div",Et,[e[35]||(e[35]=l("span",{class:"upload-mode-label"},"上传模式",-1)),i(k,{modelValue:X.value,"onUpdate:modelValue":e[1]||(e[1]=t=>X.value=t),size:"small",style:{width:"160px"},onChange:$e},{default:r(()=>[i(d,{label:"智能（推荐）",value:"smart"}),i(d,{label:"直传（更快）",value:"direct"}),i(d,{label:"稳定（兼容VPN）",value:"stable"})]),_:1},8,["modelValue"])]),e[36]||(e[36]=l("div",{class:"upload-mode-tip"},"图片上传失败时，智能模式会提示切换到稳定模式",-1))])]),_:1}),i(U,{shadow:"never",class:"section-card meta-card"},{header:r(()=>[...e[37]||(e[37]=[l("div",{class:"section-header"},[l("div",{class:"section-title"},"基础信息")],-1)])]),default:r(()=>[i(qe,{ref_key:"metaFormRef",ref:we,model:M.value,rules:ze,"label-width":"80px"},{default:r(()=>[i(Ge,{gutter:12},{default:r(()=>[i(C,{span:12},{default:r(()=>[i(F,{label:"客户群",prop:"customer_group_id"},{default:r(()=>[i(k,{modelValue:M.value.customer_group_id,"onUpdate:modelValue":e[2]||(e[2]=t=>M.value.customer_group_id=t),clearable:"",filterable:"",placeholder:"必选",class:"fv fv-select",style:{width:"100%"},loading:ne.value,disabled:ne.value},{default:r(()=>[(n(!0),c(H,null,be(W.value,t=>(n(),z(d,{key:String(t.id),label:Le(t),value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","loading","disabled"])]),_:1})]),_:1}),i(C,{span:12},{default:r(()=>[i(F,{label:"渠道群",prop:"channel_group_id"},{default:r(()=>[i(k,{modelValue:M.value.channel_group_id,"onUpdate:modelValue":e[3]||(e[3]=t=>M.value.channel_group_id=t),clearable:"",filterable:"",placeholder:"必选",class:"fv fv-select",style:{width:"100%"},loading:ne.value,disabled:ne.value},{default:r(()=>[(n(!0),c(H,null,be(Se.value,t=>(n(),z(d,{key:String(t.id),label:N(t),value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","loading","disabled"])]),_:1})]),_:1})]),_:1})]),_:1},8,["model"])]),_:1}),i(U,{shadow:"never",class:"section-card"},{header:r(()=>[l("div",Ot,[e[38]||(e[38]=l("div",{class:"section-title"},"车辆合格证",-1)),i(o,{class:"icon-btn",circle:"",size:"small",onClick:e[4]||(e[4]=t=>ve.value=!ve.value)},{default:r(()=>[i(J,null,{default:r(()=>[ve.value?(n(),z(ae(He),{key:0})):(n(),z(ae(je),{key:1}))]),_:1})]),_:1})])]),default:r(()=>[l("div",Mt,[l("div",It,[ve.value?(n(),c("div",Ht,[i(Ct,{data:_.value,readonly:!1},null,8,["data"])])):(n(),c("div",Tt,[l("div",At,[e[39]||(e[39]=l("div",{class:"kv-label"},"车辆型号",-1)),l("div",Dt,[i(S,{modelValue:_.value.vehicle_model,"onUpdate:modelValue":e[5]||(e[5]=t=>_.value.vehicle_model=t),placeholder:"车辆型号",clearable:"",class:"fv fv-input"},null,8,["modelValue"])])]),l("div",Bt,[e[40]||(e[40]=l("div",{class:"kv-label"},"车辆识别代码/车架号",-1)),l("div",Pt,[i(S,{modelValue:_.value.vin,"onUpdate:modelValue":e[6]||(e[6]=t=>_.value.vin=t),placeholder:"车架号",clearable:"",class:"fv fv-input"},null,8,["modelValue"])])]),l("div",Ft,[e[41]||(e[41]=l("div",{class:"kv-label"},"发动机号",-1)),l("div",Nt,[i(S,{modelValue:_.value.engine_no,"onUpdate:modelValue":e[7]||(e[7]=t=>_.value.engine_no=t),placeholder:"发动机号",clearable:"",class:"fv fv-input"},null,8,["modelValue"])])]),l("div",Gt,[e[42]||(e[42]=l("div",{class:"kv-label"},"额定载客(人)",-1)),l("div",qt,[i(S,{modelValue:_.value.approved_passenger_count,"onUpdate:modelValue":e[8]||(e[8]=t=>_.value.approved_passenger_count=t),placeholder:"额定载客(人)",clearable:"",class:"fv fv-input"},null,8,["modelValue"])])])]))]),l("div",jt,[l("div",Yt,[e[45]||(e[45]=l("span",null,"合格证图片",-1)),h("vehicle_cert")>0?(n(),c("span",Wt,[f(" （已就绪 "+$(h("vehicle_cert"))+" 张 ",1),e[43]||(e[43]=l("span",{class:"ready-dot","aria-hidden":"true"},null,-1)),e[44]||(e[44]=f("） ",-1))])):x("",!0)]),i(s,{drag:"","auto-upload":!1,multiple:!1,limit:1,"show-file-list":!1,"file-list":w.value.vehicle_cert,disabled:_e("vehicle_cert")||L.value||V.value>0,"on-change":t=>de("vehicle_cert",t),"on-exceed":()=>pe("vehicle_cert"),accept:"image/*",class:"upload-box upload-one"},{default:r(()=>[A("vehicle_cert")?(n(),c("div",Jt,[i(ue,{src:A("vehicle_cert")?.url,"preview-src-list":te("vehicle_cert"),fit:"contain",class:"one-img"},null,8,["src","preview-src-list"]),e[46]||(e[46]=l("div",{class:"one-mask"},[l("div",{class:"one-mask-text"},"已上传，删除后可重新上传")],-1))])):(n(),c("div",Qt,[...e[47]||(e[47]=[l("div",{class:"empty-center"},[l("div",{class:"empty-title"},"拖拽图片到此处"),l("div",{class:"empty-sub"},"或点击选择文件")],-1)])]))]),_:1},8,["file-list","disabled","on-change","on-exceed"]),P("vehicle_cert")>0?(n(),c("div",Xt," 正在上传："+$(P("vehicle_cert"))+" 个文件…（上传完成后才能提交） ",1)):x("",!0),l("div",Zt,[l("div",Kt,[h("vehicle_cert")>0?(n(),c(H,{key:0},[l("span",null,"已就绪："+$(h("vehicle_cert"))+" 张",1),e[48]||(e[48]=l("span",{class:"ready-dot","aria-hidden":"true"},null,-1))],64)):(n(),c("span",el,"未上传"))]),l("div",tl,[(w.value.vehicle_cert||[]).length?(n(),z(o,{key:0,size:"small",type:"danger",link:"",class:"slot-remove",disabled:L.value||V.value>0,onClick:e[9]||(e[9]=t=>le("vehicle_cert"))},{default:r(()=>[...e[49]||(e[49]=[f(" 移除 ",-1)])]),_:1},8,["disabled"])):x("",!0)])])])])]),_:1}),i(U,{shadow:"never",class:"section-card"},{header:r(()=>[l("div",ll,[e[50]||(e[50]=l("div",{class:"section-title"},"身份证正面/身份证背面",-1)),i(o,{class:"icon-btn",circle:"",size:"small",onClick:e[10]||(e[10]=t=>K.value=!K.value)},{default:r(()=>[i(J,null,{default:r(()=>[K.value?(n(),z(ae(He),{key:0})):(n(),z(ae(je),{key:1}))]),_:1})]),_:1})])]),default:r(()=>[l("div",sl,[l("div",al,[e[66]||(e[66]=l("div",{class:"sub-title"},"身份证正面",-1)),l("div",il,[l("div",ol,[K.value?(n(),c("div",vl,[l("div",_l,[e[53]||(e[53]=l("div",{class:"kv-label"},"姓名",-1)),l("div",pl,[i(S,{modelValue:_.value.id_name,"onUpdate:modelValue":e[13]||(e[13]=t=>_.value.id_name=t),placeholder:"姓名",clearable:"",class:"fv fv-input"},null,8,["modelValue"])])]),l("div",ml,[e[54]||(e[54]=l("div",{class:"kv-label"},"公民身份号码",-1)),l("div",fl,[i(S,{modelValue:_.value.id_number,"onUpdate:modelValue":e[14]||(e[14]=t=>_.value.id_number=t),placeholder:"身份证号",clearable:"",class:"fv fv-input"},null,8,["modelValue"])])]),l("div",gl,[e[55]||(e[55]=l("div",{class:"kv-label"},"性别",-1)),l("div",kl,[i(S,{modelValue:_.value.id_gender,"onUpdate:modelValue":e[15]||(e[15]=t=>_.value.id_gender=t),placeholder:"性别",clearable:"",class:"fv fv-input"},null,8,["modelValue"])])]),l("div",yl,[e[56]||(e[56]=l("div",{class:"kv-label"},"民族",-1)),l("div",bl,[i(S,{modelValue:_.value.id_ethnicity,"onUpdate:modelValue":e[16]||(e[16]=t=>_.value.id_ethnicity=t),placeholder:"民族",clearable:"",class:"fv fv-input"},null,8,["modelValue"])])]),l("div",wl,[e[57]||(e[57]=l("div",{class:"kv-label"},"出生日期",-1)),l("div",hl,[i(S,{modelValue:_.value.id_birth_date,"onUpdate:modelValue":e[17]||(e[17]=t=>_.value.id_birth_date=t),placeholder:"YYYY-MM-DD",clearable:"",class:"fv fv-input"},null,8,["modelValue"])])]),l("div",Vl,[e[58]||(e[58]=l("div",{class:"kv-label"},"住址",-1)),l("div",Ul,[i(S,{modelValue:_.value.id_address,"onUpdate:modelValue":e[18]||(e[18]=t=>_.value.id_address=t),placeholder:"住址",clearable:"",class:"fv fv-input"},null,8,["modelValue"])])])])):(n(),c("div",nl,[l("div",rl,[e[51]||(e[51]=l("div",{class:"kv-label"},"姓名",-1)),l("div",dl,[i(S,{modelValue:_.value.id_name,"onUpdate:modelValue":e[11]||(e[11]=t=>_.value.id_name=t),placeholder:"姓名",clearable:"",class:"fv fv-input"},null,8,["modelValue"])])]),l("div",ul,[e[52]||(e[52]=l("div",{class:"kv-label"},"公民身份号码",-1)),l("div",cl,[i(S,{modelValue:_.value.id_number,"onUpdate:modelValue":e[12]||(e[12]=t=>_.value.id_number=t),placeholder:"身份证号",clearable:"",class:"fv fv-input"},null,8,["modelValue"])])])]))]),l("div",Cl,[l("div",xl,[e[61]||(e[61]=l("span",null,"身份证正面图片",-1)),h("idcard_front")>0?(n(),c("span",$l,[f(" （已就绪 "+$(h("idcard_front"))+" 张 ",1),e[59]||(e[59]=l("span",{class:"ready-dot","aria-hidden":"true"},null,-1)),e[60]||(e[60]=f("） ",-1))])):x("",!0)]),i(s,{drag:"","auto-upload":!1,multiple:!1,limit:1,"show-file-list":!1,"file-list":w.value.idcard_front,disabled:_e("idcard_front")||L.value||V.value>0,"on-change":t=>de("idcard_front",t),"on-exceed":()=>pe("idcard_front"),accept:"image/*",class:"upload-box upload-one"},{default:r(()=>[A("idcard_front")?(n(),c("div",zl,[i(ue,{src:A("idcard_front")?.url,"preview-src-list":te("idcard_front"),fit:"contain",class:"one-img"},null,8,["src","preview-src-list"]),e[62]||(e[62]=l("div",{class:"one-mask"},[l("div",{class:"one-mask-text"},"已上传，删除后可重新上传")],-1))])):(n(),c("div",Sl,[...e[63]||(e[63]=[l("div",{class:"empty-center"},[l("div",{class:"empty-title"},"拖拽图片到此处"),l("div",{class:"empty-sub"},"或点击选择文件")],-1)])]))]),_:1},8,["file-list","disabled","on-change","on-exceed"]),P("idcard_front")>0?(n(),c("div",Ll," 正在上传："+$(P("idcard_front"))+" 个文件…（上传完成后才能提交） ",1)):x("",!0),l("div",Rl,[l("div",El,[h("idcard_front")>0?(n(),c(H,{key:0},[l("span",null,"已就绪："+$(h("idcard_front"))+" 张",1),e[64]||(e[64]=l("span",{class:"ready-dot","aria-hidden":"true"},null,-1))],64)):(n(),c("span",Ol,"未上传"))]),l("div",Ml,[(w.value.idcard_front||[]).length?(n(),z(o,{key:0,size:"small",type:"danger",link:"",class:"slot-remove",disabled:L.value||V.value>0,onClick:e[19]||(e[19]=t=>le("idcard_front"))},{default:r(()=>[...e[65]||(e[65]=[f(" 移除 ",-1)])]),_:1},8,["disabled"])):x("",!0)])])])])]),l("div",Il,[e[76]||(e[76]=l("div",{class:"sub-title"},"身份证背面",-1)),l("div",Tl,[l("div",Al,[K.value?(n(),c("div",Dl,[l("div",Bl,[e[67]||(e[67]=l("div",{class:"kv-label"},"签发机关",-1)),l("div",Pl,[i(S,{modelValue:_.value.id_issuer,"onUpdate:modelValue":e[20]||(e[20]=t=>_.value.id_issuer=t),placeholder:"签发机关",clearable:"",class:"fv fv-input"},null,8,["modelValue"])])]),l("div",Fl,[e[68]||(e[68]=l("div",{class:"kv-label"},"有效期限",-1)),l("div",Nl,[i(S,{modelValue:_.value.id_validity,"onUpdate:modelValue":e[21]||(e[21]=t=>_.value.id_validity=t),placeholder:"例如：2020-01-01~2040-01-01",clearable:"",class:"fv fv-input"},null,8,["modelValue"])])])])):x("",!0)]),l("div",Gl,[l("div",ql,[e[71]||(e[71]=l("span",null,"身份证背面图片",-1)),h("idcard_back")>0?(n(),c("span",Hl,[f(" （已就绪 "+$(h("idcard_back"))+" 张 ",1),e[69]||(e[69]=l("span",{class:"ready-dot","aria-hidden":"true"},null,-1)),e[70]||(e[70]=f("） ",-1))])):x("",!0)]),i(s,{drag:"","auto-upload":!1,multiple:!1,limit:1,"show-file-list":!1,"file-list":w.value.idcard_back,disabled:_e("idcard_back")||L.value||V.value>0,"on-change":t=>de("idcard_back",t),"on-exceed":()=>pe("idcard_back"),accept:"image/*",class:"upload-box upload-one"},{default:r(()=>[A("idcard_back")?(n(),c("div",jl,[i(ue,{src:A("idcard_back")?.url,"preview-src-list":te("idcard_back"),fit:"contain",class:"one-img"},null,8,["src","preview-src-list"]),e[72]||(e[72]=l("div",{class:"one-mask"},[l("div",{class:"one-mask-text"},"已上传，删除后可重新上传")],-1))])):(n(),c("div",Yl,[...e[73]||(e[73]=[l("div",{class:"empty-center"},[l("div",{class:"empty-title"},"拖拽图片到此处"),l("div",{class:"empty-sub"},"或点击选择文件")],-1)])]))]),_:1},8,["file-list","disabled","on-change","on-exceed"]),P("idcard_back")>0?(n(),c("div",Wl," 正在上传："+$(P("idcard_back"))+" 个文件…（上传完成后才能提交） ",1)):x("",!0),l("div",Jl,[l("div",Ql,[h("idcard_back")>0?(n(),c(H,{key:0},[l("span",null,"已就绪："+$(h("idcard_back"))+" 张",1),e[74]||(e[74]=l("span",{class:"ready-dot","aria-hidden":"true"},null,-1))],64)):(n(),c("span",Xl,"未上传"))]),l("div",Zl,[(w.value.idcard_back||[]).length?(n(),z(o,{key:0,size:"small",type:"danger",link:"",class:"slot-remove",disabled:L.value||V.value>0,onClick:e[22]||(e[22]=t=>le("idcard_back"))},{default:r(()=>[...e[75]||(e[75]=[f(" 移除 ",-1)])]),_:1},8,["disabled"])):x("",!0)])])])])])])]),_:1}),i(U,{shadow:"never",class:"section-card"},{header:r(()=>[l("div",Kl,[e[77]||(e[77]=l("div",{class:"section-title"},"行驶证/行驶证副件",-1)),i(o,{class:"icon-btn",circle:"",size:"small",onClick:e[23]||(e[23]=t=>ee.value=!ee.value)},{default:r(()=>[i(J,null,{default:r(()=>[ee.value?(n(),z(ae(He),{key:0})):(n(),z(ae(je),{key:1}))]),_:1})]),_:1})])]),default:r(()=>[l("div",es,[l("div",ts,[e[91]||(e[91]=l("div",{class:"sub-title"},"行驶证主页",-1)),l("div",ls,[l("div",ss,[ee.value?(n(),c("div",ns,[l("div",rs,[e[79]||(e[79]=l("div",{class:"kv-label"},"号牌号码",-1)),l("div",ds,[i(S,{modelValue:_.value.dl_plate_no,"onUpdate:modelValue":e[25]||(e[25]=t=>_.value.dl_plate_no=t),placeholder:"车牌号",clearable:"",class:"fv fv-input"},null,8,["modelValue"])])]),l("div",us,[e[80]||(e[80]=l("div",{class:"kv-label"},"车辆类型",-1)),l("div",cs,[i(S,{modelValue:_.value.dl_vehicle_type,"onUpdate:modelValue":e[26]||(e[26]=t=>_.value.dl_vehicle_type=t),placeholder:"车辆类型",clearable:"",class:"fv fv-input"},null,8,["modelValue"])])]),l("div",vs,[e[81]||(e[81]=l("div",{class:"kv-label"},"所有人",-1)),l("div",_s,[i(S,{modelValue:_.value.dl_owner,"onUpdate:modelValue":e[27]||(e[27]=t=>_.value.dl_owner=t),placeholder:"所有人",clearable:"",class:"fv fv-input"},null,8,["modelValue"])])]),l("div",ps,[e[82]||(e[82]=l("div",{class:"kv-label"},"使用性质",-1)),l("div",ms,[i(S,{modelValue:_.value.dl_use_nature,"onUpdate:modelValue":e[28]||(e[28]=t=>_.value.dl_use_nature=t),placeholder:"使用性质",clearable:"",class:"fv fv-input"},null,8,["modelValue"])])]),l("div",fs,[e[83]||(e[83]=l("div",{class:"kv-label"},"品牌型号",-1)),l("div",gs,[i(S,{modelValue:_.value.dl_brand_model,"onUpdate:modelValue":e[29]||(e[29]=t=>_.value.dl_brand_model=t),placeholder:"品牌型号",clearable:"",class:"fv fv-input"},null,8,["modelValue"])])])])):(n(),c("div",as,[l("div",is,[e[78]||(e[78]=l("div",{class:"kv-label"},"号牌号码",-1)),l("div",os,[i(S,{modelValue:_.value.dl_plate_no,"onUpdate:modelValue":e[24]||(e[24]=t=>_.value.dl_plate_no=t),placeholder:"车牌号",clearable:"",class:"fv fv-input"},null,8,["modelValue"])])])]))]),l("div",ks,[l("div",ys,[e[86]||(e[86]=l("span",null,"行驶证主页图片",-1)),h("driving_license_main")>0?(n(),c("span",bs,[f(" （已就绪 "+$(h("driving_license_main"))+" 张 ",1),e[84]||(e[84]=l("span",{class:"ready-dot","aria-hidden":"true"},null,-1)),e[85]||(e[85]=f("） ",-1))])):x("",!0)]),i(s,{drag:"","auto-upload":!1,multiple:!1,limit:1,"show-file-list":!1,"file-list":w.value.driving_license_main,disabled:_e("driving_license_main")||L.value||V.value>0,"on-change":t=>de("driving_license_main",t),"on-exceed":()=>pe("driving_license_main"),accept:"image/*",class:"upload-box upload-one"},{default:r(()=>[A("driving_license_main")?(n(),c("div",ws,[i(ue,{src:A("driving_license_main")?.url,"preview-src-list":te("driving_license_main"),fit:"contain",class:"one-img"},null,8,["src","preview-src-list"]),e[87]||(e[87]=l("div",{class:"one-mask"},[l("div",{class:"one-mask-text"},"已上传，删除后可重新上传")],-1))])):(n(),c("div",hs,[...e[88]||(e[88]=[l("div",{class:"empty-center"},[l("div",{class:"empty-title"},"拖拽图片到此处"),l("div",{class:"empty-sub"},"或点击选择文件")],-1)])]))]),_:1},8,["file-list","disabled","on-change","on-exceed"]),P("driving_license_main")>0?(n(),c("div",Vs," 正在上传："+$(P("driving_license_main"))+" 个文件…（上传完成后才能提交） ",1)):x("",!0),l("div",Us,[l("div",Cs,[h("driving_license_main")>0?(n(),c(H,{key:0},[l("span",null,"已就绪："+$(h("driving_license_main"))+" 张",1),e[89]||(e[89]=l("span",{class:"ready-dot","aria-hidden":"true"},null,-1))],64)):(n(),c("span",xs,"未上传"))]),l("div",$s,[(w.value.driving_license_main||[]).length?(n(),z(o,{key:0,size:"small",type:"danger",link:"",class:"slot-remove",disabled:L.value||V.value>0,onClick:e[30]||(e[30]=t=>le("driving_license_main"))},{default:r(()=>[...e[90]||(e[90]=[f(" 移除 ",-1)])]),_:1},8,["disabled"])):x("",!0)])])])])]),l("div",zs,[e[100]||(e[100]=l("div",{class:"sub-title"},"行驶证副页",-1)),l("div",Ss,[l("div",Ls,[ee.value?(n(),c("div",Rs,[l("div",Es,[e[92]||(e[92]=l("div",{class:"kv-label"},"副页备注",-1)),l("div",Os,[i(S,{modelValue:_.value.dl_attach_note,"onUpdate:modelValue":e[31]||(e[31]=t=>_.value.dl_attach_note=t),placeholder:"可选",clearable:"",class:"fv fv-input"},null,8,["modelValue"])])])])):x("",!0)]),l("div",Ms,[l("div",Is,[e[95]||(e[95]=l("span",null,"行驶证副页图片",-1)),h("driving_license_sub")>0?(n(),c("span",Ts,[f(" （已就绪 "+$(h("driving_license_sub"))+" 张 ",1),e[93]||(e[93]=l("span",{class:"ready-dot","aria-hidden":"true"},null,-1)),e[94]||(e[94]=f("） ",-1))])):x("",!0)]),i(s,{drag:"","auto-upload":!1,multiple:!1,limit:1,"show-file-list":!1,"file-list":w.value.driving_license_sub,disabled:_e("driving_license_sub")||L.value||V.value>0,"on-change":t=>de("driving_license_sub",t),"on-exceed":()=>pe("driving_license_sub"),accept:"image/*",class:"upload-box upload-one"},{default:r(()=>[A("driving_license_sub")?(n(),c("div",As,[i(ue,{src:A("driving_license_sub")?.url,"preview-src-list":te("driving_license_sub"),fit:"contain",class:"one-img"},null,8,["src","preview-src-list"]),e[96]||(e[96]=l("div",{class:"one-mask"},[l("div",{class:"one-mask-text"},"已上传，删除后可重新上传")],-1))])):(n(),c("div",Ds,[...e[97]||(e[97]=[l("div",{class:"empty-center"},[l("div",{class:"empty-title"},"拖拽图片到此处"),l("div",{class:"empty-sub"},"或点击选择文件")],-1)])]))]),_:1},8,["file-list","disabled","on-change","on-exceed"]),P("driving_license_sub")>0?(n(),c("div",Bs," 正在上传："+$(P("driving_license_sub"))+" 个文件…（上传完成后才能提交） ",1)):x("",!0),l("div",Ps,[l("div",Fs,[h("driving_license_sub")>0?(n(),c(H,{key:0},[l("span",null,"已就绪："+$(h("driving_license_sub"))+" 张",1),e[98]||(e[98]=l("span",{class:"ready-dot","aria-hidden":"true"},null,-1))],64)):(n(),c("span",Ns,"未上传"))]),l("div",Gs,[(w.value.driving_license_sub||[]).length?(n(),z(o,{key:0,size:"small",type:"danger",link:"",class:"slot-remove",disabled:L.value||V.value>0,onClick:e[32]||(e[32]=t=>le("driving_license_sub"))},{default:r(()=>[...e[99]||(e[99]=[f(" 移除 ",-1)])]),_:1},8,["disabled"])):x("",!0)])])])])])])]),_:1}),i(U,{shadow:"never",class:"section-card"},{header:r(()=>[...e[101]||(e[101]=[l("div",{class:"section-header"},[l("div",{class:"section-title"},"相关图片（可多张）")],-1)])]),default:r(()=>[l("div",qs,[e[104]||(e[104]=l("span",null,"相关图片（可多张）",-1)),h("related")>0?(n(),c("span",Hs,[f(" （已就绪 "+$(h("related"))+" 张 ",1),e[102]||(e[102]=l("span",{class:"ready-dot","aria-hidden":"true"},null,-1)),e[103]||(e[103]=f("） ",-1))])):x("",!0)]),i(s,{class:"upload-card upload-wide","file-list":w.value.related,"list-type":"picture-card",limit:20,multiple:!0,"auto-upload":!1,drag:"",accept:"image/*",disabled:L.value||V.value>0,"on-change":(t,u)=>Me("related",t,u),"on-remove":(t,u)=>Ie("related",t,u)},{default:r(()=>[l("div",js,[i(J,{class:"upload-plus"},{default:r(()=>[i(ae(Vt))]),_:1}),e[105]||(e[105]=l("div",{class:"upload-text"},"拖拽图片到此处",-1))])]),_:1},8,["file-list","disabled","on-change","on-remove"]),P("related")>0?(n(),c("div",Ys," 正在上传："+$(P("related"))+" 个文件…（上传完成后才能提交） ",1)):x("",!0)]),_:1}),l("div",Ws,[i(o,{onClick:Fe,disabled:L.value||V.value>0},{default:r(()=>[...e[106]||(e[106]=[f("清空",-1)])]),_:1},8,["disabled"]),i(o,{type:"primary",loading:L.value,disabled:V.value>0,onClick:Ne},{default:r(()=>[...e[107]||(e[107]=[f("提交",-1)])]),_:1},8,["loading","disabled"])])])}}},Qs=ct(Js,[["__scopeId","data-v-dea5151c"]]),Xs={class:"page"},Zs={class:"page-header"},Ks={class:"page-header-right"},ea={class:"card-title"},ta={class:"card-title-right"},la={class:"upload-mode"},sa={class:"filters"},aa={class:"upload-grid"},ia={class:"slot-head"},oa={class:"slot-name"},na={class:"slot-tip"},ra={key:0,class:"one-wrap"},da={key:1,class:"upload-empty"},ua={key:0,class:"preview-wall"},ca={key:1,class:"preview-img preview-empty"},va={class:"preview-meta"},_a=["title"],pa={class:"preview-status"},ma={key:2,class:"uploading-tip"},fa={class:"slot-foot"},ga={class:"slot-foot-left"},ka={key:1,class:"muted"},ya={class:"slot-foot-right"},ba={class:"drawer-header"},wa={class:"drawer-actions"},ha={class:"table-scroll"},Va=["onClick","title"],Ua={key:1},lt="order_import_upload_mode",Ca=" - ",xa={__name:"OrderImport",setup(Qe){const ie=st(),oe=ht(),L=g("import");function ne(){ie.replace({path:"/orders/import",query:{tab:L.value}})}Je(()=>{const s=oe.query?.tab;(s==="manual"||s==="import")&&(L.value=s)}),et(()=>oe.query?.tab,s=>{(s==="manual"||s==="import")&&(L.value=s)});function X(){const s=oe.query?.from;if(typeof s=="string"&&s.startsWith("/")){ie.push(s);return}if(window.history.length>1){ie.back();return}ie.push({path:"/orders/all"})}const Z=g("smart");function $e(){try{const s=window.localStorage.getItem(lt);(s==="smart"||s==="direct"||s==="stable")&&(Z.value=s)}catch{}}function we(){try{window.localStorage.setItem(lt,Z.value)}catch{}}$e();function M(s){return/[\u4e00-\u9fa5]/.test(String(s||""))}function ze(s){const t=s?.response?.data?.detail||s?.response?.data?.message||s?.message||"";return String(t||"")}function W(s,t="操作失败，请稍后重试"){const u=s?.response?.data?.detail,m=ze(s),p=s?.response?.status,Q=String(s?.code||"");if(typeof u=="string"&&u&&M(u))return u;if(m&&M(m))return m;const R=m.toLowerCase();return R.includes("network error")||R.includes("failed to fetch")?"网络异常，请检查网络连接":R.includes("timeout")||Q.includes("ECONNABORTED")?"请求超时，请稍后重试":R.includes("cors")?"跨域受限或网络拦截，请切换网络后重试":p===401?"登录状态已失效，请重新登录":p===403?"无权限执行该操作":p>=500?"服务器异常，请稍后重试":t}function Se(s){const t=ze(s).toLowerCase();return t.includes("failed to fetch")||t.includes("network error")||t.includes("err_")||t.includes("cors")||t.includes("代理")||t.includes("vpn")||t.includes("hint=浏览器请求可能走了本机代理")||t.includes("127.0.0.1:7890")}async function re(){try{return await at.confirm(`上传可能被当前网络环境拦截（常见于 VPN/代理/公司网关）。

建议切换到【稳定模式上传】继续，无需任何设置。`,"上传失败（网络拦截）",{confirmButtonText:"切换为稳定模式",cancelButtonText:"继续直传重试",type:"warning",center:!0,distinguishCancelAndClose:!0}),Z.value="stable",we(),!0}catch{return!1}}const Le=g(null),N=g({customer_group_id:null,channel_group_id:null}),_={customer_group_id:[{required:!0,message:"客户必选",trigger:"change"}],channel_group_id:[{required:!0,message:"渠道必选",trigger:"change"}]},ve=Ye(()=>!!N.value.customer_group_id&&!!N.value.channel_group_id),K=g([]),ee=g([]),Y=g(!1);function he(s){return String(s??"").trim()}function Re(s,t,u=""){const m=he(s),p=he(t);return m&&p?`${m}${Ca}${p}`:m||p||he(u)||"-"}function _e(s){return Re(s?.group_code,s?.group_name,s?.id)}function pe(s){return Re(s?.group_code,s?.group_name,s?.id)}function w(s){const t=s?.data?.items;return Array.isArray(t)?t:[]}async function G(){Y.value=!0;try{const[s,t]=await Promise.all([it(),ot()]);K.value=w(s),ee.value=w(t)}catch(s){console.error(s),ce.error({title:"加载失败",message:W(s,"加载客户/渠道群失败，请稍后重试"),duration:4e3})}finally{Y.value=!1}}const V=[{key:"vehicle_cert",label:"合格证",multiple:!1},{key:"idcard_front",label:"身份证正面",multiple:!1},{key:"idcard_back",label:"身份证反面",multiple:!1},{key:"driving_license_main",label:"行驶证主页",multiple:!1},{key:"driving_license_sub",label:"行驶证副页",multiple:!1},{key:"related",label:"相关图片(多张)",multiple:!0}],b=g(V.reduce((s,t)=>(s[t.key]=[],s),{})),I=g(!1),j=g({}),E=g({}),T=g(0),B=g({}),Ve=g("");let A=null,te=0;function Ee(s){try{return Date.parse(s)}catch{return 0}}async function Be(){const s=Date.now();if(A&&te&&s+12e4<te)return A;const u=(await We.get("/orders/bos-sts"))?.data;if(!u?.accessKeyId||!u?.secretAccessKey||!u?.sessionToken)throw new Error("获取上传凭证失败：返回数据不完整");return A=u,Ve.value=u.bosHost||"",te=Ee(u.expiration)||s+600*1e3,A}function fe(s){return!!V.find(u=>u.key===s)?.multiple}function le(s){return V.find(t=>t.key===s)?.label||s}function Ue(s){return fe(s)?!1:(b.value[s]||[]).length>=1}function Ce(s){q.warning(`${le(s)}：请先删除当前图片，再上传新图片`)}function ge(s){const t=b.value[s]||[];return t.length?t[0]:null}function Oe(s){const t=s?.raw;if(t&&!s.url){const u=URL.createObjectURL(t);s.url=u,B.value[s.uid]=u}}function Pe(s,t){if(!s||!t)return;const u=s.uid,m=u?B.value[u]:s.url;if(m){try{URL.revokeObjectURL(m)}catch{}u&&delete B.value[u]}const p=URL.createObjectURL(t);s.raw=t,s.url=p,u&&(B.value[u]=p)}function de(s){const t=b.value[s]||[];for(const u of t){const m=u?.uid;if(!m)continue;delete j.value[m],delete E.value[m];const p=B.value[m];if(p){try{URL.revokeObjectURL(p)}catch{}delete B.value[m]}}b.value[s]=[]}function Me(s,t){if(!t?.uid||!t?.raw)return;if(!fe(s)){if(Ue(s)){Ce(s);return}de(s),Oe(t),b.value[s]=[t],Ie(s,t).catch(m=>{console.error(m),ce.error({title:"上传失败",message:W(m,"上传失败，请稍后重试"),duration:5e3})});return}const u=b.value[s]||[];u.find(m=>m.uid===t.uid)||(u.push(t),b.value[s]=u),Oe(t),Ie(s,t).catch(m=>{console.error(m),ce.error({title:"上传失败",message:W(m,"上传失败，请稍后重试"),duration:5e3})})}async function Ie(s,t){const u=t?.raw;if(!u||!t?.uid)return;const m=E.value[t.uid]?.status;if(!(m==="uploading"||m==="done")&&!j.value[t.uid]){T.value+=1,E.value[t.uid]={status:"uploading"};try{let p=u;try{const se=await dt({file:u,slotKey:s});se?.file&&(p=se.file,Pe(t,p),se?.note&&console.info("[image-preprocess]",se.note))}catch{p=u}if(Z.value==="stable"){const O=(await De({slot_key:s,file:p}))?.data;j.value[t.uid]={slot_key:s,md5:O?.md5,storage_key:O?.storage_key,etag:O?.etag||"",size:O?.size||p.size||0,content_type:O?.content_type||p.type||"application/octet-stream",original_name:O?.original_name||p.name||"file",preview_url:O?.preview_url||""},E.value[t.uid]={status:"done"};return}const Q=await Be();if(!Ve.value)throw new Error("上传配置缺失：bosHost 为空");const R=await ut({bosHost:Ve.value,slotKey:s,file:p,sts:Q});j.value[t.uid]={slot_key:s,...R,size:R?.size||p.size||0,content_type:R?.content_type||p.type||"application/octet-stream",original_name:R?.original_name||p.name||"file"},E.value[t.uid]={status:"done"}}catch(p){if(Z.value==="smart"&&Se(p)&&await re())try{const R=t?.raw||u,O=(await De({slot_key:s,file:R}))?.data;j.value[t.uid]={slot_key:s,md5:O?.md5,storage_key:O?.storage_key,etag:O?.etag||"",size:O?.size||R.size||0,content_type:O?.content_type||R.type||"application/octet-stream",original_name:O?.original_name||R.name||"file",preview_url:O?.preview_url||""},E.value[t.uid]={status:"done"};return}catch(R){throw E.value[t.uid]={status:"error",msg:W(R,"上传失败，请稍后重试")},R}throw E.value[t.uid]={status:"error",msg:W(p,"上传失败，请稍后重试")},p}finally{T.value=Math.max(0,T.value-1)}}}function xe(s){const t=b.value[s]||[];let u=0;for(const m of t)j.value[m.uid]&&(u+=1);return u}function h(s){const t=b.value[s]||[];let u=0;for(const m of t)E.value[m.uid]?.status==="uploading"&&(u+=1);return u}const P=Ye(()=>V.some(s=>(b.value[s.key]||[]).length>0));function Fe(){const s=[];for(const t of V){const u=b.value[t.key]||[];for(const m of u){const p=j.value[m.uid];!p?.slot_key||!p?.storage_key||!p?.md5||s.push({slot_key:p.slot_key,storage_key:p.storage_key,md5:p.md5,size:Number(p.size||0),content_type:p.content_type??void 0,etag:p.etag??void 0,original_name:p.original_name??void 0})}}return s}function Te(){for(const s of Object.keys(B.value))try{URL.revokeObjectURL(B.value[s])}catch{}B.value={},b.value=V.reduce((s,t)=>(s[t.key]=[],s),{}),j.value={},E.value={}}function Ae(s){return(b.value[s]||[]).map(u=>u.url).filter(Boolean)}async function Ne(){try{await Le.value?.validate?.()}catch{q.warning("客户和渠道为必选项，请先选择后再提交");return}if(!P.value){q.warning("请至少上传一张图片");return}if(T.value>0){q.warning("还有文件在上传中，请稍后再提交");return}const s=Fe();if(!s.length){q.warning("未检测到已上传文件（可能上传失败）");return}I.value=!0;try{const t={},u=await nt({module:"order",dynamic_data:t,customer_group_id:N.value.customer_group_id,channel_group_id:N.value.channel_group_id}),p=(u?.data?.data??u?.data??u)?.order_id;if(!p)throw new Error("创建订单失败：未获取到订单ID");await rt({order_id:p,images:s,dynamic_data:t,customer_group_id:N.value.customer_group_id,channel_group_id:N.value.channel_group_id}),Te(),await o(),q.success(`订单 ${p} 已创建，OCR 识别任务已提交`)}catch(t){console.error(t),ce.error({title:"提交失败",message:W(t,"提交失败，请稍后重试"),duration:5e3})}finally{I.value=!1}}const me=g(!1),a=g([]),e=g(!1);async function o(){if(!e.value){e.value=!0;try{const t=(await We.get("/orders/ocr-tasks",{params:{limit:50}}))?.data;a.value=Array.isArray(t?.items)?t.items:[]}catch(s){console.error(s),ce.error({title:"加载任务失败",message:W(s,"加载失败，请稍后重试"),duration:4e3})}finally{e.value=!1}}}const d=Ye(()=>(a.value||[]).filter(t=>t?.status==="pending"||t?.status==="processing").length);function k(s){const t=String(s||"").trim();return t?M(t)?t:"识别失败（点击查看详情）":"-"}function U(s){const t=String(s?.error_message||"").trim();t&&(M(t)||(console.warn("[OCR任务原始错误信息]",{taskId:s?.id,orderId:s?.order_id,error_message:t}),q.info("已在控制台输出任务原始错误信息")))}function F(s){s&&ie.push({path:`/orders/${s}`,query:{from:oe.fullPath}})}function C(){ie.push({path:"/orders/unfinished",query:{from:oe.fullPath}})}function Ge(s){return s==="pending"?"排队中":s==="processing"?"识别中":s==="finished"?"已完成":s==="finished_with_errors"?"部分成功":s==="failed"?"失败":s==="skipped"?"已跳过":s||"-"}function qe(s){return s==="finished"?"success":s==="finished_with_errors"?"warning":s==="failed"?"danger":s==="processing"?"warning":"info"}let J=null;function S(){J||(J=window.setInterval(()=>{me.value&&o()},3e3))}function ue(){J&&(window.clearInterval(J),J=null)}return et(me,async s=>{s?(await o(),S()):ue()}),Je(async()=>{await Promise.all([G(),o()])}),vt(()=>{ue();for(const s of Object.keys(B.value))try{URL.revokeObjectURL(B.value[s])}catch{}B.value={}}),(s,t)=>{const u=y("el-button"),m=y("el-icon"),p=y("el-badge"),Q=y("el-option"),R=y("el-select"),se=y("el-form-item"),O=y("el-col"),_t=y("el-row"),pt=y("el-form"),mt=y("el-alert"),ke=y("el-tag"),Xe=y("el-image"),Ze=y("el-upload"),ft=y("el-card"),ye=y("el-table-column"),gt=y("el-progress"),kt=y("el-table"),yt=y("el-drawer"),Ke=y("el-tab-pane"),bt=y("el-tabs"),wt=xt("loading");return n(),c("div",Xs,[l("div",Zs,[t[8]||(t[8]=l("h2",null,"导入 / 创建订单",-1)),l("div",Ks,[i(u,{size:"small",onClick:X},{default:r(()=>[...t[6]||(t[6]=[f("返回",-1)])]),_:1}),i(p,{value:d.value,hidden:d.value===0,max:99,class:"task-badge"},{default:r(()=>[i(u,{class:"task-btn",type:"primary",onClick:t[0]||(t[0]=v=>me.value=!0)},{default:r(()=>[i(m,{class:"task-icon"},{default:r(()=>[i(ae(Ut))]),_:1}),t[7]||(t[7]=f(" 图片识别任务 ",-1))]),_:1})]),_:1},8,["value","hidden"])])]),i(bt,{modelValue:L.value,"onUpdate:modelValue":t[5]||(t[5]=v=>L.value=v),class:"top-tabs",onTabChange:ne},{default:r(()=>[i(Ke,{label:"导入订单",name:"import"},{default:r(()=>[i(ft,{shadow:"never",class:"block-card"},{header:r(()=>[l("div",ea,[t[12]||(t[12]=l("span",null,"创建订单（拖拽上传：MD5 去重 + 直传 BOS）",-1)),l("div",ta,[l("div",la,[t[9]||(t[9]=l("span",{class:"upload-mode-label"},"上传模式",-1)),i(R,{modelValue:Z.value,"onUpdate:modelValue":t[1]||(t[1]=v=>Z.value=v),size:"small",style:{width:"160px"},onChange:we},{default:r(()=>[i(Q,{label:"智能（推荐）",value:"smart"}),i(Q,{label:"直传（更快）",value:"direct"}),i(Q,{label:"稳定（兼容VPN）",value:"stable"})]),_:1},8,["modelValue"])]),i(u,{size:"small",onClick:Te,disabled:I.value||T.value>0},{default:r(()=>[...t[10]||(t[10]=[f(" 清空图片 ",-1)])]),_:1},8,["disabled"]),i(u,{size:"small",type:"primary",loading:I.value,disabled:T.value>0||!ve.value,onClick:Ne},{default:r(()=>[...t[11]||(t[11]=[f(" 提交 OCR 导入 ",-1)])]),_:1},8,["loading","disabled"])])])]),default:r(()=>[l("div",sa,[i(pt,{ref_key:"filtersFormRef",ref:Le,model:N.value,rules:_,"label-width":"80px",class:"filters-form"},{default:r(()=>[i(_t,{gutter:12},{default:r(()=>[i(O,{span:12},{default:r(()=>[i(se,{label:"客户群",prop:"customer_group_id"},{default:r(()=>[i(R,{modelValue:N.value.customer_group_id,"onUpdate:modelValue":t[2]||(t[2]=v=>N.value.customer_group_id=v),clearable:"",filterable:"",placeholder:"必选",style:{width:"100%"},loading:Y.value,disabled:Y.value},{default:r(()=>[(n(!0),c(H,null,be(K.value,v=>(n(),z(Q,{key:String(v.id),label:_e(v),value:v.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","loading","disabled"])]),_:1})]),_:1}),i(O,{span:12},{default:r(()=>[i(se,{label:"渠道群",prop:"channel_group_id"},{default:r(()=>[i(R,{modelValue:N.value.channel_group_id,"onUpdate:modelValue":t[3]||(t[3]=v=>N.value.channel_group_id=v),clearable:"",filterable:"",placeholder:"必选",style:{width:"100%"},loading:Y.value,disabled:Y.value},{default:r(()=>[(n(!0),c(H,null,be(ee.value,v=>(n(),z(Q,{key:String(v.id),label:pe(v),value:v.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","loading","disabled"])]),_:1})]),_:1})]),_:1})]),_:1},8,["model"])]),T.value>0?(n(),z(mt,{key:0,class:"upload-alert",type:"warning",closable:!1,"show-icon":"",title:"正在上传",description:`正在上传 ${T.value} 个文件…（全部上传完成后才能提交）`},null,8,["description"])):x("",!0),l("div",aa,[(n(),c(H,null,be(V,v=>l("div",{key:v.key,class:"slot-card"},[l("div",ia,[l("div",oa,$(v.label),1),l("div",na,[i(ke,{size:"small",type:"info",effect:"plain"},{default:r(()=>[f($(v.multiple?"可多张":"单张"),1)]),_:2},1024)])]),v.multiple?(n(),c(H,{key:1},[i(Ze,{drag:"","auto-upload":!1,multiple:!0,limit:20,"show-file-list":!1,"file-list":b.value[v.key],disabled:I.value||T.value>0,"on-change":D=>Me(v.key,D),accept:"image/*",class:"upload-box upload-multi"},{default:r(()=>[...t[15]||(t[15]=[l("div",{class:"upload-empty"},[l("div",{class:"empty-center"},[l("div",{class:"empty-title"},"拖拽图片到此处"),l("div",{class:"empty-sub"},"或点击选择文件（可多张）")])],-1)])]),_:1},8,["file-list","disabled","on-change"]),(b.value[v.key]||[]).length?(n(),c("div",ua,[(n(!0),c(H,null,be(b.value[v.key],D=>(n(),c("div",{key:D.uid,class:"preview-item"},[D.url?(n(),z(Xe,{key:0,src:D.url,"preview-src-list":Ae(v.key),fit:"cover",class:"preview-img"},null,8,["src","preview-src-list"])):(n(),c("div",ca)),l("div",va,[l("div",{class:"preview-name",title:D.name},$(D.name),9,_a),l("div",pa,[E.value[D.uid]?.status==="uploading"?(n(),z(ke,{key:0,size:"small",type:"warning"},{default:r(()=>[...t[16]||(t[16]=[f(" 上传中 ",-1)])]),_:1})):E.value[D.uid]?.status==="done"?(n(),z(ke,{key:1,size:"small",type:"success"},{default:r(()=>[...t[17]||(t[17]=[f(" 已就绪 ",-1)])]),_:1})):E.value[D.uid]?.status==="error"?(n(),z(ke,{key:2,size:"small",type:"danger"},{default:r(()=>[...t[18]||(t[18]=[f(" 失败 ",-1)])]),_:1})):(n(),z(ke,{key:3,size:"small",type:"info",effect:"plain"},{default:r(()=>[...t[19]||(t[19]=[f(" 待上传 ",-1)])]),_:1}))])])]))),128))])):x("",!0)],64)):(n(),z(Ze,{key:0,drag:"","auto-upload":!1,multiple:!1,limit:1,"show-file-list":!1,"file-list":b.value[v.key],disabled:Ue(v.key)||I.value||T.value>0,"on-change":D=>Me(v.key,D),"on-exceed":()=>Ce(v.key),accept:"image/*",class:"upload-box upload-one"},{default:r(()=>[ge(v.key)?(n(),c("div",ra,[i(Xe,{src:ge(v.key)?.url,"preview-src-list":Ae(v.key),fit:"contain",class:"one-img"},null,8,["src","preview-src-list"]),t[13]||(t[13]=l("div",{class:"one-mask"},[l("div",{class:"one-mask-text"},"已上传，删除后可重新上传")],-1))])):(n(),c("div",da,[...t[14]||(t[14]=[l("div",{class:"empty-center"},[l("div",{class:"empty-title"},"拖拽图片到此处"),l("div",{class:"empty-sub"},"或点击选择文件")],-1)])]))]),_:2},1032,["file-list","disabled","on-change","on-exceed"])),h(v.key)>0?(n(),c("div",ma," 正在上传："+$(h(v.key))+" 个文件…（上传完成后才能提交） ",1)):x("",!0),l("div",fa,[l("div",ga,[xe(v.key)>0?(n(),c(H,{key:0},[l("span",null,"已就绪："+$(xe(v.key))+" 张",1),t[20]||(t[20]=l("span",{class:"ready-dot","aria-hidden":"true"},null,-1))],64)):(n(),c("span",ka,"未上传"))]),l("div",ya,[(b.value[v.key]||[]).length?(n(),z(u,{key:0,size:"small",type:"danger",link:"",class:"slot-remove",disabled:I.value||T.value>0,onClick:D=>de(v.key)},{default:r(()=>[...t[21]||(t[21]=[f(" 移除 ",-1)])]),_:1},8,["disabled","onClick"])):x("",!0)])])])),64))])]),_:1}),i(yt,{modelValue:me.value,"onUpdate:modelValue":t[4]||(t[4]=v=>me.value=v),direction:"rtl",size:"60%","with-header":!0},{header:r(()=>[l("div",ba,[t[24]||(t[24]=l("div",{class:"drawer-title"},"图片识别任务列表",-1)),l("div",wa,[i(u,{size:"small",loading:e.value,onClick:o},{default:r(()=>[...t[22]||(t[22]=[f("刷新",-1)])]),_:1},8,["loading"]),i(u,{size:"small",onClick:C},{default:r(()=>[...t[23]||(t[23]=[f("去未完成订单",-1)])]),_:1})])])]),default:r(()=>[l("div",ha,[$t((n(),z(kt,{data:a.value,border:"",stripe:"",height:"calc(100vh - 140px)"},{default:r(()=>[i(ye,{prop:"id",label:"任务ID",width:"90"}),i(ye,{prop:"order_id",label:"订单ID",width:"90"}),i(ye,{label:"状态",width:"120"},{default:r(({row:v})=>[i(ke,{type:qe(v.status)},{default:r(()=>[f($(Ge(v.status)),1)]),_:2},1032,["type"])]),_:1}),i(ye,{label:"进度",width:"180"},{default:r(({row:v})=>[i(gt,{percentage:v.progress||0,status:v.status==="failed"?"exception":v.status==="finished"?"success":"active"},null,8,["percentage","status"])]),_:1}),i(ye,{label:"错误信息"},{default:r(({row:v})=>[v?.error_message?(n(),c("span",{key:0,class:"task-error",onClick:D=>U(v),title:M(v.error_message)?"":"点击查看详情"},$(k(v.error_message)),9,Va)):(n(),c("span",Ua,"-"))]),_:1}),i(ye,{label:"查看",width:"140"},{default:r(({row:v})=>[i(u,{size:"small",onClick:D=>F(v.order_id),disabled:!v.order_id},{default:r(()=>[...t[25]||(t[25]=[f("详情",-1)])]),_:1},8,["onClick","disabled"])]),_:1})]),_:1},8,["data"])),[[wt,e.value]])])]),_:1},8,["modelValue"])]),_:1}),i(Ke,{label:"手动新建",name:"manual"},{default:r(()=>[i(Qs,{embedded:!0})]),_:1})]),_:1},8,["modelValue"])])}}},Pa=ct(xa,[["__scopeId","data-v-9616f449"]]);export{Pa as default};
