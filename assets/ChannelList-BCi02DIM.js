import{c as k,r as v,q as Me,x as D,z as i,P as a,G as y,J as oe,H as t,ay as m,I as Te,aI as qe,y as p,C as Ge,L as u,u as Q,M as R,ap as O,O as W,ac as Ke,D as X}from"./vendor-vue-CZOMRj4y.js";import{E as _,h as Oe,v as Pe,w as je}from"./vendor-element-plus-nv6hIq5t.js";import{a as He,b as Je,e as Qe,f as We}from"./customerChannel-6fIO32tk.js";import{_ as Xe,u as Ye}from"./index-BffKbIYS.js";import"./vendor-lodash-rvV0CIkQ.js";import"./vendor-DWCz07M-.js";import"./vendor-dates-DVKSwKij.js";import"./http-DGyH82Tn.js";import"./vendor-axios-C0Zqfgkc.js";import"./vendor-vue-router-o2a2TmKO.js";import"./vendor-pinia--LqfdQ-h.js";const Ze={class:"page"},el={class:"page-header"},ll={class:"header-actions"},al={class:"toolbar-row"},tl={class:"toolbar-content"},nl={class:"toolbar-fields"},ol={class:"toolbar-actions"},sl={class:"table-scroll"},il={class:"code-cell"},rl={class:"code-text"},ul={class:"pagination-bar"},dl={class:"contacts-wrap"},cl={class:"contacts-toolbar"},pl={key:0,class:"contacts-empty"},vl={key:1,class:"contacts-list"},ml={class:"dialog-footer"},fl={class:"cd"},_l={class:"cd-icon-wrap"},gl={class:"cd-body"},yl={class:"cd-title"},bl={class:"cd-code"},Cl={class:"cd-footer"},hl={__name:"ChannelList",setup(wl){const se=Ye(),P=k(()=>!0);k(()=>!0),k(()=>!0);const Y=k(()=>String(se.roleName||"").trim().toLowerCase()),$=k(()=>Y.value!==ROLE.FINANCE),j=k(()=>Y.value===ROLE.SUPER_ADMIN),V=v(!1),g=v(!1),b=v(1),H=v(20),Z=v(0),ee=v([]);let F=0;const f=v({channel_code:"",channel_name:"",region:"",created_by:""});function M(l){const e=String(l??"").trim();return e||""}function le(l){return!!l?.is_deleted||!!l?.deleted_at}function ie(l){const e=String(l||"").trim().toLowerCase();return e==="mobile"?"手机号":e==="tel"?"座机":e||""}function re(l){return!Array.isArray(l)||!l.length?"":l.map(e=>{if(!e)return"";const s=ie(e.type),n=e.value?String(e.value):"";return s?`${s}:${n}`:n}).filter(Boolean).join("；")}async function h(){const l=++F;g.value=!0;try{const e={page:b.value,page_size:H.value};j.value&&V.value&&(e.include_deleted=1);const s=M(f.value.channel_code),n=M(f.value.channel_name),d=M(f.value.region),c=M(f.value.created_by);s&&(e.channel_code=s),n&&(e.channel_name=n),d&&(e.region=d),c&&(e.created_by=c);const E=await He(e);if(l!==F)return;const x=E?.data||{};Z.value=Number(x.total||0),ee.value=Array.isArray(x.items)?x.items:[]}catch(e){if(l!==F)return;console.error(e),_.error(e?.response?.data?.detail||e?.message||"渠道列表加载失败")}finally{l===F&&(g.value=!1)}}function ue(){h()}function w(){b.value=1,h()}function de(){f.value={channel_code:"",channel_name:"",region:"",created_by:""},b.value=1,h()}const ae=k(()=>ee.value||[]);function ce(l){b.value=l,h()}function pe(l){H.value=l,b.value=1,h()}function ve(){j.value&&(V.value=!V.value,b.value=1,h())}const A=v(!1),J=v(!1),I=v(null),L=v("create"),T=v(null),me=k(()=>L.value==="edit"?"编辑渠道":"新增渠道");function fe(){return{type:"mobile",value:""}}const r=v({channel_code:"",channel_name:"",region:"",contacts:[]}),_e=/^1[3-9]\d{9}$/,ge=/^(0\d{2,3}-?)?\d{7,8}(-\d{1,6})?$/,ye=/^(400|800)\d{7}$/;function q(l){return String(l??"").replace(/\s+/g,"").replace(/[^0-9\-]/g,"")}function be(l){const e=String(l?.type||"").trim().toLowerCase(),s=q(l?.value||"");if(!s)return"联系方式不能为空（不需要可删除该行）";if(e==="mobile"){const n=s.replace(/-/g,"");return _e.test(n)?"":"手机号格式不正确（需为 11 位大陆手机号）"}if(e==="tel"){const n=s.replace(/-/g,"");return ye.test(n)||ge.test(s)?"":"座机格式不正确（示例：010-88888888 / 0571-8888888 / 010-88888888-123 / 400xxxxxxx）"}return"联系方式类型仅支持：手机号/座机"}async function G(){if(!I.value)return!0;try{return await I.value.validateField("contacts"),!0}catch{return!1}}function Ce(){const l=Array.isArray(r.value.contacts)?r.value.contacts:[],e=new Set,s=[];for(const n of l){const d=String(n?.type||"").trim().toLowerCase()||"mobile",c=q(n?.value||"");if(!c)continue;if(d==="mobile"){const x=c.replace(/-/g,""),C=`${d}:${x}`;if(e.has(C))continue;e.add(C),s.push({type:d,value:x});continue}const E=`${d}:${c}`;e.has(E)||(e.add(E),s.push({type:d,value:c}))}return s}function he(l){return(Array.isArray(l)?l:[]).map(s=>({type:String(s?.type||"mobile").trim().toLowerCase()==="tel"?"tel":"mobile",value:q(s?.value||"")}))}const we={channel_code:[{required:!0,message:"渠道代码必填",trigger:"blur"}],channel_name:[{required:!0,message:"渠道名称必填",trigger:"blur"}],contacts:[{trigger:["change","blur"],validator:(l,e,s)=>{const n=Array.isArray(r.value.contacts)?r.value.contacts:[];for(let d=0;d<n.length;d++){const c=be(n[d]);if(c)return s(new Error(`第 ${d+1} 条联系方式：${c}`))}s()}}]};function ke(){if(!$.value){_.warning("财务账号无新增权限");return}L.value="create",T.value=null,r.value={channel_code:"",channel_name:"",region:"",contacts:[]},A.value=!0}function Ve(l){if(!P.value){_.warning("仅经理/超级账号/市场账号可编辑");return}l?.id&&(L.value="edit",T.value=l.id,r.value={channel_code:String(l.channel_code||""),channel_name:String(l.channel_name||l.group_name||""),region:String(l.region||""),contacts:he(l.contacts)},A.value=!0)}function ze(){Array.isArray(r.value.contacts)||(r.value.contacts=[]),r.value.contacts.push(fe()),X(()=>G())}function xe(l){Array.isArray(r.value.contacts)&&(r.value.contacts.splice(l,1),X(()=>G()))}function Se(l){const s=(r.value.contacts||[])[l];s&&(s.type=String(s.type||"mobile").trim().toLowerCase(),X(()=>G()))}function De(l,e){const n=(r.value.contacts||[])[l];n&&(n.value=q(e))}async function $e(){if(L.value==="create"){if(!$.value){_.warning("财务账号无新增权限");return}}else{if(!P.value){_.warning("仅经理/超级账号/市场账号可编辑");return}if(!T.value)return}if(I.value){try{await I.value.validate()}catch{return}J.value=!0;try{const l={channel_code:r.value.channel_code,channel_name:r.value.channel_name,region:r.value.region,contacts:Ce()};L.value==="edit"?(await Je(T.value,l),_.success("编辑渠道成功")):(await Qe(l),_.success("新增渠道成功")),A.value=!1,b.value=1,await h()}catch(l){console.error(l),_.error(l?.response?.data?.detail||l?.message||(L.value==="edit"?"编辑渠道失败":"新增渠道失败"))}finally{J.value=!1}}}const N=v(!1),B=v(!1),z=v(null),Ae=k(()=>{const l=z.value?.channel_code?String(z.value.channel_code):"",e=z.value?.channel_name?String(z.value.channel_name):"";return l&&e?`${l} - ${e}`:l||e||"-"});function Le(l){if(!$.value){_.warning("财务账号无删除权限");return}l?.id&&(z.value=l,N.value=!0)}function Ee(){z.value=null,B.value=!1}async function Ue(){if(!$.value){_.warning("财务账号无删除权限");return}if(z.value?.id){B.value=!0;try{await We(z.value.id),_.success("删除成功"),N.value=!1,ae.value.length<=1&&b.value>1&&(b.value-=1),await h()}catch(l){console.error(l),_.error(l?.response?.data?.detail||l?.message||"删除失败")}finally{B.value=!1}}}return Me(()=>h()),(l,e)=>{const s=m("el-icon"),n=m("el-button"),d=m("el-tooltip"),c=m("el-input"),E=m("el-card"),x=m("el-tag"),C=m("el-table-column"),Ie=m("el-table"),Ne=m("el-pagination"),K=m("el-form-item"),te=m("el-option"),Be=m("el-select"),Re=m("el-form"),ne=m("el-dialog"),Fe=qe("loading");return p(),D("div",Ze,[i("div",el,[e[14]||(e[14]=i("h2",null,"渠道管理",-1)),i("div",ll,[j.value?(p(),y(d,{key:0,content:V.value?"点击隐藏已删除":"点击显示已删除",placement:"top"},{default:t(()=>[a(n,{size:"small",class:Ge(["toggle-btn",{"toggle-btn--active":V.value}]),type:V.value?"info":"default",plain:!0,loading:g.value,onClick:ve},{default:t(()=>[a(s,{class:"btn-ico"},{default:t(()=>[V.value?(p(),y(Q(Oe),{key:0})):(p(),y(Q(Pe),{key:1}))]),_:1}),u(" "+R(V.value?"隐藏已删除":"显示已删除"),1)]),_:1},8,["class","type","loading"])]),_:1},8,["content"])):oe("",!0),$.value?(p(),y(n,{key:2,type:"primary",size:"small",onClick:ke},{default:t(()=>[...e[13]||(e[13]=[u("新增渠道",-1)])]),_:1})):(p(),y(d,{key:1,content:"财务账号无新增权限",placement:"top"},{default:t(()=>[i("span",null,[a(n,{type:"primary",size:"small",disabled:""},{default:t(()=>[...e[12]||(e[12]=[u("新增渠道",-1)])]),_:1})])]),_:1}))])]),a(E,{shadow:"never",class:"toolbar-card","body-style":{padding:"12px 14px"}},{default:t(()=>[i("div",al,[e[18]||(e[18]=i("div",{class:"toolbar-label"},"搜索条件",-1)),i("div",tl,[i("div",nl,[a(c,{modelValue:f.value.channel_code,"onUpdate:modelValue":e[0]||(e[0]=o=>f.value.channel_code=o),size:"small",clearable:"",placeholder:"渠道代码（模糊）",class:"toolbar-input",disabled:g.value,onKeyup:O(w,["enter"]),onClear:w},null,8,["modelValue","disabled"]),a(c,{modelValue:f.value.channel_name,"onUpdate:modelValue":e[1]||(e[1]=o=>f.value.channel_name=o),size:"small",clearable:"",placeholder:"渠道名称（模糊）",class:"toolbar-input",disabled:g.value,onKeyup:O(w,["enter"]),onClear:w},null,8,["modelValue","disabled"]),a(c,{modelValue:f.value.region,"onUpdate:modelValue":e[2]||(e[2]=o=>f.value.region=o),size:"small",clearable:"",placeholder:"归属地（模糊）",class:"toolbar-input",disabled:g.value,onKeyup:O(w,["enter"]),onClear:w},null,8,["modelValue","disabled"]),a(c,{modelValue:f.value.created_by,"onUpdate:modelValue":e[3]||(e[3]=o=>f.value.created_by=o),size:"small",clearable:"",placeholder:"创建人（模糊）",class:"toolbar-input",disabled:g.value,onKeyup:O(w,["enter"]),onClear:w},null,8,["modelValue","disabled"])]),i("div",ol,[a(n,{size:"small",disabled:g.value,onClick:de},{default:t(()=>[...e[15]||(e[15]=[u("重置",-1)])]),_:1},8,["disabled"]),a(n,{type:"primary",size:"small",loading:g.value,onClick:w},{default:t(()=>[...e[16]||(e[16]=[u("搜索",-1)])]),_:1},8,["loading"]),a(n,{size:"small",onClick:ue,loading:g.value},{default:t(()=>[...e[17]||(e[17]=[u("刷新",-1)])]),_:1},8,["loading"])])])])]),_:1}),i("div",sl,[Te((p(),y(Ie,{data:ae.value,border:"",stripe:"",class:"main-table"},{default:t(()=>[a(C,{prop:"channel_code",label:"渠道代码","min-width":"170","show-overflow-tooltip":""},{default:t(({row:o})=>[i("div",il,[i("span",rl,R(o.channel_code||"-"),1),le(o)?(p(),y(x,{key:0,size:"small",type:"info",class:"deleted-tag"},{default:t(()=>[...e[19]||(e[19]=[u("已删除",-1)])]),_:1})):oe("",!0)])]),_:1}),a(C,{prop:"channel_name",label:"渠道名称","min-width":"180","show-overflow-tooltip":""},{default:t(({row:o})=>[u(R(o.channel_name||o.group_name||"-"),1)]),_:1}),a(C,{prop:"region",label:"归属地","min-width":"140","show-overflow-tooltip":""}),a(C,{label:"联系方式","min-width":"220","show-overflow-tooltip":""},{default:t(({row:o})=>[u(R(re(o.contacts)),1)]),_:1}),a(C,{prop:"created_by_name",label:"创建人",width:"120","show-overflow-tooltip":""}),a(C,{prop:"created_at",label:"创建时间",width:"180","show-overflow-tooltip":""}),a(C,{label:"操作",width:"160",fixed:"right","class-name":"col-actions"},{default:t(({row:o})=>[le(o)?(p(),D(W,{key:0},[a(d,{content:"该渠道已删除",placement:"top"},{default:t(()=>[i("span",null,[a(n,{type:"primary",size:"small",link:"",disabled:""},{default:t(()=>[...e[20]||(e[20]=[u("编辑",-1)])]),_:1})])]),_:1}),a(d,{content:"该渠道已删除",placement:"top"},{default:t(()=>[i("span",null,[a(n,{type:"danger",size:"small",link:"",disabled:""},{default:t(()=>[...e[21]||(e[21]=[u("删除",-1)])]),_:1})])]),_:1})],64)):(p(),D(W,{key:1},[P.value?(p(),y(n,{key:1,type:"primary",size:"small",link:"",onClick:U=>Ve(o)},{default:t(()=>[...e[23]||(e[23]=[u("编辑",-1)])]),_:1},8,["onClick"])):(p(),y(d,{key:0,content:"仅经理/超级账号/市场账号可编辑",placement:"top"},{default:t(()=>[i("span",null,[a(n,{type:"primary",size:"small",link:"",disabled:""},{default:t(()=>[...e[22]||(e[22]=[u("编辑",-1)])]),_:1})])]),_:1})),$.value?(p(),y(n,{key:3,type:"danger",size:"small",link:"",onClick:U=>Le(o)},{default:t(()=>[...e[25]||(e[25]=[u("删除",-1)])]),_:1},8,["onClick"])):(p(),y(d,{key:2,content:"财务账号无删除权限",placement:"top"},{default:t(()=>[i("span",null,[a(n,{type:"danger",size:"small",link:"",disabled:""},{default:t(()=>[...e[24]||(e[24]=[u("删除",-1)])]),_:1})])]),_:1}))],64))]),_:1})]),_:1},8,["data"])),[[Fe,g.value]])]),i("div",ul,[a(Ne,{background:"",layout:"prev, pager, next, jumper, sizes, total","current-page":b.value,"page-size":H.value,total:Z.value,"page-sizes":[10,20,50,100],onCurrentChange:ce,onSizeChange:pe},null,8,["current-page","page-size","total"])]),a(ne,{modelValue:A.value,"onUpdate:modelValue":e[9]||(e[9]=o=>A.value=o),title:me.value,width:"520px","destroy-on-close":""},{footer:t(()=>[i("span",ml,[a(n,{onClick:e[8]||(e[8]=o=>A.value=!1)},{default:t(()=>[...e[29]||(e[29]=[u("取消",-1)])]),_:1}),a(n,{type:"primary",loading:J.value,onClick:$e},{default:t(()=>[...e[30]||(e[30]=[u("保存",-1)])]),_:1},8,["loading"])])]),default:t(()=>[a(Re,{model:r.value,rules:we,ref_key:"formRef",ref:I,"label-width":"90px"},{default:t(()=>[a(K,{label:"渠道代码",prop:"channel_code"},{default:t(()=>[a(c,{modelValue:r.value.channel_code,"onUpdate:modelValue":e[4]||(e[4]=o=>r.value.channel_code=o),clearable:""},null,8,["modelValue"])]),_:1}),a(K,{label:"渠道名称",prop:"channel_name"},{default:t(()=>[a(c,{modelValue:r.value.channel_name,"onUpdate:modelValue":e[5]||(e[5]=o=>r.value.channel_name=o),clearable:""},null,8,["modelValue"])]),_:1}),a(K,{label:"归属地",prop:"region"},{default:t(()=>[a(c,{modelValue:r.value.region,"onUpdate:modelValue":e[6]||(e[6]=o=>r.value.region=o),clearable:""},null,8,["modelValue"])]),_:1}),a(K,{label:"联系方式",prop:"contacts"},{default:t(()=>[i("div",dl,[i("div",cl,[a(n,{size:"small",onClick:ze},{default:t(()=>[...e[26]||(e[26]=[u("添加联系方式",-1)])]),_:1}),e[27]||(e[27]=i("div",{class:"contacts-hint"},"仅支持：手机号 / 座机（可多条）",-1))]),r.value.contacts.length?(p(),D("div",vl,[(p(!0),D(W,null,Ke(r.value.contacts,(o,U)=>(p(),D("div",{key:U,class:"contacts-row"},[a(Be,{modelValue:o.type,"onUpdate:modelValue":S=>o.type=S,class:"contacts-type",placeholder:"类型",onChange:S=>Se(U)},{default:t(()=>[a(te,{label:"手机号",value:"mobile"}),a(te,{label:"座机",value:"tel"})]),_:1},8,["modelValue","onUpdate:modelValue","onChange"]),a(c,{modelValue:o.value,"onUpdate:modelValue":S=>o.value=S,class:"contacts-value",clearable:"",placeholder:"手机号：11位；座机：010-88888888 / 400xxxxxxx",onInput:S=>De(U,S),onBlur:e[7]||(e[7]=()=>G())},null,8,["modelValue","onUpdate:modelValue","onInput"]),a(n,{type:"danger",size:"small",link:"",class:"contacts-remove",onClick:S=>xe(U)},{default:t(()=>[...e[28]||(e[28]=[u(" 删除 ",-1)])]),_:1},8,["onClick"])]))),128))])):(p(),D("div",pl,"未添加联系方式"))])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"]),a(ne,{modelValue:N.value,"onUpdate:modelValue":e[11]||(e[11]=o=>N.value=o),width:"440px","destroy-on-close":"","append-to-body":"","show-close":!1,class:"confirm-dialog",onClosed:Ee},{footer:t(()=>[i("div",Cl,[a(n,{onClick:e[10]||(e[10]=o=>N.value=!1),disabled:B.value},{default:t(()=>[...e[34]||(e[34]=[u("取消",-1)])]),_:1},8,["disabled"]),a(n,{type:"danger",loading:B.value,onClick:Ue},{default:t(()=>[...e[35]||(e[35]=[u("确认删除",-1)])]),_:1},8,["loading"])])]),default:t(()=>[i("div",fl,[i("div",_l,[a(s,{class:"cd-icon"},{default:t(()=>[a(Q(je))]),_:1})]),i("div",gl,[i("div",yl,[e[31]||(e[31]=u("确认删除渠道：",-1)),i("span",bl,R(Ae.value),1),e[32]||(e[32]=u("？",-1))]),e[33]||(e[33]=i("div",{class:"cd-desc"},"删除后会移入“已删除”，订单详情页下拉选项将不再展示。",-1))])])]),_:1},8,["modelValue"])])}}},Il=Xe(hl,[["__scopeId","data-v-2a00f4f7"]]);export{Il as default};
