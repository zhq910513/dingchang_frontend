import{c as x,r as v,q as Te,x as A,z as i,P as a,G as y,J as se,H as t,ay as m,I as qe,aI as Ge,y as p,C as Ke,L as u,u as X,M as B,ap as j,O as Y,ac as Pe,D as Z}from"./vendor-vue-fFWwKrgY.js";import{E as _,h as Oe,v as je,w as He}from"./vendor-element-plus-CtVxZ4Oy.js";import{a as Je,b as Qe,e as We,f as Xe}from"./customerChannel-0OTur5MX.js";import{_ as Ye,u as Ze,R as F}from"./index-3lhbV5Mm.js";import"./vendor-lodash-rvV0CIkQ.js";import"./vendor-DWCz07M-.js";import"./vendor-dates-DVKSwKij.js";import"./http-CBIyYC5i.js";import"./vendor-axios-C0Zqfgkc.js";import"./vendor-vue-router-CVyACjsp.js";import"./vendor-pinia-CMXa-Za0.js";const el={class:"page"},ll={class:"page-header"},al={class:"header-actions"},tl={class:"toolbar-row"},nl={class:"toolbar-content"},ol={class:"toolbar-fields"},sl={class:"toolbar-actions"},il={class:"table-scroll"},rl={class:"code-cell"},ul={class:"code-text"},dl={class:"pagination-bar"},cl={class:"contacts-wrap"},pl={class:"contacts-toolbar"},vl={key:0,class:"contacts-empty"},ml={key:1,class:"contacts-list"},fl={class:"dialog-footer"},_l={class:"cd"},gl={class:"cd-icon-wrap"},yl={class:"cd-body"},bl={class:"cd-title"},Cl={class:"cd-code"},hl={class:"cd-footer"},wl={__name:"ChannelList",setup(kl){const ie=Ze(),N=x(()=>String(ie.roleName||"").trim().toLowerCase()),D=x(()=>N.value!==F.FINANCE),H=x(()=>N.value===F.SUPER_ADMIN),J=x(()=>N.value===F.SUPER_ADMIN||N.value===F.MANAGER||N.value===F.MARKET),k=v(!1),g=v(!1),b=v(1),Q=v(20),ee=v(0),le=v([]);let T=0;const f=v({channel_code:"",channel_name:"",region:"",created_by:""});function q(l){const e=String(l??"").trim();return e||""}function ae(l){return!!l?.is_deleted||!!l?.deleted_at}function re(l){const e=String(l||"").trim().toLowerCase();return e==="mobile"?"手机号":e==="tel"?"座机":e||""}function ue(l){return!Array.isArray(l)||!l.length?"":l.map(e=>{if(!e)return"";const s=re(e.type),n=e.value?String(e.value):"";return s?`${s}:${n}`:n}).filter(Boolean).join("；")}async function h(){const l=++T;g.value=!0;try{const e={page:b.value,page_size:Q.value};H.value&&k.value&&(e.include_deleted=1);const s=q(f.value.channel_code),n=q(f.value.channel_name),d=q(f.value.region),c=q(f.value.created_by);s&&(e.channel_code=s),n&&(e.channel_name=n),d&&(e.region=d),c&&(e.created_by=c);const L=await Je(e);if(l!==T)return;const z=L?.data||{};ee.value=Number(z.total||0),le.value=Array.isArray(z.items)?z.items:[]}catch(e){if(l!==T)return;console.error(e),_.error(e?.response?.data?.detail||e?.message||"渠道列表加载失败")}finally{l===T&&(g.value=!1)}}function de(){h()}function w(){b.value=1,h()}function ce(){f.value={channel_code:"",channel_name:"",region:"",created_by:""},b.value=1,h()}const te=x(()=>le.value||[]);function pe(l){b.value=l,h()}function ve(l){Q.value=l,b.value=1,h()}function me(){H.value&&(k.value=!k.value,b.value=1,h())}const $=v(!1),W=v(!1),I=v(null),E=v("create"),G=v(null),fe=x(()=>E.value==="edit"?"编辑渠道":"新增渠道");function _e(){return{type:"mobile",value:""}}const r=v({channel_code:"",channel_name:"",region:"",contacts:[]}),ge=/^1[3-9]\d{9}$/,ye=/^(0\d{2,3}-?)?\d{7,8}(-\d{1,6})?$/,be=/^(400|800)\d{7}$/;function K(l){return String(l??"").replace(/\s+/g,"").replace(/[^0-9\-]/g,"")}function Ce(l){const e=String(l?.type||"").trim().toLowerCase(),s=K(l?.value||"");if(!s)return"联系方式不能为空（不需要可删除该行）";if(e==="mobile"){const n=s.replace(/-/g,"");return ge.test(n)?"":"手机号格式不正确（需为 11 位大陆手机号）"}if(e==="tel"){const n=s.replace(/-/g,"");return be.test(n)||ye.test(s)?"":"座机格式不正确（示例：010-88888888 / 0571-8888888 / 010-88888888-123 / 400xxxxxxx）"}return"联系方式类型仅支持：手机号/座机"}async function P(){if(!I.value)return!0;try{return await I.value.validateField("contacts"),!0}catch{return!1}}function he(){const l=Array.isArray(r.value.contacts)?r.value.contacts:[],e=new Set,s=[];for(const n of l){const d=String(n?.type||"").trim().toLowerCase()||"mobile",c=K(n?.value||"");if(!c)continue;if(d==="mobile"){const z=c.replace(/-/g,""),C=`${d}:${z}`;if(e.has(C))continue;e.add(C),s.push({type:d,value:z});continue}const L=`${d}:${c}`;e.has(L)||(e.add(L),s.push({type:d,value:c}))}return s}function we(l){return(Array.isArray(l)?l:[]).map(s=>({type:String(s?.type||"mobile").trim().toLowerCase()==="tel"?"tel":"mobile",value:K(s?.value||"")}))}const ke={channel_code:[{required:!0,message:"渠道代码必填",trigger:"blur"}],channel_name:[{required:!0,message:"渠道名称必填",trigger:"blur"}],contacts:[{trigger:["change","blur"],validator:(l,e,s)=>{const n=Array.isArray(r.value.contacts)?r.value.contacts:[];for(let d=0;d<n.length;d++){const c=Ce(n[d]);if(c)return s(new Error(`第 ${d+1} 条联系方式：${c}`))}s()}}]};function Ve(){if(!D.value){_.warning("财务账号无新增权限");return}E.value="create",G.value=null,r.value={channel_code:"",channel_name:"",region:"",contacts:[]},$.value=!0}function ze(l){if(!J.value){_.warning("仅经理/超级账号/市场账号可编辑");return}l?.id&&(E.value="edit",G.value=l.id,r.value={channel_code:String(l.channel_code||""),channel_name:String(l.channel_name||l.group_name||""),region:String(l.region||""),contacts:we(l.contacts)},$.value=!0)}function Se(){Array.isArray(r.value.contacts)||(r.value.contacts=[]),r.value.contacts.push(_e()),Z(()=>P())}function xe(l){Array.isArray(r.value.contacts)&&(r.value.contacts.splice(l,1),Z(()=>P()))}function Ae(l){const s=(r.value.contacts||[])[l];s&&(s.type=String(s.type||"mobile").trim().toLowerCase(),Z(()=>P()))}function De(l,e){const n=(r.value.contacts||[])[l];n&&(n.value=K(e))}async function $e(){if(E.value==="create"){if(!D.value){_.warning("财务账号无新增权限");return}}else{if(!J.value){_.warning("仅经理/超级账号/市场账号可编辑");return}if(!G.value)return}if(I.value){try{await I.value.validate()}catch{return}W.value=!0;try{const l={channel_code:r.value.channel_code,channel_name:r.value.channel_name,region:r.value.region,contacts:he()};E.value==="edit"?(await Qe(G.value,l),_.success("编辑渠道成功")):(await We(l),_.success("新增渠道成功")),$.value=!1,b.value=1,await h()}catch(l){console.error(l),_.error(l?.response?.data?.detail||l?.message||(E.value==="edit"?"编辑渠道失败":"新增渠道失败"))}finally{W.value=!1}}}const R=v(!1),M=v(!1),V=v(null),Ee=x(()=>{const l=V.value?.channel_code?String(V.value.channel_code):"",e=V.value?.channel_name?String(V.value.channel_name):"";return l&&e?`${l} - ${e}`:l||e||"-"});function Le(l){if(!D.value){_.warning("财务账号无删除权限");return}l?.id&&(V.value=l,R.value=!0)}function Ue(){V.value=null,M.value=!1}async function Ne(){if(!D.value){_.warning("财务账号无删除权限");return}if(V.value?.id){M.value=!0;try{await Xe(V.value.id),_.success("删除成功"),R.value=!1,te.value.length<=1&&b.value>1&&(b.value-=1),await h()}catch(l){console.error(l),_.error(l?.response?.data?.detail||l?.message||"删除失败")}finally{M.value=!1}}}return Te(()=>h()),(l,e)=>{const s=m("el-icon"),n=m("el-button"),d=m("el-tooltip"),c=m("el-input"),L=m("el-card"),z=m("el-tag"),C=m("el-table-column"),Ie=m("el-table"),Re=m("el-pagination"),O=m("el-form-item"),ne=m("el-option"),Me=m("el-select"),Be=m("el-form"),oe=m("el-dialog"),Fe=Ge("loading");return p(),A("div",el,[i("div",ll,[e[14]||(e[14]=i("h2",null,"渠道管理",-1)),i("div",al,[H.value?(p(),y(d,{key:0,content:k.value?"点击隐藏已删除":"点击显示已删除",placement:"top"},{default:t(()=>[a(n,{size:"small",class:Ke(["toggle-btn",{"toggle-btn--active":k.value}]),type:k.value?"info":"default",plain:!0,loading:g.value,onClick:me},{default:t(()=>[a(s,{class:"btn-ico"},{default:t(()=>[k.value?(p(),y(X(Oe),{key:0})):(p(),y(X(je),{key:1}))]),_:1}),u(" "+B(k.value?"隐藏已删除":"显示已删除"),1)]),_:1},8,["class","type","loading"])]),_:1},8,["content"])):se("",!0),D.value?(p(),y(n,{key:2,type:"primary",size:"small",onClick:Ve},{default:t(()=>[...e[13]||(e[13]=[u("新增渠道",-1)])]),_:1})):(p(),y(d,{key:1,content:"财务账号无新增权限",placement:"top"},{default:t(()=>[i("span",null,[a(n,{type:"primary",size:"small",disabled:""},{default:t(()=>[...e[12]||(e[12]=[u("新增渠道",-1)])]),_:1})])]),_:1}))])]),a(L,{shadow:"never",class:"toolbar-card","body-style":{padding:"10px 12px"}},{default:t(()=>[i("div",tl,[e[18]||(e[18]=i("div",{class:"toolbar-label"},"搜索：",-1)),i("div",nl,[i("div",ol,[a(c,{modelValue:f.value.channel_code,"onUpdate:modelValue":e[0]||(e[0]=o=>f.value.channel_code=o),size:"small",clearable:"",placeholder:"渠道代码（模糊）",class:"toolbar-input",disabled:g.value,onKeyup:j(w,["enter"]),onClear:w},null,8,["modelValue","disabled"]),a(c,{modelValue:f.value.channel_name,"onUpdate:modelValue":e[1]||(e[1]=o=>f.value.channel_name=o),size:"small",clearable:"",placeholder:"渠道名称（模糊）",class:"toolbar-input",disabled:g.value,onKeyup:j(w,["enter"]),onClear:w},null,8,["modelValue","disabled"]),a(c,{modelValue:f.value.region,"onUpdate:modelValue":e[2]||(e[2]=o=>f.value.region=o),size:"small",clearable:"",placeholder:"归属地（模糊）",class:"toolbar-input",disabled:g.value,onKeyup:j(w,["enter"]),onClear:w},null,8,["modelValue","disabled"]),a(c,{modelValue:f.value.created_by,"onUpdate:modelValue":e[3]||(e[3]=o=>f.value.created_by=o),size:"small",clearable:"",placeholder:"创建人（模糊）",class:"toolbar-input",disabled:g.value,onKeyup:j(w,["enter"]),onClear:w},null,8,["modelValue","disabled"])]),i("div",sl,[a(n,{size:"small",disabled:g.value,onClick:ce},{default:t(()=>[...e[15]||(e[15]=[u("重置",-1)])]),_:1},8,["disabled"]),a(n,{type:"primary",size:"small",loading:g.value,onClick:w},{default:t(()=>[...e[16]||(e[16]=[u("搜索",-1)])]),_:1},8,["loading"]),a(n,{size:"small",onClick:de,loading:g.value},{default:t(()=>[...e[17]||(e[17]=[u("刷新",-1)])]),_:1},8,["loading"])])])])]),_:1}),i("div",il,[qe((p(),y(Ie,{data:te.value,border:"",stripe:"",class:"main-table"},{default:t(()=>[a(C,{prop:"channel_code",label:"渠道代码","min-width":"170","show-overflow-tooltip":""},{default:t(({row:o})=>[i("div",rl,[i("span",ul,B(o.channel_code||"-"),1),ae(o)?(p(),y(z,{key:0,size:"small",type:"info",class:"deleted-tag"},{default:t(()=>[...e[19]||(e[19]=[u("已删除",-1)])]),_:1})):se("",!0)])]),_:1}),a(C,{prop:"channel_name",label:"渠道名称","min-width":"180","show-overflow-tooltip":""},{default:t(({row:o})=>[u(B(o.channel_name||o.group_name||"-"),1)]),_:1}),a(C,{prop:"region",label:"归属地","min-width":"140","show-overflow-tooltip":""}),a(C,{label:"联系方式","min-width":"220","show-overflow-tooltip":""},{default:t(({row:o})=>[u(B(ue(o.contacts)),1)]),_:1}),a(C,{prop:"created_by_name",label:"创建人",width:"120","show-overflow-tooltip":""}),a(C,{prop:"created_at",label:"创建时间",width:"180","show-overflow-tooltip":""}),a(C,{label:"操作",width:"160",fixed:"right","class-name":"col-actions"},{default:t(({row:o})=>[ae(o)?(p(),A(Y,{key:0},[a(d,{content:"该渠道已删除",placement:"top"},{default:t(()=>[i("span",null,[a(n,{type:"primary",size:"small",link:"",disabled:""},{default:t(()=>[...e[20]||(e[20]=[u("编辑",-1)])]),_:1})])]),_:1}),a(d,{content:"该渠道已删除",placement:"top"},{default:t(()=>[i("span",null,[a(n,{type:"danger",size:"small",link:"",disabled:""},{default:t(()=>[...e[21]||(e[21]=[u("删除",-1)])]),_:1})])]),_:1})],64)):(p(),A(Y,{key:1},[J.value?(p(),y(n,{key:1,type:"primary",size:"small",link:"",onClick:U=>ze(o)},{default:t(()=>[...e[23]||(e[23]=[u("编辑",-1)])]),_:1},8,["onClick"])):(p(),y(d,{key:0,content:"仅经理/超级账号/市场账号可编辑",placement:"top"},{default:t(()=>[i("span",null,[a(n,{type:"primary",size:"small",link:"",disabled:""},{default:t(()=>[...e[22]||(e[22]=[u("编辑",-1)])]),_:1})])]),_:1})),D.value?(p(),y(n,{key:3,type:"danger",size:"small",link:"",onClick:U=>Le(o)},{default:t(()=>[...e[25]||(e[25]=[u("删除",-1)])]),_:1},8,["onClick"])):(p(),y(d,{key:2,content:"财务账号无删除权限",placement:"top"},{default:t(()=>[i("span",null,[a(n,{type:"danger",size:"small",link:"",disabled:""},{default:t(()=>[...e[24]||(e[24]=[u("删除",-1)])]),_:1})])]),_:1}))],64))]),_:1})]),_:1},8,["data"])),[[Fe,g.value]])]),i("div",dl,[a(Re,{background:"",layout:"prev, pager, next, jumper, sizes, total","current-page":b.value,"page-size":Q.value,total:ee.value,"page-sizes":[10,20,50,100],onCurrentChange:pe,onSizeChange:ve},null,8,["current-page","page-size","total"])]),a(oe,{modelValue:$.value,"onUpdate:modelValue":e[9]||(e[9]=o=>$.value=o),title:fe.value,width:"520px","destroy-on-close":""},{footer:t(()=>[i("span",fl,[a(n,{onClick:e[8]||(e[8]=o=>$.value=!1)},{default:t(()=>[...e[29]||(e[29]=[u("取消",-1)])]),_:1}),a(n,{type:"primary",loading:W.value,onClick:$e},{default:t(()=>[...e[30]||(e[30]=[u("保存",-1)])]),_:1},8,["loading"])])]),default:t(()=>[a(Be,{model:r.value,rules:ke,ref_key:"formRef",ref:I,"label-width":"90px"},{default:t(()=>[a(O,{label:"渠道代码",prop:"channel_code"},{default:t(()=>[a(c,{modelValue:r.value.channel_code,"onUpdate:modelValue":e[4]||(e[4]=o=>r.value.channel_code=o),clearable:""},null,8,["modelValue"])]),_:1}),a(O,{label:"渠道名称",prop:"channel_name"},{default:t(()=>[a(c,{modelValue:r.value.channel_name,"onUpdate:modelValue":e[5]||(e[5]=o=>r.value.channel_name=o),clearable:""},null,8,["modelValue"])]),_:1}),a(O,{label:"归属地",prop:"region"},{default:t(()=>[a(c,{modelValue:r.value.region,"onUpdate:modelValue":e[6]||(e[6]=o=>r.value.region=o),clearable:""},null,8,["modelValue"])]),_:1}),a(O,{label:"联系方式",prop:"contacts"},{default:t(()=>[i("div",cl,[i("div",pl,[a(n,{size:"small",onClick:Se},{default:t(()=>[...e[26]||(e[26]=[u("添加联系方式",-1)])]),_:1}),e[27]||(e[27]=i("div",{class:"contacts-hint"},"仅支持：手机号 / 座机（可多条）",-1))]),r.value.contacts.length?(p(),A("div",ml,[(p(!0),A(Y,null,Pe(r.value.contacts,(o,U)=>(p(),A("div",{key:U,class:"contacts-row"},[a(Me,{modelValue:o.type,"onUpdate:modelValue":S=>o.type=S,class:"contacts-type",placeholder:"类型",onChange:S=>Ae(U)},{default:t(()=>[a(ne,{label:"手机号",value:"mobile"}),a(ne,{label:"座机",value:"tel"})]),_:1},8,["modelValue","onUpdate:modelValue","onChange"]),a(c,{modelValue:o.value,"onUpdate:modelValue":S=>o.value=S,class:"contacts-value",clearable:"",placeholder:"手机号：11位；座机：010-88888888 / 400xxxxxxx",onInput:S=>De(U,S),onBlur:e[7]||(e[7]=()=>P())},null,8,["modelValue","onUpdate:modelValue","onInput"]),a(n,{type:"danger",size:"small",link:"",class:"contacts-remove",onClick:S=>xe(U)},{default:t(()=>[...e[28]||(e[28]=[u(" 删除 ",-1)])]),_:1},8,["onClick"])]))),128))])):(p(),A("div",vl,"未添加联系方式"))])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"]),a(oe,{modelValue:R.value,"onUpdate:modelValue":e[11]||(e[11]=o=>R.value=o),width:"440px","destroy-on-close":"","append-to-body":"","show-close":!1,class:"confirm-dialog",onClosed:Ue},{footer:t(()=>[i("div",hl,[a(n,{onClick:e[10]||(e[10]=o=>R.value=!1),disabled:M.value},{default:t(()=>[...e[34]||(e[34]=[u("取消",-1)])]),_:1},8,["disabled"]),a(n,{type:"danger",loading:M.value,onClick:Ne},{default:t(()=>[...e[35]||(e[35]=[u("确认删除",-1)])]),_:1},8,["loading"])])]),default:t(()=>[i("div",_l,[i("div",gl,[a(s,{class:"cd-icon"},{default:t(()=>[a(X(He))]),_:1})]),i("div",yl,[i("div",bl,[e[31]||(e[31]=u("确认删除渠道：",-1)),i("span",Cl,B(Ee.value),1),e[32]||(e[32]=u("？",-1))]),e[33]||(e[33]=i("div",{class:"cd-desc"},"删除后会移入“已删除”，订单详情页下拉选项将不再展示。",-1))])])]),_:1},8,["modelValue"])])}}},Il=Ye(wl,[["__scopeId","data-v-6ec67fcc"]]);export{Il as default};
