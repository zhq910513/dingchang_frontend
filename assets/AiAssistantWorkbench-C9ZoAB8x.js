import{r as y,c as M,o as st,q as at,Y as nt,x as w,P as v,z as i,H as h,ay as j,D as it,y as d,J as z,L as S,M as C,O as ce,ac as de,C as Le,X as Oe,G,u as O,f as ot,ap as rt}from"./vendor-vue-CZOMRj4y.js";import{h as oe}from"./http-DGyH82Tn.js";import{E as R,b as X,d as lt}from"./vendor-element-plus-nv6hIq5t.js";import{i as ut,u as Ee}from"./orders-f2TW8mPj.js";import{u as ct}from"./bosUpload-Bf8-Xtq-.js";import{_ as dt}from"./index-BffKbIYS.js";import"./vendor-axios-C0Zqfgkc.js";import"./vendor-lodash-rvV0CIkQ.js";import"./vendor-DWCz07M-.js";import"./vendor-dates-DVKSwKij.js";import"./vendor-vue-router-o2a2TmKO.js";import"./vendor-pinia--LqfdQ-h.js";function Me(a){const o={};for(const[m,s]of Object.entries(a||{}))s!==void 0&&(o[m]=s);return o}function Re(a){const o=String(a||"").trim();if(!o)throw new Error("aiAssistant api: invalid session_id");return o}function ft(){return oe.get("/ai-assistant/sessions")}function mt(a){return oe.get(`/ai-assistant/sessions/${encodeURIComponent(Re(a))}/history`)}function pt(a){return oe.delete(`/ai-assistant/sessions/${encodeURIComponent(Re(a))}`)}function gt(a={}){return oe.post("/ai-assistant/chat",Me({session_id:a.session_id?String(a.session_id).trim():void 0,message:String(a.message||"").trim(),history:Array.isArray(a.history)?a.history:[],context:a.context&&typeof a.context=="object"?a.context:{},stream:!1}))}async function _t({session_id:a,message:o,history:m=[],context:s={},onEvent:p,signal:f}={}){try{const r=await oe.post("/ai-assistant/chat",Me({session_id:a?String(a).trim():void 0,message:String(o||"").trim(),history:Array.isArray(m)?m:[],context:s&&typeof s=="object"?s:{},stream:!0}),{signal:f}),x=r&&r.data!==void 0?r.data:r;return typeof p=="function"&&p({type:"final",data:x}),x}catch(r){const x=r?.message?String(r.message):"aiChatStream failed";throw typeof p=="function"&&p({type:"error",message:x}),r}}function vt(a){return String(a||"").trim()}function yt(a){const o=vt(a);if(!o)return{kind:"empty"};if(o==="新一单"||o.toLowerCase()==="/new")return{kind:"action",action:"new_session",text:o};const m=o.match(/^(.+?)\s*报价$/);if(m){const s=String(m[1]||"").trim();if(s)return{kind:"quote",action:"quote",platform_hint:s,text:o}}return{kind:"text",text:o}}function Te(a){return/[\u4e00-\u9fa5]/.test(String(a||""))}function fe(a,o="操作失败，请稍后重试"){const m=a?.response?.data?.detail,s=a?.response?.data?.message||a?.message||"";if(typeof m=="string"&&m&&Te(m))return m;if(typeof s=="string"&&s&&Te(s))return s;const p=a?.response?.status;return p===401?"登录状态已失效，请重新登录":p===403?"无权限执行该操作":p>=500?"服务器异常，请稍后重试":o}function wt(a){const o=a?.data?.data??a?.data??{};return(Array.isArray(o?.items)?o.items:[]).map(s=>({session_id:s.session_id,title:s.title||"新会话",created_at:s.created_at||"",updated_at:s.updated_at||"",last_message_preview:s.last_message_preview||"",message_count:s.message_count??0}))}function ht(a){const o=a?.data?.data??a?.data??{};return(Array.isArray(o?.items)?o.items:[]).map((s,p)=>({id:`${s.created_at||"t"}_${p}`,role:s.role||"assistant",content:s.content||"",created_at:s.created_at||"",metadata:s.metadata||{}}))}function Ue(){const a=y(!1),o=y(!1),m=y(!1),s=y(!1),p=y([]),f=y(""),r=y([]),x=y("");let H=null;async function N(){o.value=!0;try{const k=await ft();p.value=wt(k)}catch(k){X.error({title:"会话列表加载失败",message:fe(k,"加载会话列表失败"),duration:4e3})}finally{o.value=!1}}async function B(k){const U=String(k||f.value||"").trim();if(!U){r.value=[];return}m.value=!0;try{const E=await mt(U);f.value=U,r.value=ht(E)}catch(E){X.error({title:"历史消息加载失败",message:fe(E,"加载历史消息失败"),duration:4e3}),r.value=[]}finally{m.value=!1}}async function Q(){a.value=!0;try{await N(),p.value.length>0?await B(p.value[0].session_id):(f.value="",r.value=[{id:`local_${Date.now()}`,role:"system",content:"报价助手已就绪。你可以直接问：查订单 / 查财务 / 某字段是什么意思 / 平台A 报价",created_at:new Date().toISOString(),metadata:{}}])}finally{a.value=!1}}function se(k){r.value.push({id:`local_${Date.now()}_${Math.random().toString(36).slice(2,8)}`,...k})}async function ae(k){if(k){if(s.value&&H)try{H.abort()}catch{}await B(k)}}async function ne(){f.value="",r.value=[{id:`local_${Date.now()}`,role:"system",content:"已新建会话（本地态）。发送第一条消息后后端会生成 session_id。",created_at:new Date().toISOString(),metadata:{}}],R.success("已新建会话")}async function K(k){try{await pt(k),String(f.value)===String(k)&&(f.value="",r.value=[]),await N(),R.success("会话已删除")}catch(U){X.error({title:"删除失败",message:fe(U,"删除会话失败"),duration:4e3})}}async function re(k,{useStream:U=!0,pageContext:E={}}={}){const Y=yt(k);if(Y.kind==="empty"){R.warning("请输入内容");return}if(Y.kind==="action"&&Y.action==="new_session"){await ne();return}const ee=Y.text;se({role:"user",content:ee,created_at:new Date().toISOString(),metadata:{}});const q=`assistant_pending_${Date.now()}`;se({id:q,role:"assistant",content:"",created_at:new Date().toISOString(),metadata:{status:"sending"}}),s.value=!0,x.value=Y.kind==="quote"?"已识别报价指令，正在处理…":"正在处理…";try{if(!U){const g=await gt({session_id:f.value||void 0,message:ee,context:E}),_=g?.data?.data??g?.data??{},P=r.value.findIndex(t=>t.id===q);P>=0&&(r.value[P]={...r.value[P],content:_.reply||"",metadata:{...r.value[P].metadata,status:_.ok?"success":"error",trace_id:_.trace_id,intent:_.intent,confidence:_.confidence,actions:_.actions||[],error:_.error||null}}),_.session_id&&(f.value=_.session_id),_.ok||X.warning({title:"报价助手返回异常",message:_?.error?.message||"请求处理失败",duration:4e3}),await N(),f.value&&await B(f.value);return}const J=new AbortController;H=J;let D={trace_id:"",intent:"",confidence:0,actions:[]};await _t({session_id:f.value||void 0,message:ee,context:E,signal:J.signal,onEvent:g=>{const _=r.value.findIndex(P=>P.id===q);if(!(_<0)){if(g.type==="meta"){g.session_id&&(f.value=g.session_id),r.value[_].metadata={...r.value[_].metadata||{},trace_id:g.trace_id||"",model:g.model||"",status:"streaming"};return}if(g.type==="delta"){r.value[_].content=(r.value[_].content||"")+String(g.content||""),r.value[_].metadata={...r.value[_].metadata||{},status:"streaming"};return}if(g.type==="done"){D={trace_id:g.trace_id||"",intent:g.intent||"",confidence:g.confidence||0,actions:Array.isArray(g.actions)?g.actions:[]},r.value[_].metadata={...r.value[_].metadata||{},...D,status:"success",cost_ms:g.cost_ms||0};return}g.type==="error"&&(r.value[_].content=g.message||"报价助手流式处理失败",r.value[_].metadata={...r.value[_].metadata||{},status:"error",error_code:g.code||"INTERNAL_ERROR"})}}}),await N(),f.value&&await B(f.value)}catch(J){const D=r.value.findIndex(g=>g.id===q);D>=0&&(r.value[D]={...r.value[D],content:fe(J,"发送失败，请稍后重试"),metadata:{...r.value[D].metadata||{},status:"error"}}),X.error({title:"发送失败",message:fe(J,"发送失败，请稍后重试"),duration:4e3})}finally{x.value="",s.value=!1,H=null}}const ie=M(()=>p.value.find(U=>U.session_id===f.value)?.title||(f.value?"当前会话":"新会话"));return{loadingInit:a,loadingSessions:o,loadingHistory:m,sending:s,sessions:p,currentSessionId:f,currentSessionTitle:ie,messages:r,processHint:x,ensureInit:Q,refreshSessions:N,loadHistory:B,switchSession:ae,createNewSessionLocal:ne,removeSession:K,sendMessage:re}}const te=[{key:"vehicle_cert",label:"合格证",multiple:!1,ocrEnabled:!0},{key:"idcard_front",label:"身份证正面",multiple:!1,ocrEnabled:!0},{key:"idcard_back",label:"身份证反面",multiple:!1,ocrEnabled:!0},{key:"driving_license_main",label:"行驶证主页",multiple:!1,ocrEnabled:!0},{key:"driving_license_sub",label:"行驶证副页",multiple:!1,ocrEnabled:!0},{key:"related",label:"相关图片(多张)",multiple:!0,ocrEnabled:!1}];function St(a){return te.find(o=>o.key===a)?.label||a}function $e(a){return!!te.find(o=>o.key===a)?.multiple}function ze(a){return/[\u4e00-\u9fa5]/.test(String(a||""))}function Ne(a){const o=a?.response?.data?.detail||a?.response?.data?.message||a?.message||"";return String(o||"")}function me(a,o="操作失败，请稍后重试"){const m=a?.response?.data?.detail,s=Ne(a),p=a?.response?.status,f=String(a?.code||"");if(typeof m=="string"&&m&&ze(m))return m;if(s&&ze(s))return s;const r=s.toLowerCase();return r.includes("network error")||r.includes("failed to fetch")?"网络异常，请检查网络连接":r.includes("timeout")||f.includes("ECONNABORTED")?"请求超时，请稍后重试":p===401?"登录状态已失效，请重新登录":p===403?"无权限执行该操作":p>=500?"服务器异常，请稍后重试":o}function kt(a){const o=Ne(a).toLowerCase();return o.includes("failed to fetch")||o.includes("network error")||o.includes("err_")||o.includes("cors")||o.includes("代理")||o.includes("vpn")||o.includes("127.0.0.1:7890")}function bt(){const a="ai_assistant_upload_mode",o=y("stable");try{const t=localStorage.getItem(a);(t==="smart"||t==="direct"||t==="stable")&&(o.value=t)}catch{}function m(){try{localStorage.setItem(a,o.value)}catch{}}const s=y(te.reduce((t,l)=>(t[l.key]=[],t),{})),p=y({}),f=y({}),r=y(0),x=y({}),H=y("");let N=null,B=0;function Q(t){try{return Date.parse(t)}catch{return 0}}async function se(){const t=Date.now();if(N&&B&&t+12e4<B)return N;const u=(await oe.get("/orders/bos-sts"))?.data;if(!u?.accessKeyId||!u?.secretAccessKey||!u?.sessionToken)throw new Error("获取上传凭证失败：返回数据不完整");return N=u,H.value=u.bosHost||"",B=Q(u.expiration)||t+600*1e3,N}function ae(t){const l=t?.raw;if(l&&!t.url){const u=URL.createObjectURL(l);t.url=u,x.value[t.uid]=u}}function ne(t){p.value[t]&&delete p.value[t],f.value[t]&&delete f.value[t];const l=x.value[t];if(l){try{URL.revokeObjectURL(l)}catch{}delete x.value[t]}}function K(t){const l=s.value[t]||[];for(const u of l)u?.uid&&ne(u.uid);s.value[t]=[]}function re(){for(const t of te)K(t.key)}function ie(t){return $e(t)?!1:(s.value[t]||[]).length>=1}function k(t){R.warning(`${St(t)}：请先删除当前图片，再上传新图片`)}function U(t){const l=s.value[t]||[];return l.length?l[0]:null}async function E(t,l){const u=l?.raw;if(u&&!p.value[l.uid]){r.value+=1,f.value[l.uid]={status:"uploading"};try{if(o.value==="stable"){const A=(await Ee({slot_key:t,file:u}))?.data||{},Z=A?.url||A?.preview_url||"";p.value[l.uid]={slot_key:t,md5:A?.md5||"",storage_key:A?.storage_key||"",etag:A?.etag||"",size:A?.size||u.size||0,content_type:A?.content_type||u.type||"application/octet-stream",original_name:A?.original_name||u.name||"file",url:Z,preview_url:Z},Z&&(l.url=Z),f.value[l.uid]={status:"done"};return}const b=await se();if(!H.value)throw new Error("上传配置缺失：bosHost 为空");const I=await ct({bosHost:H.value,slotKey:t,file:u,sts:b}),L=I?.url||I?.preview_url||"";p.value[l.uid]={slot_key:t,...I,url:L,preview_url:L},L&&(l.url=L),f.value[l.uid]={status:"done"}}catch(b){if(o.value==="smart"&&kt(b))try{o.value="stable",m();const L=(await Ee({slot_key:t,file:u}))?.data||{},V=L?.url||L?.preview_url||"";p.value[l.uid]={slot_key:t,md5:L?.md5||"",storage_key:L?.storage_key||"",etag:L?.etag||"",size:L?.size||u.size||0,content_type:L?.content_type||u.type||"application/octet-stream",original_name:L?.original_name||u.name||"file",url:V,preview_url:V},V&&(l.url=V),f.value[l.uid]={status:"done"},R.warning("已自动切换为稳定上传模式");return}catch(I){throw f.value[l.uid]={status:"error",msg:me(I)},I}throw f.value[l.uid]={status:"error",msg:me(b)},b}finally{r.value-=1}}}function Y(t,l){if(!$e(t)){if(ie(t)){k(t);return}K(t),ae(l),s.value[t]=[l],E(t,l).catch(b=>{X.error({title:"上传失败",message:me(b),duration:4e3})});return}const u=s.value[t]||[];u.find(b=>b.uid===l.uid)||u.push(l),s.value[t]=u,ae(l),E(t,l).catch(b=>{X.error({title:"上传失败",message:me(b),duration:4e3})})}function ee(t){return(s.value[t]||[]).filter(u=>!!p.value[u.uid]).length}function q(t){return(s.value[t]||[]).filter(u=>f.value[u.uid]?.status==="uploading").length}function J(t){return(s.value[t]||[]).map(u=>u.url).filter(Boolean)}const D=M(()=>te.some(t=>(s.value[t.key]||[]).some(l=>!!p.value[l.uid])));function g(){const t=[];for(const l of te){const u=s.value[l.key]||[];for(const b of u){const I=p.value[b.uid];I?.slot_key&&I?.storage_key&&t.push(I)}}return t}async function _(t,{clearRelated:l=!1,triggerOcr:u=!0}={}){const b=Number(t);if(!Number.isInteger(b)||b<=0)throw new Error("order_id 无效");const I=g();if(!I.length)return R.warning("请先上传图片"),{ok:!1,order_id:b,bound_count:0};const L=l?["related"]:[];try{const A=(await ut({order_id:b,images:I,clear_slots:L,trigger_ocr:!!u}))?.data||{};if(A?.ok){const Z=A?.ocr_task_id?`（OCR任务#${A.ocr_task_id}：${A.ocr_status||""}）`:"";R.success(`材料已绑定：${A.bound_count||0} 张${Z}`)}return A}catch(V){const A=me(V,"绑定失败，请稍后重试");throw X.error({title:"绑定失败",message:A,duration:4e3}),V}}function P(){for(const t of Object.keys(x.value))try{URL.revokeObjectURL(x.value[t])}catch{}x.value={}}return{AI_IMAGE_SLOTS:te,uploadMode:o,persistUploadMode:m,slotFiles:s,uploadedMap:p,uploadState:f,uploadingCount:r,hasAnyUploadedImage:D,onFileChange:Y,clearSlot:K,resetAllSlots:re,firstFile:U,previewUrls:J,isSingleSlotLocked:ie,onExceedWarn:k,slotUploadedCount:ee,slotUploadingCount:q,collectUploadedImages:g,bindUploadedImagesToOrder:_,destroy:P}}const Ct={class:"ai-page"},At={class:"head-row"},xt={class:"title-wrap"},It={class:"head-meta"},Lt={key:0},Ot={key:1},Et={class:"head-actions"},Tt={key:0,class:"top-hint"},Ut={class:"main-grid"},$t={class:"card-header"},zt={class:"side-body"},Mt={key:0,class:"empty-wrap"},Rt={key:1,class:"empty-wrap"},Nt={key:2,class:"session-list"},Ht=["onClick"],Bt={class:"s-title"},Dt={class:"s-preview"},Vt={class:"s-foot"},Ft={class:"upload-box"},jt={class:"upload-head"},qt={class:"upload-slots"},Pt={class:"upload-slot-title"},Wt={key:2,class:"upload-slot-meta"},Gt={key:3,class:"upload-slot-meta"},Yt={key:0,class:"slot-preview"},Jt={class:"upload-actions"},Xt={class:"card-header"},Qt={key:0,class:"empty-wrap"},Zt={key:1,class:"empty-wrap"},Kt={key:2,class:"msg-list"},es={class:"msg-avatar"},ts={class:"msg-content"},ss={class:"msg-head"},as={class:"msg-role"},ns={class:"msg-time"},is={class:"msg-bubble"},os={class:"msg-text"},rs={key:0,class:"data-hint"},ls={key:1,class:"data-block"},us={class:"json-pre"},cs={key:2,class:"action-wrap"},ds={class:"action-list"},fs={key:3,class:"err-wrap"},ms={class:"chat-input-wrap"},ps={class:"input-actions"},gs={class:"btns"},_s={__name:"AiAssistantWorkbench",setup(a){const o=y(null),m=y(""),s=(typeof Ue=="function"?Ue():{})||{},p=s.loadingInit??y(!1),f=s.loadingSessions??y(!1),r=s.loadingHistory??y(!1),x=s.sending??y(!1),H=s.sessions??y([]),N=s.currentSessionId??y(""),B=s.currentSessionTitle??y("新会话"),Q=s.messages??y([]),se=s.processHint??y(""),ae=s.ensureInit??(async()=>{}),ne=s.refreshSessions??(async()=>{}),K=s.loadHistory??(async()=>{}),re=s.switchSession??(async()=>{}),ie=s.createNewSessionLocal??(()=>{}),k=s.removeSession??(async()=>{}),U=s.sendMessage??(async()=>{}),E=M(()=>{const c=Array.isArray(Q.value)?Q.value:[];for(let e=c.length-1;e>=0;e--){const T=c[e],$=T?.metadata?.data?.entities?.order_id??T?.metadata?.entities?.order_id??null,F=Number($);if(Number.isInteger(F)&&F>0)return F}return null}),Y=bt(),{AI_IMAGE_SLOTS:ee,uploadMode:q,persistUploadMode:J,slotFiles:D,uploadingCount:g,onFileChange:_,resetAllSlots:P,previewUrls:t,onExceedWarn:l,slotUploadedCount:u,slotUploadingCount:b,collectUploadedImages:I,bindUploadedImagesToOrder:L,destroy:V}=Y,A=M(()=>!E.value||g.value>0?!1:I().length>0);async function Z(){if(!E.value){R.warning("当前会话未识别到 order_id，请先通过指令创建/选择订单");return}if(g.value>0){R.info("还有图片正在上传，请稍后再绑定");return}if(!I().length){R.warning("请先上传图片");return}try{await L(E.value,{clearRelated:!1,triggerOcr:!0})}catch(e){const T=e?.response?.data?.detail||e?.message||"绑定失败，请稍后重试";X.error({title:"绑定失败",message:String(T),duration:4e3})}}const He=M(()=>String(B.value||"新会话")),le=M(()=>String(N.value||"")),we=M(()=>!!p.value),he=M(()=>!!f.value),Se=M(()=>!!r.value),ke=M(()=>!!x.value),ge=M(()=>Array.isArray(H.value)?H.value:[]),_e=M(()=>Array.isArray(Q.value)?Q.value:[]),be=M(()=>String(se.value||""));async function Be(){try{await ne()}catch{}}function De(){try{ie()}catch{}}function Ve(c){const e=String(c||"").toLowerCase();return e==="user"?"我":e==="assistant"?"报":"系"}function Fe(c){const e=String(c||"").toLowerCase();return e==="user"?"用户":e==="assistant"?"报价助手":"系统"}function je(c){const e=String(c||"").toLowerCase();return e==="success"?"success":e==="streaming"||e==="sending"?"warning":e==="error"||e==="failed"?"danger":"info"}function qe(c){const e=String(c||"").toLowerCase();return e==="success"?"success":e==="not_ready"?"warning":e==="need_more_info"||e==="empty"?"info":e==="invalid_command"||e==="failed"?"danger":"info"}function Pe(c){const e=String(c||"").toLowerCase();return e==="success"?"success":e==="not_ready"?"warning":e==="need_more_info"||e==="empty"?"info":e==="invalid_command"||e==="failed"?"error":"info"}function We(c){const e=String(c||"").toLowerCase();return e==="success"?"成功":e==="empty"?"无数据":e==="invalid_command"?"指令错误":e==="need_more_info"?"需要补充":e==="not_ready"?"未就绪":e==="failed"?"失败":e||"unknown"}function Ce(c){if(!c)return"-";const e=new Date(c);if(Number.isNaN(e.getTime()))return String(c);const T=e.getFullYear(),$=String(e.getMonth()+1).padStart(2,"0"),F=String(e.getDate()).padStart(2,"0"),ue=String(e.getHours()).padStart(2,"0"),pe=String(e.getMinutes()).padStart(2,"0");return`${T}-${$}-${F} ${ue}:${pe}`}function Ge(c){try{return JSON.stringify(c,null,2)}catch{return String(c)}}async function Ae(){await it();const c=o.value;if(c)try{c.scrollTop=c.scrollHeight}catch{}}st(()=>_e.value.length,async()=>{await Ae()});async function xe(){const c=String(m.value||"").trim();if(!c){R.warning("请输入内容");return}const e=c;m.value="",await U(e,{useStream:!0,pageContext:{module:"quote_assistant_workbench",page:"AiAssistantWorkbench"}})}async function Ye(){le.value&&await K(le.value)}async function Je(c){await re(c)}async function Xe(c){try{await lt.confirm("确认删除该会话？此操作仅删除报价助手内存会话记录。","删除会话",{type:"warning",confirmButtonText:"删除",cancelButtonText:"取消"})}catch{return}await k(c)}function Qe(c){const e=c||{};if(e.type==="suggest"&&e.label){m.value=e.label;return}if(e.type==="navigate"&&e.target){R.info(`导航动作预留：${e.target}`);return}R.info("动作已识别（预留）")}return at(async()=>{await ae(),await Ae()}),nt(()=>{try{V?.()}catch{}}),(c,e)=>{const T=j("el-tag"),$=j("el-button"),F=j("el-alert"),ue=j("el-card"),pe=j("el-skeleton"),Ie=j("el-empty"),ve=j("el-option"),Ze=j("el-select"),Ke=j("el-upload"),et=j("el-image"),tt=j("el-input");return d(),w("div",Ct,[v(ue,{shadow:"never",class:"head-card"},{default:h(()=>[i("div",At,[i("div",null,[i("div",xt,[e[5]||(e[5]=i("h2",{class:"page-title"},"报价助手",-1)),v(T,{size:"small",type:"warning",effect:"plain"},{default:h(()=>[...e[4]||(e[4]=[S("功能说明",-1)])]),_:1})]),e[9]||(e[9]=i("div",{class:"guide-box"},[i("div",{class:"guide-title"},"使用提示"),i("div",{class:"guide-text"},[S(" 先上传车辆资料图片（如合格证、身份证、行驶证等），再输入平台报价指令（例如："),i("b",null,"太平洋报价"),S("）。 ")]),i("div",{class:"guide-sub"}," 你也可以继续补充说明（如车型、险种、特殊要求），报价助手会按当前会话材料继续处理。 ")],-1)),i("div",It,[i("span",null,[e[6]||(e[6]=S("当前会话：",-1)),i("b",null,C(He.value),1)]),le.value?(d(),w("span",Lt,[e[7]||(e[7]=S("Session: ",-1)),i("code",null,C(le.value),1)])):z("",!0),E.value?(d(),w("span",Ot,[e[8]||(e[8]=S("订单：",-1)),i("code",null,C(E.value),1)])):z("",!0)])]),i("div",Et,[v($,{size:"small",onClick:De},{default:h(()=>[...e[10]||(e[10]=[S("新会话",-1)])]),_:1}),v($,{size:"small",onClick:Be,loading:he.value},{default:h(()=>[...e[11]||(e[11]=[S("刷新会话",-1)])]),_:1},8,["loading"])])]),be.value?(d(),w("div",Tt,[v(F,{title:be.value,type:"info",closable:!1,"show-icon":""},null,8,["title"])])):z("",!0)]),_:1}),i("div",Ut,[v(ue,{shadow:"never",class:"side-card"},{header:h(()=>[i("div",$t,[e[12]||(e[12]=i("span",null,"会话列表",-1)),v(T,{size:"small",effect:"plain"},{default:h(()=>[S(C(ge.value.length),1)]),_:1})])]),default:h(()=>[i("div",zt,[we.value||he.value?(d(),w("div",Mt,[v(pe,{rows:4,animated:""})])):ge.value.length?(d(),w("div",Nt,[(d(!0),w(ce,null,de(ge.value,n=>(d(),w("div",{key:n.session_id,class:Le(["session-item",{active:n.session_id===le.value}]),onClick:W=>Je(n.session_id)},[i("div",Bt,C(n.title||"新会话"),1),i("div",Dt,C(n.last_message_preview||"暂无回复预览"),1),i("div",Vt,[i("span",null,C(Ce(n.updated_at||n.created_at)),1),i("span",null,"消息 "+C(n.message_count??0),1)]),i("div",{class:"s-actions",onClick:e[0]||(e[0]=Oe(()=>{},["stop"]))},[v($,{size:"small",type:"danger",link:"",onClick:W=>Xe(n.session_id)},{default:h(()=>[...e[13]||(e[13]=[S(" 删除 ",-1)])]),_:1},8,["onClick"])])],10,Ht))),128))])):(d(),w("div",Rt,[v(Ie,{description:"暂无历史会话"})])),i("div",Ft,[i("div",jt,[e[14]||(e[14]=i("div",{class:"upload-title"},"材料上传",-1)),v(Ze,{modelValue:O(q),"onUpdate:modelValue":e[1]||(e[1]=n=>ot(q)?q.value=n:null),size:"small",style:{width:"160px"},onChange:O(J)},{default:h(()=>[v(ve,{label:"稳定模式（后端代传）",value:"stable"}),v(ve,{label:"智能模式（优先直传，失败回退）",value:"smart"}),v(ve,{label:"直传模式（STS+BOS）",value:"direct"})]),_:1},8,["modelValue","onChange"])]),i("div",qt,[(d(!0),w(ce,null,de(O(ee),n=>(d(),w("div",{key:n.key,class:"upload-slot"},[i("div",Pt,[i("span",null,C(n.label),1),n.ocrEnabled?(d(),G(T,{key:0,size:"small",type:"success"},{default:h(()=>[...e[15]||(e[15]=[S("OCR",-1)])]),_:1})):(d(),G(T,{key:1,size:"small",type:"info"},{default:h(()=>[...e[16]||(e[16]=[S("非OCR",-1)])]),_:1})),O(b)(n.key)>0?(d(),w("span",Wt," 上传中 "+C(O(b)(n.key)),1)):O(u)(n.key)>0?(d(),w("span",Gt," 已上传 "+C(O(u)(n.key)),1)):z("",!0)]),v(Ke,{drag:"",action:"","auto-upload":!1,"show-file-list":!0,limit:n.multiple?50:1,"on-change":W=>O(_)(n.key,W),"on-exceed":()=>O(l)(n.key),"file-list":O(D)[n.key],accept:"image/*",class:"uploader"},{default:h(()=>[...e[17]||(e[17]=[i("div",{class:"upload-tip"},[i("div",{class:"upload-strong"},"拖拽/点击上传"),i("div",{class:"upload-weak"},"按槽位上传并生成 storage_key")],-1)])]),_:1},8,["limit","on-change","on-exceed","file-list"]),O(t)(n.key).length?(d(),w("div",Yt,[(d(!0),w(ce,null,de(O(t)(n.key),(W,ye)=>(d(),G(et,{key:W+"_"+ye,src:W,fit:"cover",style:{width:"72px",height:"72px","margin-right":"6px","border-radius":"8px"}},null,8,["src"]))),128))])):z("",!0)]))),128))]),i("div",Jt,[v($,{disabled:O(g)>0,onClick:O(P)},{default:h(()=>[...e[18]||(e[18]=[S("清空材料",-1)])]),_:1},8,["disabled","onClick"]),v($,{type:"primary",disabled:!A.value,onClick:Z},{default:h(()=>[...e[19]||(e[19]=[S(" 绑定到订单并触发OCR ",-1)])]),_:1},8,["disabled"])]),O(g)>0?(d(),G(F,{key:0,type:"info","show-icon":"",closable:!1,title:`正在上传中：${O(g)} 个文件...`},null,8,["title"])):(d(),G(F,{key:1,type:"success","show-icon":"",closable:!1,title:"上传完成后点击「绑定到订单并触发OCR」即可闭环"}))])])]),_:1}),v(ue,{shadow:"never",class:"chat-card"},{header:h(()=>[i("div",Xt,[e[21]||(e[21]=i("span",null,"聊天区",-1)),i("div",null,[v($,{size:"small",text:"",onClick:Ye,loading:Se.value},{default:h(()=>[...e[20]||(e[20]=[S("刷新消息",-1)])]),_:1},8,["loading"])])])]),default:h(()=>[i("div",{class:"chat-body",ref_key:"chatBodyRef",ref:o},[we.value||Se.value?(d(),w("div",Qt,[v(pe,{rows:6,animated:""})])):_e.value.length?(d(),w("div",Kt,[(d(!0),w(ce,null,de(_e.value,n=>(d(),w("div",{key:n.id,class:Le(["msg-item",[`msg-${n.role||"system"}`]])},[i("div",es,C(Ve(n.role)),1),i("div",ts,[i("div",ss,[i("span",as,C(Fe(n.role)),1),i("span",ns,C(Ce(n.created_at)),1),n.metadata?.status?(d(),G(T,{key:0,size:"small",type:je(n.metadata?.status),effect:"plain"},{default:h(()=>[S(C(n.metadata.status),1)]),_:2},1032,["type"])):z("",!0),n.metadata?.intent?(d(),G(T,{key:1,size:"small",type:"info",effect:"plain"},{default:h(()=>[S(C(n.metadata.intent),1)]),_:2},1024)):z("",!0),n.metadata?.trace_id?(d(),G(T,{key:2,size:"small",type:"warning",effect:"plain"},{default:h(()=>[S(" trace: "+C(String(n.metadata.trace_id).slice(0,8)),1)]),_:2},1024)):z("",!0),n.metadata?.data?.result_status?(d(),G(T,{key:3,size:"small",type:qe(n.metadata?.data?.result_status),effect:"plain"},{default:h(()=>[S(C(We(n.metadata?.data?.result_status)),1)]),_:2},1032,["type"])):z("",!0)]),i("div",is,[i("div",os,C(n.content),1),n.metadata?.data?.message?(d(),w("div",rs,[v(F,{title:String(n.metadata.data.message),type:Pe(n.metadata.data.result_status),closable:!1,"show-icon":""},null,8,["title","type"])])):z("",!0),n.metadata?.data?.payload?(d(),w("div",ls,[i("pre",us,C(Ge(n.metadata.data.payload)),1)])):z("",!0),Array.isArray(n.metadata?.actions)&&n.metadata.actions.length?(d(),w("div",cs,[e[22]||(e[22]=i("div",{class:"action-title"},"建议动作",-1)),i("div",ds,[(d(!0),w(ce,null,de(n.metadata.actions,(W,ye)=>(d(),G($,{key:`${n.id}_${ye}`,size:"small",onClick:vs=>Qe(W)},{default:h(()=>[S(C(W.label||W.type),1)]),_:2},1032,["onClick"]))),128))])])):z("",!0),n.metadata?.error?(d(),w("div",fs,[v(F,{title:n.metadata.error.message||"处理失败",type:"error",closable:!1,"show-icon":""},null,8,["title"])])):z("",!0)])])],2))),128))])):(d(),w("div",Zt,[v(Ie,{description:"还没有消息，先发一句试试（例如：查订单 / 太平洋报价）"})]))],512),i("div",ms,[v(tt,{modelValue:m.value,"onUpdate:modelValue":e[2]||(e[2]=n=>m.value=n),type:"textarea",rows:3,resize:"none",placeholder:"输入示例：查订单 10086 / 查看当前材料状态 / OCR任务状态 / 太平洋报价",onKeydown:rt(Oe(xe,["exact","prevent"]),["enter"])},null,8,["modelValue","onKeydown"]),i("div",ps,[e[25]||(e[25]=i("div",{class:"input-tip"},[i("span",null,"Shift + Enter 换行；Enter 发送")],-1)),i("div",gs,[v($,{onClick:e[3]||(e[3]=n=>m.value=""),disabled:ke.value},{default:h(()=>[...e[23]||(e[23]=[S("清空",-1)])]),_:1},8,["disabled"]),v($,{type:"primary",loading:ke.value,onClick:xe},{default:h(()=>[...e[24]||(e[24]=[S("发送",-1)])]),_:1},8,["loading"])])])])]),_:1})])])}}},Es=dt(_s,[["__scopeId","data-v-d516aa11"]]);export{Es as default};
