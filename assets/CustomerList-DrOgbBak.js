import{c as V,r as v,q as Me,x as $,z as u,P as l,G as k,J as ne,H as a,ay as _,I as Te,aI as qe,y as m,C as Ke,L as i,u as Q,M as B,ap as T,O as W,ac as Ge,D as X}from"./vendor-vue-CZOMRj4y.js";import{E as y,h as Oe,v as Pe,w as je}from"./vendor-element-plus-nv6hIq5t.js";import{l as He,u as Je,c as Qe,d as We}from"./customerChannel-6fIO32tk.js";import{_ as Xe,u as Ye}from"./index-BffKbIYS.js";import"./vendor-lodash-rvV0CIkQ.js";import"./vendor-DWCz07M-.js";import"./vendor-dates-DVKSwKij.js";import"./http-DGyH82Tn.js";import"./vendor-axios-C0Zqfgkc.js";import"./vendor-vue-router-o2a2TmKO.js";import"./vendor-pinia--LqfdQ-h.js";const Ze={class:"page"},et={class:"page-header"},tt={class:"header-actions"},lt={class:"toolbar-row"},at={class:"toolbar-content"},ot={class:"toolbar-fields"},nt={class:"toolbar-actions"},st={class:"table-scroll"},rt={class:"code-cell"},ut={class:"code-text"},it={class:"pagination-bar"},dt={class:"contacts-wrap"},ct={class:"contacts-toolbar"},mt={key:0,class:"contacts-empty"},pt={key:1,class:"contacts-list"},vt={class:"dialog-footer"},ft={class:"cd"},_t={class:"cd-icon-wrap"},gt={class:"cd-body"},yt={class:"cd-title"},bt={class:"cd-code"},kt={class:"cd-footer"},Ct={__name:"CustomerList",setup(wt){const se=Ye(),P=V(()=>!0);V(()=>!0),V(()=>!0);const Y=V(()=>String(se.roleName||"").trim().toLowerCase()),A=V(()=>Y.value!==ROLE.FINANCE),j=V(()=>Y.value===ROLE.SUPER_ADMIN),z=v(!1),g=v(!1),C=v(1),H=v(20),Z=v(0),ee=v([]);let q=0;const p=v({customer_code:"",customer_name:"",market:"",region:"",created_by:""});function te(t){return!!t?.is_deleted||!!t?.deleted_at}function re(t){const e=String(t||"").trim().toLowerCase();return e==="mobile"?"手机号":e==="tel"?"座机":e||""}function ue(t){return!Array.isArray(t)||!t.length?"":t.map(e=>{if(!e)return"";const r=re(e.type),n=e.value?String(e.value):"";return r?`${r}:${n}`:n}).filter(Boolean).join("；")}function L(t){const e=String(t??"").trim();return e||""}async function w(){const t=++q;g.value=!0;try{const e={page:C.value,page_size:H.value};j.value&&z.value&&(e.include_deleted=1);const r=L(p.value.customer_code),n=L(p.value.customer_name),c=L(p.value.market),d=L(p.value.region),x=L(p.value.created_by);r&&(e.customer_code=r),n&&(e.customer_name=n),c&&(e.market=c),d&&(e.region=d),x&&(e.created_by=x);const I=await He(e);if(t!==q)return;const f=I?.data||{};Z.value=Number(f.total||0),ee.value=Array.isArray(f.items)?f.items:[]}catch(e){if(t!==q)return;console.error(e),y.error(e?.response?.data?.detail||e?.message||"客户列表加载失败")}finally{t===q&&(g.value=!1)}}function ie(){w()}function b(){C.value=1,w()}function de(){p.value={customer_code:"",customer_name:"",market:"",region:"",created_by:""},C.value=1,w()}const le=V(()=>ee.value||[]);function ce(t){C.value=t,w()}function me(t){H.value=t,C.value=1,w()}function pe(){j.value&&(z.value=!z.value,C.value=1,w())}const U=v(!1),J=v(!1),R=v(null),E=v("create"),K=v(null),ve=V(()=>E.value==="edit"?"编辑客户":"新增客户");function fe(){return{type:"mobile",value:""}}const s=v({customer_code:"",customer_name:"",market:"",region:"",contacts:[]}),_e=/^1[3-9]\d{9}$/,ge=/^(0\d{2,3}-?)?\d{7,8}(-\d{1,6})?$/,ye=/^(400|800)\d{7}$/;function G(t){return String(t??"").replace(/\s+/g,"").replace(/[^0-9\-]/g,"")}function be(t){const e=String(t?.type||"").trim().toLowerCase(),r=G(t?.value||"");if(!r)return"联系方式不能为空（不需要可删除该行）";if(e==="mobile"){const n=r.replace(/-/g,"");return _e.test(n)?"":"手机号格式不正确（需为 11 位大陆手机号）"}if(e==="tel"){const n=r.replace(/-/g,"");return ye.test(n)||ge.test(r)?"":"座机格式不正确（示例：010-88888888 / 0571-8888888 / 010-88888888-123 / 400xxxxxxx）"}return"联系方式类型仅支持：手机号/座机"}function ke(){const t=Array.isArray(s.value.contacts)?s.value.contacts:[],e=new Set,r=[];for(const n of t){const c=String(n?.type||"").trim().toLowerCase()||"mobile",d=G(n?.value||"");if(!d)continue;if(c==="mobile"){const I=d.replace(/-/g,""),f=`${c}:${I}`;if(e.has(f))continue;e.add(f),r.push({type:c,value:I});continue}const x=`${c}:${d}`;e.has(x)||(e.add(x),r.push({type:c,value:d}))}return r}function Ce(t){return(Array.isArray(t)?t:[]).map(r=>({type:String(r?.type||"mobile").trim().toLowerCase()==="tel"?"tel":"mobile",value:G(r?.value||"")}))}async function O(){if(!R.value)return!0;try{return await R.value.validateField("contacts"),!0}catch{return!1}}const we={customer_code:[{required:!0,message:"客户代码必填",trigger:"blur"}],customer_name:[{required:!0,message:"客户名称必填",trigger:"blur"}],contacts:[{trigger:["change","blur"],validator:(t,e,r)=>{const n=Array.isArray(s.value.contacts)?s.value.contacts:[];for(let c=0;c<n.length;c++){const d=be(n[c]);if(d)return r(new Error(`第 ${c+1} 条联系方式：${d}`))}r()}}]};function Ve(){if(!A.value){y.warning("财务账号无新增权限");return}E.value="create",K.value=null,s.value={customer_code:"",customer_name:"",market:"",region:"",contacts:[]},U.value=!0}function ze(t){if(!P.value){y.warning("仅经理/超级账号/市场账号可编辑");return}t?.id&&(E.value="edit",K.value=t.id,s.value={customer_code:String(t.customer_code||""),customer_name:String(t.customer_name||t.group_name||""),market:String(t.market||""),region:String(t.region||""),contacts:Ce(t.contacts)},U.value=!0)}function Se(){Array.isArray(s.value.contacts)||(s.value.contacts=[]),s.value.contacts.push(fe()),X(()=>O())}function xe(t){Array.isArray(s.value.contacts)&&(s.value.contacts.splice(t,1),X(()=>O()))}function De(t){const r=(s.value.contacts||[])[t];r&&(r.type=String(r.type||"mobile").trim().toLowerCase(),X(()=>O()))}function $e(t,e){const n=(s.value.contacts||[])[t];n&&(n.value=G(e))}async function Ae(){if(E.value==="create"){if(!A.value){y.warning("财务账号无新增权限");return}}else{if(!P.value){y.warning("仅经理/超级账号/市场账号可编辑");return}if(!K.value)return}if(!R.value)return;try{await R.value.validate()}catch{return}const t=ke();J.value=!0;try{const e={customer_code:s.value.customer_code,customer_name:s.value.customer_name,market:L(s.value.market)||null,region:s.value.region,contacts:t};E.value==="edit"?(await Je(K.value,e),y.success("编辑客户成功")):(await Qe(e),y.success("新增客户成功")),U.value=!1,C.value=1,await w()}catch(e){console.error(e),y.error(e?.response?.data?.detail||e?.message||(E.value==="edit"?"编辑客户失败":"新增客户失败"))}finally{J.value=!1}}const h=v(!1),F=v(!1),S=v(null),Le=V(()=>{const t=S.value?.customer_code?String(S.value.customer_code):"",e=S.value?.customer_name?String(S.value.customer_name):"";return t&&e?`${t} - ${e}`:t||e||"-"});function Ue(t){if(!A.value){y.warning("财务账号无删除权限");return}t?.id&&(S.value=t,h.value=!0)}function Ee(){S.value=null,F.value=!1}async function Ie(){if(!A.value){y.warning("财务账号无删除权限");return}if(S.value?.id){F.value=!0;try{await We(S.value.id),y.success("删除成功"),h.value=!1,le.value.length<=1&&C.value>1&&(C.value-=1),await w()}catch(t){console.error(t),y.error(t?.response?.data?.detail||t?.message||"删除失败")}finally{F.value=!1}}}return Me(()=>w()),(t,e)=>{const r=_("el-icon"),n=_("el-button"),c=_("el-tooltip"),d=_("el-input"),x=_("el-card"),I=_("el-tag"),f=_("el-table-column"),Ne=_("el-table"),Be=_("el-pagination"),M=_("el-form-item"),ae=_("el-option"),Re=_("el-select"),he=_("el-form"),oe=_("el-dialog"),Fe=qe("loading");return m(),$("div",Ze,[u("div",et,[e[16]||(e[16]=u("h2",null,"客户管理",-1)),u("div",tt,[j.value?(m(),k(c,{key:0,content:z.value?"点击隐藏已删除":"点击显示已删除",placement:"top"},{default:a(()=>[l(n,{size:"small",class:Ke(["toggle-btn",{"toggle-btn--active":z.value}]),type:z.value?"info":"default",plain:!0,loading:g.value,onClick:pe},{default:a(()=>[l(r,{class:"btn-ico"},{default:a(()=>[z.value?(m(),k(Q(Oe),{key:0})):(m(),k(Q(Pe),{key:1}))]),_:1}),i(" "+B(z.value?"隐藏已删除":"显示已删除"),1)]),_:1},8,["class","type","loading"])]),_:1},8,["content"])):ne("",!0),A.value?(m(),k(n,{key:2,type:"primary",size:"small",onClick:Ve},{default:a(()=>[...e[15]||(e[15]=[i("新增客户",-1)])]),_:1})):(m(),k(c,{key:1,content:"财务账号无新增权限",placement:"top"},{default:a(()=>[u("span",null,[l(n,{type:"primary",size:"small",disabled:""},{default:a(()=>[...e[14]||(e[14]=[i("新增客户",-1)])]),_:1})])]),_:1}))])]),l(x,{shadow:"never",class:"toolbar-card","body-style":{padding:"12px 14px"}},{default:a(()=>[u("div",lt,[e[20]||(e[20]=u("div",{class:"toolbar-label"},"搜索条件",-1)),u("div",at,[u("div",ot,[l(d,{modelValue:p.value.customer_code,"onUpdate:modelValue":e[0]||(e[0]=o=>p.value.customer_code=o),size:"small",clearable:"",placeholder:"客户代码（模糊）",class:"toolbar-input",disabled:g.value,onKeyup:T(b,["enter"]),onClear:b},null,8,["modelValue","disabled"]),l(d,{modelValue:p.value.customer_name,"onUpdate:modelValue":e[1]||(e[1]=o=>p.value.customer_name=o),size:"small",clearable:"",placeholder:"客户名称（模糊）",class:"toolbar-input",disabled:g.value,onKeyup:T(b,["enter"]),onClear:b},null,8,["modelValue","disabled"]),l(d,{modelValue:p.value.market,"onUpdate:modelValue":e[2]||(e[2]=o=>p.value.market=o),size:"small",clearable:"",placeholder:"市场（模糊）",class:"toolbar-input",disabled:g.value,onKeyup:T(b,["enter"]),onClear:b},null,8,["modelValue","disabled"]),l(d,{modelValue:p.value.region,"onUpdate:modelValue":e[3]||(e[3]=o=>p.value.region=o),size:"small",clearable:"",placeholder:"归属地（模糊）",class:"toolbar-input",disabled:g.value,onKeyup:T(b,["enter"]),onClear:b},null,8,["modelValue","disabled"]),l(d,{modelValue:p.value.created_by,"onUpdate:modelValue":e[4]||(e[4]=o=>p.value.created_by=o),size:"small",clearable:"",placeholder:"创建人（模糊）",class:"toolbar-input",disabled:g.value,onKeyup:T(b,["enter"]),onClear:b},null,8,["modelValue","disabled"])]),u("div",nt,[l(n,{size:"small",disabled:g.value,onClick:de},{default:a(()=>[...e[17]||(e[17]=[i("重置",-1)])]),_:1},8,["disabled"]),l(n,{type:"primary",size:"small",loading:g.value,onClick:b},{default:a(()=>[...e[18]||(e[18]=[i("搜索",-1)])]),_:1},8,["loading"]),l(n,{size:"small",onClick:ie,loading:g.value},{default:a(()=>[...e[19]||(e[19]=[i("刷新",-1)])]),_:1},8,["loading"])])])])]),_:1}),u("div",st,[Te((m(),k(Ne,{data:le.value,border:"",stripe:"",class:"main-table"},{default:a(()=>[l(f,{prop:"customer_code",label:"客户代码","min-width":"170","show-overflow-tooltip":""},{default:a(({row:o})=>[u("div",rt,[u("span",ut,B(o.customer_code||"-"),1),te(o)?(m(),k(I,{key:0,size:"small",type:"info",class:"deleted-tag"},{default:a(()=>[...e[21]||(e[21]=[i("已删除",-1)])]),_:1})):ne("",!0)])]),_:1}),l(f,{prop:"customer_name",label:"客户名称","min-width":"180","show-overflow-tooltip":""},{default:a(({row:o})=>[i(B(o.customer_name||o.group_name||"-"),1)]),_:1}),l(f,{prop:"market",label:"市场","min-width":"140","show-overflow-tooltip":""},{default:a(({row:o})=>[i(B(o.market||"-"),1)]),_:1}),l(f,{prop:"region",label:"归属地","min-width":"140","show-overflow-tooltip":""}),l(f,{label:"联系方式","min-width":"220","show-overflow-tooltip":""},{default:a(({row:o})=>[i(B(ue(o.contacts)),1)]),_:1}),l(f,{prop:"created_by_name",label:"创建人",width:"120","show-overflow-tooltip":""}),l(f,{prop:"created_at",label:"创建时间",width:"180","show-overflow-tooltip":""}),l(f,{label:"操作",width:"160",fixed:"right","class-name":"col-actions"},{default:a(({row:o})=>[te(o)?(m(),$(W,{key:0},[l(c,{content:"该客户已删除",placement:"top"},{default:a(()=>[u("span",null,[l(n,{type:"primary",size:"small",link:"",disabled:""},{default:a(()=>[...e[22]||(e[22]=[i("编辑",-1)])]),_:1})])]),_:1}),l(c,{content:"该客户已删除",placement:"top"},{default:a(()=>[u("span",null,[l(n,{type:"danger",size:"small",link:"",disabled:""},{default:a(()=>[...e[23]||(e[23]=[i("删除",-1)])]),_:1})])]),_:1})],64)):(m(),$(W,{key:1},[P.value?(m(),k(n,{key:1,type:"primary",size:"small",link:"",onClick:N=>ze(o)},{default:a(()=>[...e[25]||(e[25]=[i("编辑",-1)])]),_:1},8,["onClick"])):(m(),k(c,{key:0,content:"仅经理/超级账号/市场账号可编辑",placement:"top"},{default:a(()=>[u("span",null,[l(n,{type:"primary",size:"small",link:"",disabled:""},{default:a(()=>[...e[24]||(e[24]=[i("编辑",-1)])]),_:1})])]),_:1})),A.value?(m(),k(n,{key:3,type:"danger",size:"small",link:"",onClick:N=>Ue(o)},{default:a(()=>[...e[27]||(e[27]=[i("删除",-1)])]),_:1},8,["onClick"])):(m(),k(c,{key:2,content:"财务账号无删除权限",placement:"top"},{default:a(()=>[u("span",null,[l(n,{type:"danger",size:"small",link:"",disabled:""},{default:a(()=>[...e[26]||(e[26]=[i("删除",-1)])]),_:1})])]),_:1}))],64))]),_:1})]),_:1},8,["data"])),[[Fe,g.value]])]),u("div",it,[l(Be,{background:"",layout:"prev, pager, next, jumper, sizes, total","current-page":C.value,"page-size":H.value,total:Z.value,"page-sizes":[10,20,50,100],onCurrentChange:ce,onSizeChange:me},null,8,["current-page","page-size","total"])]),l(oe,{modelValue:U.value,"onUpdate:modelValue":e[11]||(e[11]=o=>U.value=o),title:ve.value,width:"520px","destroy-on-close":""},{footer:a(()=>[u("span",vt,[l(n,{onClick:e[10]||(e[10]=o=>U.value=!1)},{default:a(()=>[...e[31]||(e[31]=[i("取消",-1)])]),_:1}),l(n,{type:"primary",loading:J.value,onClick:Ae},{default:a(()=>[...e[32]||(e[32]=[i("保存",-1)])]),_:1},8,["loading"])])]),default:a(()=>[l(he,{model:s.value,rules:we,ref_key:"formRef",ref:R,"label-width":"90px"},{default:a(()=>[l(M,{label:"客户代码",prop:"customer_code"},{default:a(()=>[l(d,{modelValue:s.value.customer_code,"onUpdate:modelValue":e[5]||(e[5]=o=>s.value.customer_code=o),clearable:""},null,8,["modelValue"])]),_:1}),l(M,{label:"客户名称",prop:"customer_name"},{default:a(()=>[l(d,{modelValue:s.value.customer_name,"onUpdate:modelValue":e[6]||(e[6]=o=>s.value.customer_name=o),clearable:""},null,8,["modelValue"])]),_:1}),l(M,{label:"市场",prop:"market"},{default:a(()=>[l(d,{modelValue:s.value.market,"onUpdate:modelValue":e[7]||(e[7]=o=>s.value.market=o),clearable:""},null,8,["modelValue"])]),_:1}),l(M,{label:"归属地",prop:"region"},{default:a(()=>[l(d,{modelValue:s.value.region,"onUpdate:modelValue":e[8]||(e[8]=o=>s.value.region=o),clearable:""},null,8,["modelValue"])]),_:1}),l(M,{label:"联系方式",prop:"contacts"},{default:a(()=>[u("div",dt,[u("div",ct,[l(n,{size:"small",onClick:Se},{default:a(()=>[...e[28]||(e[28]=[i("添加联系方式",-1)])]),_:1}),e[29]||(e[29]=u("div",{class:"contacts-hint"},"仅支持：手机号 / 座机（可多条）",-1))]),s.value.contacts.length?(m(),$("div",pt,[(m(!0),$(W,null,Ge(s.value.contacts,(o,N)=>(m(),$("div",{key:N,class:"contacts-row"},[l(Re,{modelValue:o.type,"onUpdate:modelValue":D=>o.type=D,class:"contacts-type",placeholder:"类型",onChange:D=>De(N)},{default:a(()=>[l(ae,{label:"手机号",value:"mobile"}),l(ae,{label:"座机",value:"tel"})]),_:1},8,["modelValue","onUpdate:modelValue","onChange"]),l(d,{modelValue:o.value,"onUpdate:modelValue":D=>o.value=D,class:"contacts-value",clearable:"",placeholder:"手机号：11位；座机：010-88888888 / 400xxxxxxx",onInput:D=>$e(N,D),onBlur:e[9]||(e[9]=()=>O())},null,8,["modelValue","onUpdate:modelValue","onInput"]),l(n,{type:"danger",size:"small",link:"",class:"contacts-remove",onClick:D=>xe(N)},{default:a(()=>[...e[30]||(e[30]=[i(" 删除 ",-1)])]),_:1},8,["onClick"])]))),128))])):(m(),$("div",mt,"未添加联系方式"))])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"]),l(oe,{modelValue:h.value,"onUpdate:modelValue":e[13]||(e[13]=o=>h.value=o),width:"440px","destroy-on-close":"","append-to-body":"","show-close":!1,class:"confirm-dialog",onClosed:Ee},{footer:a(()=>[u("div",kt,[l(n,{onClick:e[12]||(e[12]=o=>h.value=!1),disabled:F.value},{default:a(()=>[...e[36]||(e[36]=[i("取消",-1)])]),_:1},8,["disabled"]),l(n,{type:"danger",loading:F.value,onClick:Ie},{default:a(()=>[...e[37]||(e[37]=[i("确认删除",-1)])]),_:1},8,["loading"])])]),default:a(()=>[u("div",ft,[u("div",_t,[l(r,{class:"cd-icon"},{default:a(()=>[l(Q(je))]),_:1})]),u("div",gt,[u("div",yt,[e[33]||(e[33]=i("确认删除客户：",-1)),u("span",bt,B(Le.value),1),e[34]||(e[34]=i("？",-1))]),e[35]||(e[35]=u("div",{class:"cd-desc"},"删除后会移入“已删除”，订单详情页下拉选项将不再展示。",-1))])])]),_:1},8,["modelValue"])])}}},Nt=Xe(Ct,[["__scopeId","data-v-4ea6545a"]]);export{Nt as default};
