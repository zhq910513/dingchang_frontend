import{r as C,c as ct,o as dt,q as ut,x as v,P as p,z as e,H as y,ay as E,D as ft,y as _,J as R,L as w,M as S,u as m,O as tt,ac as et,C as nt,X as at,G as Q,ap as mt}from"./vendor-vue-fFWwKrgY.js";import{h as Z}from"./http-CBIyYC5i.js";import{E as U,b as F,d as _t}from"./vendor-element-plus-CtVxZ4Oy.js";import{_ as gt}from"./index-1e9zDAa1.js";import"./vendor-axios-C0Zqfgkc.js";import"./vendor-lodash-rvV0CIkQ.js";import"./vendor-DWCz07M-.js";import"./vendor-dates-DVKSwKij.js";import"./vendor-vue-router-CVyACjsp.js";import"./vendor-pinia-CMXa-Za0.js";function pt(s){const o={};for(const[l,n]of Object.entries(s||{}))n!==void 0&&(o[l]=n);return o}function ot(s){const o=String(s||"").trim();if(!o)throw new Error("aiAssistant api: invalid session_id");return o}function yt(){return Z.get("/ai-assistant/sessions")}function vt(s){return Z.get(`/ai-assistant/sessions/${encodeURIComponent(ot(s))}/history`)}function wt(s){return Z.delete(`/ai-assistant/sessions/${encodeURIComponent(ot(s))}`)}function ht(s={}){return Z.post("/ai-assistant/chat",pt({session_id:s.session_id?String(s.session_id).trim():void 0,message:String(s.message||"").trim(),history:Array.isArray(s.history)?s.history:[],context:s.context&&typeof s.context=="object"?s.context:{},stream:!1}))}async function St({session_id:s,message:o,history:l=[],context:n={},onEvent:g,signal:u}={}){const a=sessionStorage.getItem("sessionToken")||"",k=await fetch("/api/ai-assistant/chat/stream",{method:"POST",headers:{"Content-Type":"application/json",...a?{"X-Session-Token":a}:{}},body:JSON.stringify({session_id:s?String(s).trim():void 0,message:String(o||"").trim(),history:Array.isArray(l)?l:[],context:n&&typeof n=="object"?n:{},stream:!0}),signal:u});if(!k.ok||!k.body){let T=`HTTP ${k.status}`;try{const $=await k.text();$&&(T=$)}catch{}throw new Error(T)}const x=k.body.getReader(),A=new TextDecoder("utf-8");let h="";for(;;){const{done:T,value:$}=await x.read();if(T)break;h+=A.decode($,{stream:!0});let L;for(;(L=h.indexOf(`

`))>=0;){const V=h.slice(0,L);h=h.slice(L+2);const W=V.split(`
`);for(const J of W){const j=String(J||"").trim();if(!j.startsWith("data:"))continue;const f=j.slice(5).trim();if(f)try{const b=JSON.parse(f);typeof g=="function"&&g(b)}catch{typeof g=="function"&&g({type:"raw",raw:f})}}}}}function kt(s){return String(s||"").trim()}function bt(s){const o=kt(s);if(!o)return{kind:"empty"};if(o==="新一单"||o.toLowerCase()==="/new")return{kind:"action",action:"new_session",text:o};const l=o.match(/^(.+?)\s*报价$/);if(l){const n=String(l[1]||"").trim();if(n)return{kind:"quote",action:"quote",platform_hint:n,text:o}}return{kind:"text",text:o}}function it(s){return/[\u4e00-\u9fa5]/.test(String(s||""))}function X(s,o="操作失败，请稍后重试"){const l=s?.response?.data?.detail,n=s?.response?.data?.message||s?.message||"";if(typeof l=="string"&&l&&it(l))return l;if(typeof n=="string"&&n&&it(n))return n;const g=s?.response?.status;return g===401?"登录状态已失效，请重新登录":g===403?"无权限执行该操作":g>=500?"服务器异常，请稍后重试":o}function xt(s){const o=s?.data?.data??s?.data??{};return(Array.isArray(o?.items)?o.items:[]).map(n=>({session_id:n.session_id,title:n.title||"新会话",created_at:n.created_at||"",updated_at:n.updated_at||"",last_message_preview:n.last_message_preview||"",message_count:n.message_count??0}))}function Ct(s){const o=s?.data?.data??s?.data??{};return(Array.isArray(o?.items)?o.items:[]).map((n,g)=>({id:`${n.created_at||"t"}_${g}`,role:n.role||"assistant",content:n.content||"",created_at:n.created_at||"",metadata:n.metadata||{}}))}function At(){const s=C(!1),o=C(!1),l=C(!1),n=C(!1),g=C([]),u=C(""),a=C([]),k=C("");let x=null;async function A(){o.value=!0;try{const f=await yt();g.value=xt(f)}catch(f){F.error({title:"会话列表加载失败",message:X(f,"加载会话列表失败"),duration:4e3})}finally{o.value=!1}}async function h(f){const b=String(f||u.value||"").trim();if(!b){a.value=[];return}l.value=!0;try{const D=await vt(b);u.value=b,a.value=Ct(D)}catch(D){F.error({title:"历史消息加载失败",message:X(D,"加载历史消息失败"),duration:4e3}),a.value=[]}finally{l.value=!1}}async function T(){s.value=!0;try{await A(),g.value.length>0?await h(g.value[0].session_id):(u.value="",a.value=[{id:`local_${Date.now()}`,role:"system",content:"报价助手已就绪。你可以直接问：查订单 / 查财务 / 某字段是什么意思 / 平台A 报价",created_at:new Date().toISOString(),metadata:{}}])}finally{s.value=!1}}function $(f){a.value.push({id:`local_${Date.now()}_${Math.random().toString(36).slice(2,8)}`,...f})}async function L(f){if(f){if(n.value&&x)try{x.abort()}catch{}await h(f)}}async function V(){u.value="",a.value=[{id:`local_${Date.now()}`,role:"system",content:"已新建会话（本地态）。发送第一条消息后后端会生成 session_id。",created_at:new Date().toISOString(),metadata:{}}],U.success("已新建会话")}async function W(f){try{await wt(f),String(u.value)===String(f)&&(u.value="",a.value=[]),await A(),U.success("会话已删除")}catch(b){F.error({title:"删除失败",message:X(b,"删除会话失败"),duration:4e3})}}async function J(f,{useStream:b=!0,pageContext:D={}}={}){const M=bt(f);if(M.kind==="empty"){U.warning("请输入内容");return}if(M.kind==="action"&&M.action==="new_session"){await V();return}const q=M.text;$({role:"user",content:q,created_at:new Date().toISOString(),metadata:{}});const O=`assistant_pending_${Date.now()}`;$({id:O,role:"assistant",content:"",created_at:new Date().toISOString(),metadata:{status:"sending"}}),n.value=!0,k.value=M.kind==="quote"?"已识别报价指令，正在处理…":"正在处理…";try{if(!b){const d=await ht({session_id:u.value||void 0,message:q,context:D}),r=d?.data?.data??d?.data??{},H=a.value.findIndex(c=>c.id===O);H>=0&&(a.value[H]={...a.value[H],content:r.reply||"",metadata:{...a.value[H].metadata,status:r.ok?"success":"error",trace_id:r.trace_id,intent:r.intent,confidence:r.confidence,actions:r.actions||[],error:r.error||null}}),r.session_id&&(u.value=r.session_id),r.ok||F.warning({title:"报价助手返回异常",message:r?.error?.message||"请求处理失败",duration:4e3}),await A(),u.value&&await h(u.value);return}const N=new AbortController;x=N;let I={trace_id:"",intent:"",confidence:0,actions:[]};await St({session_id:u.value||void 0,message:q,context:D,signal:N.signal,onEvent:d=>{const r=a.value.findIndex(H=>H.id===O);if(!(r<0)){if(d.type==="meta"){d.session_id&&(u.value=d.session_id),a.value[r].metadata={...a.value[r].metadata||{},trace_id:d.trace_id||"",model:d.model||"",status:"streaming"};return}if(d.type==="delta"){a.value[r].content=(a.value[r].content||"")+String(d.content||""),a.value[r].metadata={...a.value[r].metadata||{},status:"streaming"};return}if(d.type==="done"){I={trace_id:d.trace_id||"",intent:d.intent||"",confidence:d.confidence||0,actions:Array.isArray(d.actions)?d.actions:[]},a.value[r].metadata={...a.value[r].metadata||{},...I,status:"success",cost_ms:d.cost_ms||0};return}d.type==="error"&&(a.value[r].content=d.message||"报价助手流式处理失败",a.value[r].metadata={...a.value[r].metadata||{},status:"error",error_code:d.code||"INTERNAL_ERROR"})}}}),await A(),u.value&&await h(u.value)}catch(N){const I=a.value.findIndex(d=>d.id===O);I>=0&&(a.value[I]={...a.value[I],content:X(N,"发送失败，请稍后重试"),metadata:{...a.value[I].metadata||{},status:"error"}}),F.error({title:"发送失败",message:X(N,"发送失败，请稍后重试"),duration:4e3})}finally{k.value="",n.value=!1,x=null}}const j=ct(()=>g.value.find(b=>b.session_id===u.value)?.title||(u.value?"当前会话":"新会话"));return{loadingInit:s,loadingSessions:o,loadingHistory:l,sending:n,sessions:g,currentSessionId:u,currentSessionTitle:j,messages:a,processHint:k,ensureInit:T,refreshSessions:A,loadHistory:h,switchSession:L,createNewSessionLocal:V,removeSession:W,sendMessage:J}}const Tt={class:"ai-page"},$t={class:"head-row"},It={class:"title-wrap"},zt={class:"head-meta"},Dt={key:0},Nt={class:"head-actions"},Ht={key:0,class:"top-hint"},Lt={class:"main-grid"},Mt={class:"card-header"},Ot={class:"side-body"},Bt={key:0,class:"empty-wrap"},Et={key:1,class:"empty-wrap"},Rt={key:2,class:"session-list"},Vt=["onClick"],jt={class:"s-title"},qt={class:"s-preview"},Ut={class:"s-foot"},Wt={class:"card-header"},Jt={key:0,class:"empty-wrap"},Kt={key:1,class:"empty-wrap"},Pt={key:2,class:"msg-list"},Ft={class:"msg-avatar"},Xt={class:"msg-content"},Gt={class:"msg-head"},Yt={class:"msg-role"},Qt={class:"msg-time"},Zt={class:"msg-bubble"},te={class:"msg-text"},ee={key:0,class:"action-wrap"},se={class:"action-list"},ne={key:1,class:"err-wrap"},ae={class:"chat-input-wrap"},ie={class:"input-actions"},oe={class:"btns"},re={__name:"AiAssistantWorkbench",setup(s){const o=C(null),l=C(""),{loadingInit:n,loadingSessions:g,loadingHistory:u,sending:a,sessions:k,currentSessionId:x,currentSessionTitle:A,messages:h,processHint:T,ensureInit:$,refreshSessions:L,loadHistory:V,switchSession:W,createNewSessionLocal:J,removeSession:j,sendMessage:f}=At();function b(c){const t=String(c||"").toLowerCase();return t==="user"?"我":t==="assistant"?"报":"系"}function D(c){const t=String(c||"").toLowerCase();return t==="user"?"用户":t==="assistant"?"报价助手":"系统"}function M(c){const t=String(c||"").toLowerCase();return t==="success"?"success":t==="streaming"||t==="sending"?"warning":t==="error"?"danger":"info"}function q(c){if(!c)return"-";const t=new Date(c);if(Number.isNaN(t.getTime()))return String(c);const B=t.getFullYear(),z=String(t.getMonth()+1).padStart(2,"0"),G=String(t.getDate()).padStart(2,"0"),K=String(t.getHours()).padStart(2,"0"),Y=String(t.getMinutes()).padStart(2,"0");return`${B}-${z}-${G} ${K}:${Y}`}async function O(){await ft();const c=o.value;c&&(c.scrollTop=c.scrollHeight)}dt(()=>h.value.length,async()=>{await O()});async function N(){const c=String(l.value||"").trim();if(!c){U.warning("请输入内容");return}const t=c;l.value="",await f(t,{useStream:!0,pageContext:{module:"quote_assistant_workbench",page:"AiAssistantWorkbench"}})}async function I(){x.value&&await V(x.value)}async function d(c){await W(c)}async function r(c){try{await _t.confirm("确认删除该会话？此操作仅删除报价助手内存会话记录。","删除会话",{type:"warning",confirmButtonText:"删除",cancelButtonText:"取消"})}catch{return}await j(c)}function H(c){const t=c||{};if(t.type==="suggest"&&t.label){l.value=t.label;return}if(t.type==="navigate"&&t.target){U.info(`导航动作预留：${t.target}`);return}U.info("动作已识别（预留）")}return ut(async()=>{await $(),await O()}),(c,t)=>{const B=E("el-tag"),z=E("el-button"),G=E("el-alert"),K=E("el-card"),Y=E("el-skeleton"),st=E("el-empty"),rt=E("el-input");return _(),v("div",Tt,[p(K,{shadow:"never",class:"head-card"},{default:y(()=>[e("div",$t,[e("div",null,[e("div",It,[t[4]||(t[4]=e("h2",{class:"page-title"},"报价助手",-1)),p(B,{size:"small",type:"warning",effect:"plain"},{default:y(()=>[...t[3]||(t[3]=[w("功能说明",-1)])]),_:1})]),t[7]||(t[7]=e("div",{class:"guide-box"},[e("div",{class:"guide-title"},"使用提示"),e("div",{class:"guide-text"},[w(" 先上传车辆资料图片（如合格证、身份证、行驶证等），再输入平台报价指令（例如："),e("b",null,"太平洋报价"),w("）。 ")]),e("div",{class:"guide-sub"}," 你也可以继续补充说明（如车型、险种、特殊要求），报价助手会按当前会话材料继续处理。 ")],-1)),e("div",zt,[e("span",null,[t[5]||(t[5]=w("当前会话：",-1)),e("b",null,S(m(A)),1)]),m(x)?(_(),v("span",Dt,[t[6]||(t[6]=w("Session: ",-1)),e("code",null,S(m(x)),1)])):R("",!0)])]),e("div",Nt,[p(z,{size:"small",onClick:m(J)},{default:y(()=>[...t[8]||(t[8]=[w("新会话",-1)])]),_:1},8,["onClick"]),p(z,{size:"small",onClick:m(L),loading:m(g)},{default:y(()=>[...t[9]||(t[9]=[w("刷新会话",-1)])]),_:1},8,["onClick","loading"])])]),m(T)?(_(),v("div",Ht,[p(G,{title:m(T),type:"info",closable:!1,"show-icon":""},null,8,["title"])])):R("",!0)]),_:1}),e("div",Lt,[p(K,{shadow:"never",class:"side-card"},{header:y(()=>[e("div",Mt,[t[10]||(t[10]=e("span",null,"会话列表",-1)),p(B,{size:"small",effect:"plain"},{default:y(()=>[w(S(m(k).length),1)]),_:1})])]),default:y(()=>[e("div",Ot,[m(n)||m(g)?(_(),v("div",Bt,[p(Y,{rows:4,animated:""})])):m(k).length?(_(),v("div",Rt,[(_(!0),v(tt,null,et(m(k),i=>(_(),v("div",{key:i.session_id,class:nt(["session-item",{active:i.session_id===m(x)}]),onClick:P=>d(i.session_id)},[e("div",jt,S(i.title||"新会话"),1),e("div",qt,S(i.last_message_preview||"暂无回复预览"),1),e("div",Ut,[e("span",null,S(q(i.updated_at||i.created_at)),1),e("span",null,"消息 "+S(i.message_count??0),1)]),e("div",{class:"s-actions",onClick:t[0]||(t[0]=at(()=>{},["stop"]))},[p(z,{size:"small",type:"danger",link:"",onClick:P=>r(i.session_id)},{default:y(()=>[...t[11]||(t[11]=[w(" 删除 ",-1)])]),_:1},8,["onClick"])])],10,Vt))),128))])):(_(),v("div",Et,[p(st,{description:"暂无历史会话"})]))])]),_:1}),p(K,{shadow:"never",class:"chat-card"},{header:y(()=>[e("div",Wt,[t[13]||(t[13]=e("span",null,"聊天区",-1)),e("div",null,[p(z,{size:"small",text:"",onClick:I,loading:m(u)},{default:y(()=>[...t[12]||(t[12]=[w("刷新消息",-1)])]),_:1},8,["loading"])])])]),default:y(()=>[e("div",{class:"chat-body",ref_key:"chatBodyRef",ref:o},[m(n)||m(u)?(_(),v("div",Jt,[p(Y,{rows:6,animated:""})])):m(h).length?(_(),v("div",Pt,[(_(!0),v(tt,null,et(m(h),i=>(_(),v("div",{key:i.id,class:nt(["msg-item",[`msg-${i.role||"system"}`]])},[e("div",Ft,S(b(i.role)),1),e("div",Xt,[e("div",Gt,[e("span",Yt,S(D(i.role)),1),e("span",Qt,S(q(i.created_at)),1),i.metadata?.status?(_(),Q(B,{key:0,size:"small",type:M(i.metadata?.status),effect:"plain"},{default:y(()=>[w(S(i.metadata.status),1)]),_:2},1032,["type"])):R("",!0),i.metadata?.intent?(_(),Q(B,{key:1,size:"small",type:"info",effect:"plain"},{default:y(()=>[w(S(i.metadata.intent),1)]),_:2},1024)):R("",!0),i.metadata?.trace_id?(_(),Q(B,{key:2,size:"small",type:"warning",effect:"plain"},{default:y(()=>[w(" trace: "+S(String(i.metadata.trace_id).slice(0,8)),1)]),_:2},1024)):R("",!0)]),e("div",Zt,[e("div",te,S(i.content),1),Array.isArray(i.metadata?.actions)&&i.metadata.actions.length?(_(),v("div",ee,[t[14]||(t[14]=e("div",{class:"action-title"},"建议动作",-1)),e("div",se,[(_(!0),v(tt,null,et(i.metadata.actions,(P,lt)=>(_(),Q(z,{key:`${i.id}_${lt}`,size:"small",onClick:le=>H(P)},{default:y(()=>[w(S(P.label||P.type),1)]),_:2},1032,["onClick"]))),128))])])):R("",!0),i.metadata?.error?(_(),v("div",ne,[p(G,{title:i.metadata.error.message||"处理失败",type:"error",closable:!1,"show-icon":""},null,8,["title"])])):R("",!0)])])],2))),128))])):(_(),v("div",Kt,[p(st,{description:"还没有消息，先发一句试试（例如：查订单 / 太平洋报价）"})]))],512),e("div",ae,[p(rt,{modelValue:l.value,"onUpdate:modelValue":t[1]||(t[1]=i=>l.value=i),type:"textarea",rows:3,resize:"none",placeholder:"输入示例：查订单 / 订单备注是什么意思 / 太平洋报价",onKeydown:mt(at(N,["exact","prevent"]),["enter"])},null,8,["modelValue","onKeydown"]),e("div",ie,[t[17]||(t[17]=e("div",{class:"input-tip"},[e("span",null,"Shift + Enter 换行；Enter 发送")],-1)),e("div",oe,[p(z,{onClick:t[2]||(t[2]=i=>l.value=""),disabled:m(a)},{default:y(()=>[...t[15]||(t[15]=[w("清空",-1)])]),_:1},8,["disabled"]),p(z,{type:"primary",loading:m(a),onClick:N},{default:y(()=>[...t[16]||(t[16]=[w("发送",-1)])]),_:1},8,["loading"])])])])]),_:1})])])}}},we=gt(re,[["__scopeId","data-v-d13879b7"]]);export{we as default};
